---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import WhatsAppFloat from '../components/WhatsAppFloat.astro';
import SEO from '../components/SEO.astro';
import FontAwesome from '../components/FontAwesome.astro';
import FormularioEntrada from '../components/Cotizador/FormularioEntrada.astro';
import SelectorEquipos from '../components/Cotizador/SelectorEquipos.astro';
import { EQUIPOS } from '../lib/cotizador/equipos';

// Convertir equipos a JSON para el cliente
const equiposJSON = JSON.stringify(EQUIPOS);
---

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    <title>Cotizador Solar Profesional | Reiki Energ√≠a Solar</title>
    <FontAwesome />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <SEO 
      title="Cotizador Solar Profesional | Sistema de Cotizaci√≥n Online"
      description="Cotizador profesional para sistemas solares. Genera cotizaciones detalladas con precios, descuentos e IVA. On-Grid y Off-Grid."
      canonical="/COTSOLRK"
      keywords="cotizador solar, cotizaci√≥n energ√≠a solar, cotizador paneles solares, sistema cotizaci√≥n solar"
    />
  </head>
  <body>
    <Header />
    
    <main>
      <section class="cotizador-hero" id="heroSection">
        <div class="container">
          <h1 class="hero-title">Cotizador Solar Profesional</h1>
          <p class="hero-subtitle">Genera cotizaciones detalladas para sistemas solares On-Grid y Off-Grid</p>
        </div>
      </section>

      <!-- Interfaz de Login -->
      <section class="login-section" id="loginSection">
        <div class="login-container">
          <div class="login-card">
            <div class="login-header">
              <i class="fas fa-lock"></i>
              <h2>Acceso al Cotizador</h2>
              <p>Ingrese sus credenciales para continuar</p>
            </div>
            <form id="loginForm" class="login-form">
              <div class="form-group">
                <label for="usuario">
                  <i class="fas fa-user"></i> Usuario
                </label>
                <input 
                  type="text" 
                  id="usuario" 
                  name="usuario" 
                  class="form-input"
                  placeholder="Ingrese su usuario"
                  required
                  autocomplete="username"
                >
              </div>
              <div class="form-group">
                <label for="password">
                  <i class="fas fa-key"></i> Contrase√±a
                </label>
                <input 
                  type="password" 
                  id="password" 
                  name="password" 
                  class="form-input"
                  placeholder="Ingrese su contrase√±a"
                  required
                  autocomplete="current-password"
                >
              </div>
              <div id="loginError" class="login-error" style="display: none;">
                <i class="fas fa-exclamation-circle"></i>
                <span>Usuario o contrase√±a incorrectos</span>
              </div>
              <button type="submit" class="btn-login">
                <i class="fas fa-sign-in-alt"></i>
                Iniciar Sesi√≥n
              </button>
            </form>
          </div>
        </div>
      </section>

      <!-- Contenido del Cotizador (oculto hasta login) -->
      <section class="cotizador-section" id="cotizadorSection" style="display: none;">
        <div class="container-full">
          <!-- Informaci√≥n del Usuario -->
          <div class="user-info-bar">
            <div class="user-info">
              <i class="fas fa-user-circle"></i>
              <span id="nombreUsuario">Usuario</span>
            </div>
            <button id="btnCerrarSesion" class="btn-cerrar-sesion">
              <i class="fas fa-sign-out-alt"></i>
              Cerrar Sesi√≥n
            </button>
          </div>

          <!-- Formulario de Entrada -->
          <div class="formulario-panel">
            <FormularioEntrada />
            <SelectorEquipos />
          </div>

          <!-- Panel de Resultados -->
          <div class="resultados-container" id="resultadosPanel" style="display: none;">
            <div id="resultadosContenido">
              <!-- Los resultados se mostrar√°n aqu√≠ -->
            </div>
          </div>
          
          <!-- Panel de Hist√≥rico -->
          <div class="historico-panel">
            <div class="historico-header">
              <h2>Hist√≥rico de Cotizaciones</h2>
              <button id="btnToggleHistorico" class="btn-toggle-historico">
                <i class="fas fa-history"></i>
                Ver Hist√≥rico
              </button>
            </div>
            <div id="historicoContenido" class="historico-contenido" style="display: none;">
              <div id="listaHistorico"></div>
            </div>
          </div>
        </div>
      </section>
    </main>
    
    <Footer />
    <WhatsAppFloat />
  </body>
</html>

<script define:vars={{ equiposJSON }}>
  // ============================================
  // FUNCIONES DE SEGURIDAD
  // ============================================
  
  /**
   * Sanitiza texto para prevenir XSS
   */
  function escapeHTML(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = String(text);
    return div.innerHTML;
  }
  
  /**
   * Sanitiza HTML permitiendo solo tags seguros (para iconos, etc.)
   */
  function sanitizeHTML(html) {
    if (!html) return '';
    const temp = document.createElement('div');
    temp.innerHTML = String(html);
    
    // Remover scripts y eventos
    const scripts = temp.querySelectorAll('script');
    scripts.forEach(s => s.remove());
    
    const allElements = temp.querySelectorAll('*');
    allElements.forEach(el => {
      // Remover atributos de eventos
      Array.from(el.attributes).forEach(attr => {
        if (attr.name.startsWith('on')) {
          el.removeAttribute(attr.name);
        }
        // Remover javascript: en href/src
        if (attr.name === 'href' || attr.name === 'src') {
          if (attr.value && attr.value.toLowerCase().startsWith('javascript:')) {
            el.removeAttribute(attr.name);
          }
        }
      });
    });
    
    return temp.innerHTML;
  }
  
  /**
   * Valida que un string no contenga scripts
   */
  function containsScript(input) {
    if (!input) return false;
    const scriptPatterns = [
      /<script/gi,
      /javascript:/gi,
      /on\w+\s*=/gi,
      /eval\(/gi,
      /expression\(/gi,
    ];
    return scriptPatterns.some(pattern => pattern.test(input));
  }
  
  /**
   * Sanitiza string para prevenir inyecci√≥n
   */
  function sanitizeString(input, maxLength = 500) {
    if (!input) return '';
    let sanitized = String(input)
      .trim()
      .replace(/[<>]/g, '')
      .replace(/javascript:/gi, '')
      .replace(/on\w+=/gi, '')
      .substring(0, maxLength);
    return sanitized;
  }
  
  /**
   * Valida email
   */
  function validateEmail(email) {
    if (!email) return false;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email.trim());
  }
  
  /**
   * Valida tel√©fono
   */
  function validatePhone(phone) {
    if (!phone) return false;
    const phoneRegex = /^[0-9]{7,15}$/;
    return phoneRegex.test(phone.replace(/\s+/g, ''));
  }
  
  /**
   * Valida n√∫mero positivo
   */
  function validatePositiveNumber(value) {
    const num = typeof value === 'string' ? parseFloat(value) : value;
    return !isNaN(num) && num > 0 && isFinite(num);
  }
  
  /**
   * Rate limiting simple en cliente
   */
  const loginAttempts = {
    count: 0,
    lastAttempt: 0,
    maxAttempts: 5,
    lockoutTime: 15 * 60 * 1000, // 15 minutos
  };
  
  function checkRateLimit() {
    const now = Date.now();
    if (now - loginAttempts.lastAttempt > loginAttempts.lockoutTime) {
      loginAttempts.count = 0;
      return true;
    }
    return loginAttempts.count < loginAttempts.maxAttempts;
  }
  
  function recordLoginAttempt(success) {
    if (success) {
      loginAttempts.count = 0;
    } else {
      loginAttempts.count += 1;
      loginAttempts.lastAttempt = Date.now();
    }
  }

  // ============================================
  // SISTEMA DE AUTENTICACI√ìN SEGURO
  // ============================================
  
  // Verificar si ya hay sesi√≥n activa
  function verificarSesion() {
    const sesionToken = sessionStorage.getItem('cotizador_token');
    const nombreUsuario = sessionStorage.getItem('cotizador_usuario');
    const expiresAt = sessionStorage.getItem('cotizador_expires');
    
    // Verificar si la sesi√≥n expir√≥
    if (expiresAt && Date.now() > parseInt(expiresAt)) {
      cerrarSesion();
      return;
    }
    
    if (sesionToken && nombreUsuario) {
      mostrarCotizador(nombreUsuario);
    } else {
      mostrarLogin();
    }
  }

  // Mostrar interfaz de login
  function mostrarLogin() {
    const loginSection = document.getElementById('loginSection');
    const cotizadorSection = document.getElementById('cotizadorSection');
    const heroSection = document.getElementById('heroSection');
    
    if (loginSection) loginSection.style.display = 'block';
    if (cotizadorSection) cotizadorSection.style.display = 'none';
    if (heroSection) heroSection.style.display = 'none';
  }

  // Mostrar cotizador despu√©s de login exitoso
  function mostrarCotizador(nombreUsuario) {
    const loginSection = document.getElementById('loginSection');
    const cotizadorSection = document.getElementById('cotizadorSection');
    const heroSection = document.getElementById('heroSection');
    const nombreUsuarioSpan = document.getElementById('nombreUsuario');
    
    if (loginSection) loginSection.style.display = 'none';
    if (cotizadorSection) cotizadorSection.style.display = 'block';
    if (heroSection) heroSection.style.display = 'block';
    if (nombreUsuarioSpan) nombreUsuarioSpan.textContent = nombreUsuario;
  }

  // Manejar login con endpoint seguro
  async function manejarLogin(event) {
    event.preventDefault();
    
    const usuarioInput = document.getElementById('usuario');
    const passwordInput = document.getElementById('password');
    const errorDiv = document.getElementById('loginError');
    const submitBtn = event.target.querySelector('button[type="submit"]');
    
    // Verificar rate limiting
    if (!checkRateLimit()) {
      if (errorDiv) {
        errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Demasiados intentos fallidos. Intente nuevamente en 15 minutos.</span>';
        errorDiv.style.display = 'flex';
      }
      return;
    }
    
    const usuario = sanitizeString(usuarioInput.value.trim(), 100);
    const password = passwordInput.value;
    
    // Validar inputs
    if (!usuario || usuario.length < 2) {
      if (errorDiv) {
        errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Usuario inv√°lido</span>';
        errorDiv.style.display = 'flex';
      }
      return;
    }
    
    if (!password || password.length < 3) {
      if (errorDiv) {
        errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Contrase√±a inv√°lida</span>';
        errorDiv.style.display = 'flex';
      }
      return;
    }
    
    // Deshabilitar bot√≥n durante la petici√≥n
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';
    }
    
    try {
      // Llamar al endpoint de autenticaci√≥n
      const response = await fetch('/api/auth', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          username: usuario,
          password: password,
        }),
      });
      
      const data = await response.json();
      
      if (data.success && data.token) {
        // Guardar sesi√≥n segura
        sessionStorage.setItem('cotizador_token', data.token);
        sessionStorage.setItem('cotizador_usuario', escapeHTML(data.username));
        sessionStorage.setItem('cotizador_expires', String(data.expiresAt));
        
        recordLoginAttempt(true);
        
        // Ocultar error si existe
        if (errorDiv) errorDiv.style.display = 'none';
        
        // Mostrar cotizador
        mostrarCotizador(data.username);
        
        // Limpiar formulario
        usuarioInput.value = '';
        passwordInput.value = '';
      } else {
        recordLoginAttempt(false);
        
        // Mostrar error
        if (errorDiv) {
          errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>' + escapeHTML(data.error || 'Usuario o contrase√±a incorrectos') + '</span>';
          errorDiv.style.display = 'flex';
          errorDiv.style.animation = 'shake 0.5s';
        }
        
        // Limpiar contrase√±a
        passwordInput.value = '';
        passwordInput.focus();
      }
    } catch (error) {
      console.error('Error en autenticaci√≥n:', error);
      recordLoginAttempt(false);
      
      if (errorDiv) {
        errorDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Error de conexi√≥n. Intente nuevamente.</span>';
        errorDiv.style.display = 'flex';
      }
    } finally {
      // Rehabilitar bot√≥n
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n';
      }
    }
  }

  // Cerrar sesi√≥n
  function cerrarSesion() {
    sessionStorage.removeItem('cotizador_token');
    sessionStorage.removeItem('cotizador_usuario');
    sessionStorage.removeItem('cotizador_expires');
    mostrarLogin();
  }

  // Inicializar cuando el DOM est√© listo
  document.addEventListener('DOMContentLoaded', function() {
    // Verificar sesi√≥n
    verificarSesion();
    
    // Event listener para formulario de login
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
      loginForm.addEventListener('submit', manejarLogin);
    }
    
    // Event listener para cerrar sesi√≥n
    const btnCerrarSesion = document.getElementById('btnCerrarSesion');
    if (btnCerrarSesion) {
      btnCerrarSesion.addEventListener('click', cerrarSesion);
    }
  });

  // Importar funciones de c√°lculo (simuladas en el cliente)
  // En producci√≥n, estas deber√≠an venir de un m√≥dulo compilado
  
  const equipos = JSON.parse(equiposJSON);
  
  const FACTOR_EFICIENCIA = 0.8;
  
  // Base de datos de HSP por departamento y ciudad
  const HSP_POR_CIUDAD = {
    'Antioquia': {
      'Medell√≠n': 4.5, 'Bello': 4.5, 'Itag√º√≠': 4.5, 'Envigado': 4.5, 'Sabaneta': 4.5, 'La Ceja': 4.5, 'Rionegro': 4.5,
      'Marinilla': 4.5, 'El Retiro': 4.5, 'Guarne': 4.5, 'Copacabana': 4.5, 'Girardota': 4.5, 'Barbosa': 4.5,
      'Cisneros': 4.5, 'Yond√≥': 5.0, 'Puerto Berr√≠o': 4.8, 'Turbo': 5.1, 'Apartad√≥': 5.1, 'Carepa': 5.1, 'Chigorod√≥': 5.0,
    },
    'Cundinamarca': {
      'Bogot√°': 4.2, 'Soacha': 4.2, 'Ch√≠a': 4.2, 'Zipaquir√°': 4.2, 'Facatativ√°': 4.2, 'Girardot': 4.8, 'Fusagasug√°': 4.3,
      'Sibat√©': 4.2, 'Mosquera': 4.2, 'Madrid': 4.2, 'Funza': 4.2, 'Cajic√°': 4.2, 'Tabio': 4.2, 'Tenjo': 4.2,
    },
    'Valle del Cauca': {
      'Cali': 4.8, 'Palmira': 4.8, 'Buenaventura': 4.5, 'Tulu√°': 4.7, 'Cartago': 4.6, 'Buga': 4.7, 'Yumbo': 4.8,
      'Ginebra': 4.7, 'Guacar√≠': 4.7, 'El Cerrito': 4.7, 'Restrepo': 4.7, 'La Cumbre': 4.6,
    },
    'Atl√°ntico': {
      'Barranquilla': 5.2, 'Soledad': 5.2, 'Malambo': 5.2, 'Sabanagrande': 5.2, 'Puerto Colombia': 5.2, 'Galapa': 5.2,
      'Tubar√°': 5.2, 'Usiacur√≠': 5.2,
    },
    'Bol√≠var': {
      'Cartagena': 5.0, 'Magangu√©': 5.1, 'Turbaco': 5.0, 'Arjona': 5.0, 'Mahates': 5.0, 'San Pablo': 5.0, 'Santa Rosa': 5.0,
      'Mar√≠a la Baja': 5.0,
    },
    'Santander': {
      'Bucaramanga': 4.6, 'Floridablanca': 4.6, 'Gir√≥n': 4.6, 'Piedecuesta': 4.6, 'Barrancabermeja': 4.8, 'San Gil': 4.5,
      'Socorro': 4.5, 'Barbosa': 4.5,
    },
    'Risaralda': {
      'Pereira': 4.4, 'Dosquebradas': 4.4, 'Santa Rosa de Cabal': 4.4, 'La Virginia': 4.5, 'Cartago': 4.6, 'Marsella': 4.4,
    },
    'Caldas': {
      'Manizales': 4.3, 'La Dorada': 4.7, 'Chinchin√°': 4.3, 'Palestina': 4.3, 'Villamar√≠a': 4.3, 'Anserma': 4.4,
    },
    'Quind√≠o': {
      'Armenia': 4.4, 'Calarc√°': 4.4, 'La Tebaida': 4.4, 'Montenegro': 4.4, 'Quimbaya': 4.4, 'Circasia': 4.4,
    },
    'Tolima': {
      'Ibagu√©': 4.5, 'Espinal': 4.6, 'Girardot': 4.8, 'Melgar': 4.7, 'Flandes': 4.7, 'Guamo': 4.6,
    },
    'Magdalena': {
      'Santa Marta': 5.1, 'Ci√©naga': 5.1, 'Fundaci√≥n': 5.1, 'Aracataca': 5.1, 'El Banco': 5.0, 'Plato': 5.0,
    },
    'Cesar': {
      'Valledupar': 5.3, 'Aguachica': 5.2, 'Codazzi': 5.2, 'La Paz': 5.2, 'San Diego': 5.2, 'Curuman√≠': 5.2,
    },
    'C√≥rdoba': {
      'Monter√≠a': 5.0, 'Ceret√©': 5.0, 'Sahag√∫n': 5.0, 'Lorica': 5.0, 'Montel√≠bano': 5.0, 'Planeta Rica': 5.0,
    },
    'Sucre': {
      'Sincelejo': 5.1, 'Corozal': 5.1, 'Sampu√©s': 5.1, 'San Onofre': 5.1, 'Cove√±as': 5.1, 'Tol√∫': 5.1,
    },
    'Norte de Santander': {
      'C√∫cuta': 4.8, 'Villa del Rosario': 4.8, 'Los Patios': 4.8, 'El Zulia': 4.8, 'San Cayetano': 4.8,
    },
    'Huila': {
      'Neiva': 4.7, 'Pitalito': 4.6, 'Garz√≥n': 4.6, 'La Plata': 4.6, 'Campoalegre': 4.6,
    },
    'Cauca': {
      'Popay√°n': 4.5, 'Santander de Quilichao': 4.6, 'Puerto Tejada': 4.7, 'Pat√≠a': 4.7, 'Miranda': 4.6,
    },
    'Nari√±o': {
      'Pasto': 4.4, 'Tumaco': 4.6, 'Ipiales': 4.3, 'T√∫querres': 4.3, 'La Uni√≥n': 4.4,
    },
    'Meta': {
      'Villavicencio': 4.6, 'Acac√≠as': 4.6, 'Granada': 4.6, 'San Mart√≠n': 4.6, 'Restrepo': 4.6,
    },
    'Casanare': {
      'Yopal': 4.7, 'Aguazul': 4.7, 'Tauramena': 4.7, 'Villanueva': 4.7,
    },
    'Arauca': {
      'Arauca': 5.0, 'Saravena': 4.9, 'Fortul': 4.9,
    },
    'Putumayo': {
      'Mocoa': 4.5, 'Puerto As√≠s': 4.6, 'Orito': 4.6,
    },
    'Amazonas': {
      'Leticia': 4.4, 'Puerto Nari√±o': 4.4,
    },
    'Guain√≠a': {
      'In√≠rida': 4.5,
    },
    'Guaviare': {
      'San Jos√© del Guaviare': 4.6,
    },
    'Vaup√©s': {
      'Mit√∫': 4.4,
    },
    'Vichada': {
      'Puerto Carre√±o': 5.0,
    },
    'La Guajira': {
      'Riohacha': 5.4, 'Maicao': 5.4, 'Uribia': 5.4, 'Manaure': 5.4, 'San Juan del Cesar': 5.3,
    },
    'Boyac√°': {
      'Tunja': 4.3, 'Duitama': 4.3, 'Sogamoso': 4.3, 'Chiquinquir√°': 4.3, 'Villa de Leyva': 4.3,
    },
    'Choc√≥': {
      'Quibd√≥': 4.2, 'Istmina': 4.3, 'Condoto': 4.3,
    },
  };
  
  function obtenerHSPPorCiudad(ciudad, departamento) {
    if (departamento && HSP_POR_CIUDAD[departamento] && HSP_POR_CIUDAD[departamento][ciudad]) {
      return HSP_POR_CIUDAD[departamento][ciudad];
    }
    
    // Buscar en todos los departamentos si no se especifica
    for (const dept of Object.keys(HSP_POR_CIUDAD)) {
      if (HSP_POR_CIUDAD[dept][ciudad]) {
        return HSP_POR_CIUDAD[dept][ciudad];
      }
    }
    
    return 4.5;
  }
  
  function calcularConsumoAnual(consumosMensuales) {
    if (consumosMensuales.length === 12) {
      return consumosMensuales.reduce((sum, consumo) => sum + consumo, 0);
    } else if (consumosMensuales.length === 1) {
      return consumosMensuales[0] * 12;
    }
    const promedio = consumosMensuales.reduce((sum, c) => sum + c, 0) / consumosMensuales.length;
    return promedio * 12;
  }
  
  function calcularPotenciaNecesariaOnGrid(consumoAnual, hsp, eficienciaOptimo = 0.97) {
    // F√≥rmula seg√∫n Excel: Potencia = ConsumoDiario / (HSP * 0.97 * 0.82 * 0.97)
    const consumoDiario = consumoAnual / 365;
    const perdidasAdicionales = eficienciaOptimo; // 0.97 (desde entrada)
    const factorPerdidas = 0.82; // Fijo seg√∫n Excel
    const eficienciaInversor = 0.97; // Fijo seg√∫n Excel
    
    return consumoDiario / (hsp * perdidasAdicionales * factorPerdidas * eficienciaInversor);
  }
  
  function calcularCantidadPaneles(potenciaNecesaria, potenciaPanel) {
    return Math.ceil(potenciaNecesaria / potenciaPanel);
  }
  
  function calcularGeneracionAnual(potenciaInstalada, hsp, eficienciaOptimo = 0.97) {
    // F√≥rmula seg√∫n Excel: Generaci√≥n = Potencia * HSP * 365 * factores de eficiencia
    const perdidasAdicionales = eficienciaOptimo; // 0.97
    const factorPerdidas = 0.82; // Fijo
    const eficienciaInversor = 0.97; // Fijo
    
    return potenciaInstalada * hsp * 365 * perdidasAdicionales * factorPerdidas * eficienciaInversor;
  }
  
  // Tabla de referencia para c√°lculo RETIE (seg√∫n Excel A103:E118)
  // Estructura: [Potencia Min (kWp), Potencia Max (kWp), Valor RETIE (COP)]
  const TABLA_RETIE = [
    { min: 0, max: 0.33, valor: 892978 },
    { min: 0.33, max: 4.6, valor: 996754 },
    { min: 4.6, max: 6.1, valor: 1111446 },
    { min: 6.1, max: 8.6, valor: 1316946 },
    { min: 8.6, max: 11.6, valor: 1532613 },
    { min: 11.6, max: 14.1, valor: 1610710 },
    { min: 14.1, max: 17.6, valor: 1795394 },
    { min: 17.6, max: 20.1, valor: 2074668 },
    { min: 20.1, max: 25.6, valor: 2420399 },
    { min: 25.6, max: 35.1, valor: 2766130 },
    { min: 35.1, max: 50.1, valor: 3111860 },
    { min: 50.1, max: 70.1, valor: 3457591 },
    { min: 70.1, max: 100.1, valor: 3803322 },
    { min: 100.1, max: 151.1, valor: 4359322 },
    { min: 151.1, max: 300.1, valor: 4915322 },
    { min: 300.1, max: Infinity, valor: 4915322 } // Para potencias mayores a 300 kWp
  ];

  // Funci√≥n para calcular RETIE seg√∫n la f√≥rmula del Excel
  // F√≥rmula: VLOOKUP(D24,A103:E118, 5, TRUE)*IF('Datos de Entrada (On Grid)'!G13="Ida y regreso",1,1.15)
  function calcularRETIE(potenciaInstaladaKW, esIdaYRegreso = false) {
    // Redondear potencia instalada (D24 en Excel)
    const potenciaRedondeada = Math.round(potenciaInstaladaKW * 10) / 10;
    
    // Buscar en la tabla (VLOOKUP con b√∫squeda aproximada)
    let valorRETIE = TABLA_RETIE[0].valor; // Valor por defecto
    
    for (let i = TABLA_RETIE.length - 1; i >= 0; i--) {
      if (potenciaRedondeada >= TABLA_RETIE[i].min) {
        valorRETIE = TABLA_RETIE[i].valor;
        break;
      }
    }
    
    // Aplicar factor seg√∫n si es ida y regreso
    // Si es "Ida y regreso" multiplica por 1, si no por 1.15
    const factor = esIdaYRegreso ? 1 : 1.15;
    
    return valorRETIE * factor;
  }

  function calcularAhorroAnualOnGrid(generacionAnual, porcentajeAutoconsumo, tarifaElectrica, tarifaVentaExcedentes) {
    const energiaAutoconsumo = generacionAnual * (porcentajeAutoconsumo / 100);
    const energiaExcedente = generacionAnual - energiaAutoconsumo;
    const tarifaVenta = tarifaVentaExcedentes || tarifaElectrica * 0.9;
    const ahorroAnual = (energiaAutoconsumo * tarifaElectrica) + (energiaExcedente * tarifaVenta);
    return { energiaAutoconsumo, energiaExcedente, ahorroAnual };
  }
  
  // Tipos de cubierta y funciones de estructura
  const TIPOS_CUBIERTA = {
    'teja-barro': {
      id: 'teja-barro',
      nombre: 'Teja de Barro',
      descripcion: 'Estructura para techo con teja de barro',
      precioPorPanel: 220000,
      precioProyectoPequeno: 237600,
    },
    'teja-ondulada': {
      id: 'teja-ondulada',
      nombre: 'Teja Ondulada o Fibrocemento',
      descripcion: 'Estructura para techo con teja ondulada o fibrocemento',
      precioPorPanel: 180000,
      precioProyectoPequeno: 194400,
    },
    'teja-zinc': {
      id: 'teja-zinc',
      nombre: 'Teja de Zinc',
      descripcion: 'Estructura para techo con teja de zinc',
      precioPorPanel: 200000,
      precioProyectoPequeno: 216000,
    },
    'teja-trapezoidal': {
      id: 'teja-trapezoidal',
      nombre: 'Teja Trapezoidal',
      descripcion: 'Estructura para techo con teja trapezoidal',
      precioPorPanel: 200000,
      precioProyectoPequeno: 216000,
    },
    'loza': {
      id: 'loza',
      nombre: 'Loza',
      descripcion: 'Estructura para loza de concreto',
      precioPorPanel: 210000,
      precioProyectoPequeno: 226800,
    },
    'estructura-elevada': {
      id: 'estructura-elevada',
      nombre: 'Estructura Elevada (Columnetas)',
      descripcion: 'Estructura elevada con columnetas para terreno',
      precioPorPanel: 240000,
      precioProyectoPequeno: 259200,
    },
    'alurack-l': {
      id: 'alurack-l',
      nombre: 'Alurack con "L"',
      descripcion: 'Estructura Alurack tipo L para techo',
      precioPorPanel: 220000,
      precioProyectoPequeno: 237600,
    },
    'terreno': {
      id: 'terreno',
      nombre: 'Terreno',
      descripcion: 'Estructura para instalaci√≥n en terreno',
      precioPorPanel: 240000,
      precioProyectoPequeno: 259200,
    },
  };
  
  function obtenerPrecioEstructura(tipoCubierta, cantidadPaneles) {
    const cubierta = TIPOS_CUBIERTA[tipoCubierta];
    
    if (!cubierta) {
      // Precio por defecto si no se especifica
      return 220000 * cantidadPaneles;
    }
    
    // Para proyectos peque√±os (menos de 10 paneles), usar precio especial si existe
    if (cantidadPaneles < 10 && cubierta.precioProyectoPequeno) {
      return cubierta.precioProyectoPequeno * cantidadPaneles;
    }
    
    return cubierta.precioPorPanel * cantidadPaneles;
  }
  
  function obtenerInfoCubierta(tipoCubierta) {
    return TIPOS_CUBIERTA[tipoCubierta] || null;
  }
  
  // Funciones simplificadas de an√°lisis financiero (versi√≥n cliente)
  function calcularFlujoCaja(inversionInicial, ahorroAnualInicial) {
    const flujoCaja = [];
    const tasaInflacionTarifa = 0.04; // 4%
    const degradacionPaneles = 0.005; // 0.5%
    const opexAnual = inversionInicial * 0.005; // 0.5%
    const tasaImpuesto = 0.35; // 35%
    const deduccionPorcentaje = 0.50; // 50%
    const anosDepreciacion = 5;
    
    // Beneficio tributario por deducci√≥n del 50%
    const beneficioDeduccion = inversionInicial * deduccionPorcentaje * tasaImpuesto;
    const depreciacionAnual = inversionInicial / anosDepreciacion;
    const ahorroFiscalDepreciacion = depreciacionAnual * tasaImpuesto;
    
    // A√±o 0
    flujoCaja.push({
      a√±o: 0,
      inversionInicial: -inversionInicial,
      ahorroAnual: 0,
      opex: 0,
      flujoNeto: -inversionInicial,
      flujoAcumulado: -inversionInicial,
    });
    
    let flujoAcumulado = -inversionInicial;
    
    // A√±os 1-25
    for (let a√±o = 1; a√±o <= 25; a√±o++) {
      const factorDegradacion = Math.pow(1 - degradacionPaneles, a√±o - 1);
      const ahorroAnual = ahorroAnualInicial * factorDegradacion;
      const factorInflacion = Math.pow(1 + tasaInflacionTarifa, a√±o - 1);
      const ahorroAnualAjustado = ahorroAnual * factorInflacion;
      
      let flujoNeto = ahorroAnualAjustado - opexAnual;
      
      if (a√±o === 1) {
        flujoNeto += beneficioDeduccion;
      }
      
      if (a√±o >= 2 && a√±o <= anosDepreciacion) {
        flujoNeto += ahorroFiscalDepreciacion;
      }
      
      flujoAcumulado += flujoNeto;
      
      flujoCaja.push({
        a√±o,
        ahorroAnual: ahorroAnualAjustado,
        opex: opexAnual,
        flujoNeto,
        flujoAcumulado,
        degradacion: (1 - factorDegradacion) * 100,
      });
    }
    
    return flujoCaja;
  }
  
  function calcularA√±osRecuperacion(flujoCaja) {
    for (let i = 1; i < flujoCaja.length; i++) {
      const flujo = flujoCaja[i];
      if (flujo.flujoAcumulado >= 0) {
        if (i === 1) {
          const flujoAno1 = flujo.flujoNeto;
          const inversionInicial = Math.abs(flujoCaja[0].flujoNeto);
          return inversionInicial / flujoAno1;
        } else {
          const flujoAnterior = flujoCaja[i - 1];
          const flujoActual = flujo;
          const inversionRestante = Math.abs(flujoAnterior.flujoAcumulado);
          const flujoAno = flujoActual.flujoNeto;
          return (i - 1) + (inversionRestante / flujoAno);
        }
      }
    }
    return 25; // No se recupera en 25 a√±os
  }
  
  function calcularVAN(flujoCaja, tasaDescuento = 0.10) {
    let van = 0;
    for (const flujo of flujoCaja) {
      van += flujo.flujoNeto / Math.pow(1 + tasaDescuento, flujo.a√±o);
    }
    return van;
  }
  
  function calcularTIR(flujoCaja) {
    // M√©todo de bisecci√≥n para calcular TIR
    let tasaMin = -0.99;
    let tasaMax = 2.0;
    const precision = 0.0001;
    const maxIteraciones = 100;
    
    for (let i = 0; i < maxIteraciones; i++) {
      const tasaMedia = (tasaMin + tasaMax) / 2;
      let van = 0;
      
      for (const flujo of flujoCaja) {
        van += flujo.flujoNeto / Math.pow(1 + tasaMedia, flujo.a√±o);
      }
      
      if (Math.abs(van) < precision) {
        return tasaMedia;
      }
      
      if (van > 0) {
        tasaMin = tasaMedia;
      } else {
        tasaMax = tasaMedia;
      }
    }
    
    return (tasaMin + tasaMax) / 2;
  }
  
  function calcularROI(inversionInicial, flujoCaja) {
    const flujoTotal = flujoCaja
      .filter(f => f.a√±o > 0)
      .reduce((sum, f) => sum + f.flujoNeto, 0);
    return ((flujoTotal - inversionInicial) / inversionInicial) * 100;
  }
  
  function calcularAnalisisFinanciero(inversionInicial, ahorroAnualInicial) {
    const flujoCaja = calcularFlujoCaja(inversionInicial, ahorroAnualInicial);
    const a√±osRecuperacion = calcularA√±osRecuperacion(flujoCaja);
    const van = calcularVAN(flujoCaja, 0.10);
    const tir = calcularTIR(flujoCaja);
    const roi = calcularROI(inversionInicial, flujoCaja);
    
    const ahorroTotal25Anos = flujoCaja
      .filter(f => f.a√±o > 0)
      .reduce((sum, f) => sum + f.ahorroAnual, 0);
    
    return {
      inversionInicial,
      a√±osRecuperacion,
      tir,
      van,
      roi,
      flujoCaja,
      ahorroTotal25Anos,
    };
  }
  
  function calcularImpactoAmbiental(generacionAnual) {
    const factorEmisionCO2 = 0.267; // kg CO2/kWh (promedio Colombia)
    const co2EvitadoAnual = generacionAnual * factorEmisionCO2;
    
    let co2Evitado25Anos = 0;
    const degradacionAnual = 0.005;
    
    for (let a√±o = 1; a√±o <= 25; a√±o++) {
      const factorDegradacion = Math.pow(1 - degradacionAnual, a√±o - 1);
      co2Evitado25Anos += co2EvitadoAnual * factorDegradacion;
    }
    
    // 1 √°rbol absorbe ~21.77 kg CO2/a√±o
    const equivalenteArboles = co2Evitado25Anos / (21.77 * 25);
    
    // 1 auto emite ~4,600 kg CO2/a√±o
    const equivalenteAutos = co2Evitado25Anos / (4600 * 25);
    
    return {
      co2EvitadoAnual,
      co2Evitado25Anos,
      equivalenteArboles,
      equivalenteAutos,
    };
  }
  
  // Funciones simplificadas de PPA (versi√≥n cliente)
  function calcularCRF(wacc, vidaUtil) {
    if (wacc === 0) {
      return 1 / vidaUtil;
    }
    const numerador = wacc * Math.pow(1 + wacc, vidaUtil);
    const denominador = Math.pow(1 + wacc, vidaUtil) - 1;
    return numerador / denominador;
  }
  
  function calcularPrecioPPA(capex, generacionAnual, wacc = 0.12) {
    const opexAnual = capex * 0.015; // 1.5% del CAPEX
    const crf10 = calcularCRF(wacc, 10);
    const crf12 = calcularCRF(wacc, 12);
    const crf15 = calcularCRF(wacc, 15);
    
    return {
      '10': (capex * crf10 + opexAnual) / generacionAnual,
      '12': (capex * crf12 + opexAnual) / generacionAnual,
      '15': (capex * crf15 + opexAnual) / generacionAnual,
    };
  }
  
  function calcularAhorroAnualPPA(generacionAnual, tarifaElectrica, tarifaPPA, porcentajeAutoconsumo) {
    const tarifaVenta = tarifaElectrica * 0.9;
    const ahorroAutoconsumo = generacionAnual * porcentajeAutoconsumo * (tarifaElectrica - tarifaPPA);
    const ahorroExcedentes = generacionAnual * (1 - porcentajeAutoconsumo) * (tarifaVenta - tarifaPPA);
    return ahorroAutoconsumo + ahorroExcedentes;
  }
  
  function calcularFlujoCajaClientePPA(parametros) {
    const flujoCaja = [];
    const ipc = 0.037; // 3.7%
    const degradacionAnual = 0.0055; // 0.55%
    const duracion = parametros.duracionContrato || 15;
    const precioPPA = calcularPrecioPPA(parametros.capex, parametros.generacionAnual);
    const tarifaPPA = precioPPA[duracion.toString()] || precioPPA['12'];
    
    let flujoAcumulado = 0;
    
    for (let a√±o = 1; a√±o <= duracion; a√±o++) {
      const factorDegradacion = Math.pow(1 - degradacionAnual, a√±o - 1);
      const energiaGenerada = parametros.generacionAnual * factorDegradacion;
      const tarifaConvencional = parametros.tarifaElectrica * Math.pow(1 + ipc, a√±o - 1);
      const ahorroPorKWh = tarifaConvencional - tarifaPPA;
      const ahorroAnual = calcularAhorroAnualPPA(
        energiaGenerada,
        tarifaConvencional,
        tarifaPPA,
        parametros.porcentajeAutoconsumo
      );
      
      flujoAcumulado += ahorroAnual;
      
      flujoCaja.push({
        a√±o,
        energiaGenerada,
        tarifaConvencional,
        tarifaPPA,
        ahorroPorKWh,
        ahorroAnual,
        flujoNeto: ahorroAnual,
        flujoAcumulado,
      });
    }
    
    return flujoCaja;
  }
  
  function calcularFlujoCajaInversionistaPPA(parametros) {
    const flujoCaja = [];
    const opexAnual = parametros.capex * 0.015; // 1.5%
    const repotenciacion = parametros.capex * 0.01; // 1% en a√±o 10
    const beneficioRenta = parametros.capex * 0.50 * 0.35; // 50% deducci√≥n, 35% impuesto
    const degradacionAnual = 0.0055;
    const duracion = parametros.duracionContrato || 15;
    const precioPPA = calcularPrecioPPA(parametros.capex, parametros.generacionAnual);
    const tarifaPPA = precioPPA[duracion.toString()] || precioPPA['12'];
    
    // A√±o 0: Inversi√≥n inicial
    flujoCaja.push({
      a√±o: 0,
      inversionInicial: -parametros.capex,
      energiaDesplazada: 0,
      ventaEnergia: 0,
      opex: 0,
      repotenciacion: 0,
      beneficioRenta: beneficioRenta,
      flujoNeto: -parametros.capex + beneficioRenta,
      flujoAcumulado: -parametros.capex + beneficioRenta,
    });
    
    let flujoAcumulado = -parametros.capex + beneficioRenta;
    
    for (let a√±o = 1; a√±o <= duracion; a√±o++) {
      const factorDegradacion = Math.pow(1 - degradacionAnual, a√±o - 1);
      const energiaDesplazada = parametros.generacionAnual * factorDegradacion;
      const ventaEnergia = energiaDesplazada * tarifaPPA;
      const opex = -opexAnual;
      const repot = (a√±o === 10) ? -repotenciacion : 0;
      
      const flujoNeto = ventaEnergia + opex + repot;
      flujoAcumulado += flujoNeto;
      
      flujoCaja.push({
        a√±o,
        inversionInicial: 0,
        energiaDesplazada,
        ventaEnergia,
        opex,
        repotenciacion: repot,
        beneficioRenta: 0,
        flujoNeto,
        flujoAcumulado,
      });
    }
    
    return flujoCaja;
  }
  
  function calcularMetricasInversionistaPPA(flujoCajaInversionista, capex, generacionAnual, preciosPPA) {
    const flujoTotal = flujoCajaInversionista
      .filter(f => f.a√±o > 0)
      .reduce((sum, f) => sum + f.flujoNeto, 0);
    
    const ingresoTotal = flujoCajaInversionista
      .filter(f => f.a√±o > 0)
      .reduce((sum, f) => sum + f.ventaEnergia, 0);
    
    const duracion = flujoCajaInversionista.length - 1;
    const ingresoPromedioAnual = ingresoTotal / duracion;
    const costoTotal = capex + (capex * 0.015 * duracion); // CAPEX + OPEX
    const margenBruto = ((ingresoTotal - costoTotal) / ingresoTotal) * 100;
    const margenNeto = ((flujoTotal) / ingresoTotal) * 100;
    
    const energiaTotal = generacionAnual * duracion * 0.95; // Aproximado con degradaci√≥n
    const lcoe = costoTotal / energiaTotal;
    
    const tir = calcularTIR(flujoCajaInversionista.map(f => ({
      a√±o: f.a√±o,
      flujoNeto: f.flujoNeto,
    })));
    const van = calcularVAN(flujoCajaInversionista.map(f => ({
      a√±o: f.a√±o,
      flujoNeto: f.flujoNeto,
    })), 0.12);
    
    const paybackPeriod = calcularA√±osRecuperacion(flujoCajaInversionista.map(f => ({
      a√±o: f.a√±o,
      flujoNeto: f.flujoNeto,
      flujoAcumulado: f.flujoAcumulado,
    })));
    
    const roi = ((flujoTotal) / capex) * 100;
    
    return {
      tir,
      van,
      roi,
      paybackPeriod,
      ingresoTotal,
      ingresoPromedioAnual,
      margenBruto,
      margenNeto,
      lcoe,
      comparativaEscenarios: {
        '10': {
          duracion: 10,
          precioPPA: preciosPPA['10'],
          tir: tir,
          van: van,
          ingresoTotal: ingresoTotal,
          margenBruto: margenBruto,
        },
        '12': {
          duracion: 12,
          precioPPA: preciosPPA['12'],
          tir: tir,
          van: van,
          ingresoTotal: ingresoTotal,
          margenBruto: margenBruto,
        },
        '15': {
          duracion: 15,
          precioPPA: preciosPPA['15'],
          tir: tir,
          van: van,
          ingresoTotal: ingresoTotal,
          margenBruto: margenBruto,
        },
      },
    };
  }
  
  function calcularSistemaPPA(parametros) {
    const wacc = 0.12; // 12%
    const opexAnual = parametros.capex * 0.015; // 1.5%
    const preciosPPA = calcularPrecioPPA(parametros.capex, parametros.generacionAnual, wacc);
    
    const ahorroAnual = {
      '10': calcularAhorroAnualPPA(
        parametros.generacionAnual,
        parametros.tarifaElectrica,
        preciosPPA['10'],
        parametros.porcentajeAutoconsumo
      ),
      '12': calcularAhorroAnualPPA(
        parametros.generacionAnual,
        parametros.tarifaElectrica,
        preciosPPA['12'],
        parametros.porcentajeAutoconsumo
      ),
      '15': calcularAhorroAnualPPA(
        parametros.generacionAnual,
        parametros.tarifaElectrica,
        preciosPPA['15'],
        parametros.porcentajeAutoconsumo
      ),
    };
    
    const cuotaMensual = {
      '10': (preciosPPA['10'] * parametros.generacionAnual) / 12,
      '12': (preciosPPA['12'] * parametros.generacionAnual) / 12,
      '15': (preciosPPA['15'] * parametros.generacionAnual) / 12,
    };
    
    const flujoCajaCliente = calcularFlujoCajaClientePPA(parametros);
    const flujoCajaInversionista = calcularFlujoCajaInversionistaPPA(parametros);
    const metricasInversionista = calcularMetricasInversionistaPPA(
      flujoCajaInversionista,
      parametros.capex,
      parametros.generacionAnual,
      preciosPPA
    );
    
    return {
      potenciaInstaladaDC: 0,
      potenciaInstaladaAC: 0,
      generacionAnual: parametros.generacionAnual,
      capex: parametros.capex,
      opexAnual,
      precioPPA: preciosPPA,
      ahorroAnual,
      cuotaMensual,
      flujoCajaCliente,
      flujoCajaInversionista,
      metricasInversionista,
    };
  }
  
  function formatCOP(num) {
    return new Intl.NumberFormat('es-CO', {
      style: 'currency',
      currency: 'COP',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(num);
  }
  
  // Funci√≥n para generar gr√°fica de flujo de caja PPA
  function generarGraficaFlujoCajaPPA(flujoCajaPPA) {
    const canvas = document.getElementById('canvasFlujoCajaPPA');
    if (!canvas || typeof Chart === 'undefined') return;
    
    const ctx = canvas.getContext('2d');
    const a√±os = flujoCajaPPA.map(f => f.a√±o);
    const flujoAcumulado = flujoCajaPPA.map(f => f.flujoAcumulado);
    const ahorroAnual = flujoCajaPPA.map(f => f.ahorroAnual);
    
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: a√±os,
        datasets: [
          {
            label: 'Flujo de Caja Acumulado',
            data: flujoAcumulado,
            borderColor: '#6b2181',
            backgroundColor: 'rgba(107, 33, 129, 0.1)',
            fill: true,
            tension: 0.4,
            yAxisID: 'y',
          },
          {
            label: 'Ahorro Anual',
            data: ahorroAnual,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            fill: false,
            tension: 0.4,
            yAxisID: 'y1',
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                if (context.datasetIndex === 0) {
                  return 'Flujo Acumulado: ' + formatCOP(context.parsed.y);
                } else {
                  return 'Ahorro Anual: ' + formatCOP(context.parsed.y);
                }
              }
            }
          }
        },
        scales: {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            beginAtZero: false,
            ticks: {
              callback: function(value) {
                return formatCOP(value);
              }
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            beginAtZero: false,
            grid: {
              drawOnChartArea: false,
            },
            ticks: {
              callback: function(value) {
                return formatCOP(value);
              }
            }
          }
        }
      }
    });
  }
  
  // Funci√≥n para generar gr√°fica de flujo de caja
  function generarGraficaFlujoCaja(flujoCaja) {
    const canvas = document.getElementById('canvasFlujoCaja');
    if (!canvas || typeof Chart === 'undefined') return;
    
    const ctx = canvas.getContext('2d');
    const a√±os = flujoCaja.map(f => f.a√±o);
    const flujoAcumulado = flujoCaja.map(f => f.flujoAcumulado);
    
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: a√±os,
        datasets: [{
          label: 'Flujo de Caja Acumulado',
          data: flujoAcumulado,
          borderColor: '#6b2181',
          backgroundColor: 'rgba(107, 33, 129, 0.1)',
          fill: true,
          tension: 0.4,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top',
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return 'Flujo Acumulado: ' + formatCOP(context.parsed.y);
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: false,
            ticks: {
              callback: function(value) {
                return formatCOP(value);
              }
            }
          }
        }
      }
    });
  }
  
  function enviarCotizacionWhatsApp(items, subtotal, iva, total, calculos) {
    const clienteNombre = document.getElementById('clienteNombre')?.value || 'Cliente';
    const clienteTelefono = document.getElementById('clienteTelefono')?.value || '';
    const clienteEmail = document.getElementById('clienteEmail')?.value || '';
    const clienteCiudad = document.getElementById('clienteCiudad')?.value || '';
    const clienteDepartamento = document.getElementById('clienteDepartamento')?.value || '';
    
    let mensaje = `üìã *COTIZACI√ìN SISTEMA SOLAR*\n\n`;
    mensaje += `*üë§ DATOS DEL CLIENTE:*\n`;
    mensaje += `Nombre: ${clienteNombre}\n`;
    if (clienteTelefono) mensaje += `Tel√©fono: ${clienteTelefono}\n`;
    if (clienteEmail) mensaje += `Email: ${clienteEmail}\n`;
    if (clienteCiudad) mensaje += `Ciudad: ${clienteCiudad}, ${clienteDepartamento}\n`;
    mensaje += `\n*üì¶ ITEMS DE LA COTIZACI√ìN:*\n`;
    
    items.forEach((item, index) => {
      mensaje += `\n${index + 1}. ${item.descripcion}\n`;
      mensaje += `   Cantidad: ${item.cantidad}\n`;
      mensaje += `   Precio Unit: ${formatCOP(item.precioUnitario)}\n`;
      mensaje += `   Subtotal: ${formatCOP(item.subtotal)}\n`;
    });
    
    mensaje += `\n*üí∞ RESUMEN FINANCIERO:*\n`;
    mensaje += `Subtotal: ${formatCOP(subtotal)}\n`;
    mensaje += `IVA (19%): ${formatCOP(iva)}\n`;
    mensaje += `*TOTAL: ${formatCOP(total)}*\n`;
    
    mensaje += `\n*‚ö° ESPECIFICACIONES T√âCNICAS:*\n`;
    mensaje += `Potencia Instalada: ${calculos.potenciaInstalada.toFixed(2)} kWp\n`;
    mensaje += `Cantidad de Paneles: ${calculos.cantidadPaneles}\n`;
    mensaje += `Generaci√≥n Anual: ${calculos.generacionAnual.toFixed(0)} kWh/a√±o\n`;
    mensaje += `Ahorro Anual Estimado: ${formatCOP(calculos.ahorroAnual)}\n`;
    
    mensaje += `\n_Esta cotizaci√≥n fue generada desde el sistema web de Reiki Energ√≠a Solar_`;
    
    const numero = '573245737413';
    const mensajeEncoded = encodeURIComponent(mensaje);
    window.open(`https://wa.me/${numero}?text=${mensajeEncoded}`, '_blank');
  }
  
  function enviarCotizacionWhatsAppOffGrid(items, subtotal, iva, total, calculos) {
    const clienteNombre = document.getElementById('clienteNombre')?.value || 'Cliente';
    const clienteTelefono = document.getElementById('clienteTelefono')?.value || '';
    const clienteEmail = document.getElementById('clienteEmail')?.value || '';
    const clienteCiudad = document.getElementById('clienteCiudad')?.value || '';
    const clienteDepartamento = document.getElementById('clienteDepartamento')?.value || '';
    
    // Obtener lista de equipos
    const equipos = document.querySelectorAll('.equipo-item');
    const listaEquipos = [];
    equipos.forEach(equipo => {
      const index = parseInt(equipo.dataset.index);
      const nombre = document.getElementById(`equipoNombre_${index}`)?.value || '';
      const potencia = parseFloat(document.getElementById(`equipoPotencia_${index}`)?.value || 0);
      const cantidad = parseFloat(document.getElementById(`equipoCantidad_${index}`)?.value || 1);
      const horasUso = parseFloat(document.getElementById(`equipoHorasUso_${index}`)?.value || 0);
      
      if (nombre) {
        listaEquipos.push(`${nombre} - ${potencia}W x ${cantidad} unidades - ${horasUso}h/d√≠a`);
      }
    });
    
    let mensaje = `üìã *COTIZACI√ìN SISTEMA SOLAR OFF-GRID*\n\n`;
    mensaje += `*üë§ DATOS DEL CLIENTE:*\n`;
    mensaje += `Nombre: ${clienteNombre}\n`;
    if (clienteTelefono) mensaje += `Tel√©fono: ${clienteTelefono}\n`;
    if (clienteEmail) mensaje += `Email: ${clienteEmail}\n`;
    if (clienteCiudad) mensaje += `Ciudad: ${clienteCiudad}, ${clienteDepartamento}\n`;
    
    mensaje += `\n*üîå EQUIPOS A ALIMENTAR:*\n`;
    listaEquipos.forEach((eq, index) => {
      mensaje += `${index + 1}. ${eq}\n`;
    });
    mensaje += `\nConsumo Diario Total: ${calculos.consumoDiario.toFixed(2)} kWh/d√≠a\n`;
    
    mensaje += `\n*üì¶ ITEMS DE LA COTIZACI√ìN:*\n`;
    items.forEach((item, index) => {
      mensaje += `\n${index + 1}. ${item.descripcion}\n`;
      mensaje += `   Cantidad: ${item.cantidad}\n`;
      mensaje += `   Precio Unit: ${formatCOP(item.precioUnitario)}\n`;
      mensaje += `   Subtotal: ${formatCOP(item.subtotal)}\n`;
    });
    
    mensaje += `\n*üí∞ RESUMEN FINANCIERO:*\n`;
    mensaje += `Subtotal: ${formatCOP(subtotal)}\n`;
    mensaje += `IVA (19%): ${formatCOP(iva)}\n`;
    mensaje += `*TOTAL: ${formatCOP(total)}*\n`;
    
    mensaje += `\n*‚ö° ESPECIFICACIONES T√âCNICAS:*\n`;
    mensaje += `Potencia Instalada: ${calculos.potenciaInstalada.toFixed(2)} kWp\n`;
    mensaje += `Cantidad de Paneles: ${calculos.cantidadPaneles}\n`;
    mensaje += `Generaci√≥n Diaria: ${calculos.generacionDiaria.toFixed(2)} kWh/d√≠a\n`;
    mensaje += `Generaci√≥n Anual: ${calculos.generacionAnual.toFixed(0)} kWh/a√±o\n`;
    mensaje += `Capacidad de Bater√≠a: ${calculos.capacidadBateria.toFixed(2)} kWh\n`;
    mensaje += `Cantidad de Bater√≠as: ${calculos.cantidadBaterias} unidades\n`;
    mensaje += `D√≠as de Autonom√≠a: ${calculos.diasAutonomia} d√≠as\n`;
    mensaje += `Voltaje del Sistema: ${calculos.voltajeSistema}V\n`;
    
    mensaje += `\n_Esta cotizaci√≥n fue generada desde el sistema web de Reiki Energ√≠a Solar_`;
    
    const numero = '573245737413';
    const mensajeEncoded = encodeURIComponent(mensaje);
    window.open(`https://wa.me/${numero}?text=${mensajeEncoded}`, '_blank');
  }
  
  // Funci√≥n para actualizar lista de hist√≥rico
  function actualizarListaHistorico() {
    const listaHistorico = document.getElementById('listaHistorico');
    if (!listaHistorico) return;
    
    const historico = obtenerHistoricoCotizaciones();
    
    if (historico.length === 0) {
      listaHistorico.innerHTML = '<p class="sin-cotizaciones">No hay cotizaciones guardadas</p>';
      return;
    }
    
    // Generar HTML sanitizado
    const htmlSeguro = historico.map(cot => {
      const fecha = new Date(cot.fecha);
      const fechaFormateada = fecha.toLocaleDateString('es-CO', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
      });
      
      // Sanitizar datos del usuario
      const nombreCliente = escapeHTML(cot.cliente.nombre || 'Sin nombre');
      const cotId = escapeHTML(cot.id);
      const fechaEscapada = escapeHTML(fechaFormateada);
      const tipoSistemaEscapado = escapeHTML(cot.tipoSistema);
      const tipoSistemaLabel = cot.tipoSistema === 'on-grid' ? 'On-Grid' : cot.tipoSistema === 'off-grid' ? 'Off-Grid' : 'H√≠brido';
      const totalEscapado = escapeHTML(formatCOP(cot.cotizacion.total));
      const ahorroEscapado = cot.calculos.ahorroAnual ? escapeHTML(formatCOP(cot.calculos.ahorroAnual)) : '';
      
      return `
        <div class="cotizacion-historico-item">
          <div class="cotizacion-historico-header">
            <div>
              <h4>${nombreCliente}</h4>
              <p class="cotizacion-fecha">${fechaEscapada}</p>
            </div>
            <div class="cotizacion-historico-actions">
              <button class="btn-ver-cotizacion" data-cot-id="${cotId}">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn-eliminar-cotizacion" data-cot-id="${cotId}">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <div class="cotizacion-historico-info">
            <span class="badge badge-${tipoSistemaEscapado}">${escapeHTML(tipoSistemaLabel)}</span>
            <span class="cotizacion-total">Total: ${totalEscapado}</span>
            ${ahorroEscapado ? `<span class="cotizacion-ahorro">Ahorro anual: ${ahorroEscapado}</span>` : ''}
          </div>
        </div>
      `;
    }).join('');
    
    // Sanitizar HTML completo antes de insertar
    listaHistorico.innerHTML = sanitizeHTML(htmlSeguro);
    
    // Agregar event listeners de forma segura (evitar onclick inline)
    listaHistorico.querySelectorAll('.btn-ver-cotizacion').forEach(btn => {
      btn.addEventListener('click', function() {
        const cotId = this.getAttribute('data-cot-id');
        if (cotId && !containsScript(cotId)) {
          verCotizacion(cotId);
        }
      });
    });
    
    listaHistorico.querySelectorAll('.btn-eliminar-cotizacion').forEach(btn => {
      btn.addEventListener('click', function() {
        const cotId = this.getAttribute('data-cot-id');
        if (cotId && !containsScript(cotId)) {
          eliminarCotizacion(cotId);
        }
      });
    });
  }
  
  // Funci√≥n para obtener hist√≥rico de cotizaciones
  function obtenerHistoricoCotizaciones() {
    try {
      const historicoStr = localStorage.getItem('cotizaciones_historico');
      if (!historicoStr) return [];
      const historico = JSON.parse(historicoStr);
      // Sanitizar datos al leer
      return historico.map(cot => ({
        ...cot,
        id: sanitizeString(cot.id || '', 100),
        cliente: {
          ...cot.cliente,
          nombre: sanitizeString(cot.cliente?.nombre || '', 100),
          email: sanitizeString(cot.cliente?.email || '', 200),
          telefono: sanitizeString(cot.cliente?.telefono || '', 20),
        }
      }));
    } catch (error) {
      console.error('Error al leer hist√≥rico:', error);
      return [];
    }
  }
  
  // Funci√≥n para guardar cotizaci√≥n
  function guardarCotizacion(datos) {
    try {
      const historico = obtenerHistoricoCotizaciones();
      const nuevaCotizacion = {
        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
        fecha: new Date().toISOString(),
        tipoSistema: sanitizeString(datos.tipoSistema || '', 20),
        cliente: {
          nombre: sanitizeString(datos.cliente?.nombre || '', 100),
          telefono: sanitizeString(datos.cliente?.telefono || '', 20),
          email: sanitizeString(datos.cliente?.email || '', 200),
          ciudad: sanitizeString(datos.cliente?.ciudad || '', 100),
          departamento: sanitizeString(datos.cliente?.departamento || '', 100),
        },
        calculos: datos.calculos || {},
        cotizacion: datos.cotizacion || {},
      };
      
      historico.unshift(nuevaCotizacion);
      // Mantener solo las √∫ltimas 50 cotizaciones
      if (historico.length > 50) {
        historico.splice(50);
      }
      
      localStorage.setItem('cotizaciones_historico', JSON.stringify(historico));
      mostrarNotificacion('Cotizaci√≥n guardada exitosamente', 'success');
      actualizarListaHistorico();
    } catch (error) {
      console.error('Error al guardar cotizaci√≥n:', error);
      mostrarNotificacion('Error al guardar la cotizaci√≥n', 'error');
    }
  }
  
  // Funci√≥n para eliminar cotizaci√≥n
  window.eliminarCotizacion = function(id) {
    // Sanitizar ID antes de usar
    if (!id || containsScript(id)) {
      mostrarNotificacion('ID de cotizaci√≥n inv√°lido', 'error');
      return;
    }
    
    const idSanitizado = sanitizeString(id, 100);
    
    if (!confirm('¬øEst√° seguro de que desea eliminar esta cotizaci√≥n?')) {
      return;
    }
    
    try {
      const historico = obtenerHistoricoCotizaciones();
      const nuevoHistorico = historico.filter(c => c.id !== idSanitizado);
      localStorage.setItem('cotizaciones_historico', JSON.stringify(nuevoHistorico));
      mostrarNotificacion('Cotizaci√≥n eliminada exitosamente', 'success');
      actualizarListaHistorico();
    } catch (error) {
      console.error('Error al eliminar cotizaci√≥n:', error);
      mostrarNotificacion('Error al eliminar la cotizaci√≥n', 'error');
    }
  };
  
  // Funci√≥n para mostrar notificaciones
  function mostrarNotificacion(mensaje, tipo = 'info') {
    const notificacion = document.createElement('div');
    notificacion.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      background: ${tipo === 'success' ? '#10b981' : tipo === 'error' ? '#ef4444' : '#3b82f6'};
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 10000;
      animation: slideIn 0.3s ease-out;
    `;
    notificacion.textContent = sanitizeString(mensaje, 200);
    document.body.appendChild(notificacion);
    
    setTimeout(() => {
      notificacion.style.animation = 'slideOut 0.3s ease-out';
      setTimeout(() => notificacion.remove(), 300);
    }, 3000);
  }
  
  // Funci√≥n para ver cotizaci√≥n del hist√≥rico
  window.verCotizacion = function(id) {
    // Sanitizar ID antes de usar
    if (!id || containsScript(id)) {
      mostrarNotificacion('ID de cotizaci√≥n inv√°lido', 'error');
      return;
    }
    
    const idSanitizado = sanitizeString(id, 100);
    const historico = obtenerHistoricoCotizaciones();
    const cotizacion = historico.find(c => c.id === idSanitizado);
    
    if (!cotizacion) {
      mostrarNotificacion('Cotizaci√≥n no encontrada', 'error');
      return;
    }
    
    // Cargar datos en el formulario
    if (cotizacion.cliente.nombre) {
      document.getElementById('clienteNombre').value = cotizacion.cliente.nombre;
    }
    if (cotizacion.cliente.telefono) {
      document.getElementById('clienteTelefono').value = cotizacion.cliente.telefono;
    }
    if (cotizacion.cliente.email) {
      document.getElementById('clienteEmail').value = cotizacion.cliente.email;
    }
    if (cotizacion.cliente.ciudad) {
      document.getElementById('clienteCiudad').value = cotizacion.cliente.ciudad;
    }
    if (cotizacion.cliente.departamento) {
      document.getElementById('clienteDepartamento').value = cotizacion.cliente.departamento;
    }
    
    // Seleccionar tipo de sistema
    const tipoSistemaInput = document.querySelector(`input[name="tipoSistema"][value="${cotizacion.tipoSistema}"]`);
    if (tipoSistemaInput) {
      tipoSistemaInput.checked = true;
      tipoSistemaInput.dispatchEvent(new Event('change'));
    }
    
    mostrarNotificacion('Datos de la cotizaci√≥n cargados. Haz clic en "Calcular" para ver los resultados.', 'info');
    
    // Scroll al formulario
    document.querySelector('.formulario-panel')?.scrollIntoView({ behavior: 'smooth' });
  };
  
  // Funci√≥n de inicializaci√≥n
  function inicializarCotizador() {
    const btnCalcular = document.getElementById('btnCalcular');
    const resultadosPanel = document.getElementById('resultadosPanel');
    const resultadosContenido = document.getElementById('resultadosContenido');
    const selectorEquipos = document.getElementById('selectorEquipos');
    
    console.log('Inicializando cotizador...', { 
      btnCalcular: !!btnCalcular, 
      resultadosPanel: !!resultadosPanel, 
      resultadosContenido: !!resultadosContenido, 
      selectorEquipos: !!selectorEquipos 
    });
    
    // Poblar selectores de equipos
    function poblarSelectores() {
      // Poblar selector de paneles
      const selectorPanel = document.getElementById('selectorPanel');
      if (selectorPanel) {
        const paneles = equipos.filter(e => e.tipo === 'panel');
        paneles.forEach(panel => {
          const option = document.createElement('option');
          option.value = panel.id;
          option.textContent = `${panel.nombre} - ${panel.marca} (${panel.potencia}W) - $${panel.precioUnitario.toLocaleString('es-CO')}`;
          selectorPanel.appendChild(option);
        });
      }
      
      // Poblar selector de inversores
      const selectorInversor = document.getElementById('selectorInversor');
      if (selectorInversor) {
        const inversores = equipos.filter(e => e.tipo === 'inversor');
        // Ordenar inversores por capacidad de generaci√≥n (potencia) de menor a mayor
        inversores.sort((a, b) => {
          const potenciaA = a.potencia || 0;
          const potenciaB = b.potencia || 0;
          return potenciaA - potenciaB; // Orden ascendente
        });
        inversores.forEach(inversor => {
          const option = document.createElement('option');
          option.value = inversor.id;
          const potencia = inversor.potencia ? `${inversor.potencia}kW` : 'N/A';
          option.textContent = `${inversor.nombre} - ${inversor.marca} (${potencia}) - $${inversor.precioUnitario.toLocaleString('es-CO')}`;
          selectorInversor.appendChild(option);
        });
      }
      
      // Poblar selector de bater√≠as
      const selectorBateria = document.getElementById('selectorBateria');
      if (selectorBateria) {
        const baterias = equipos.filter(e => e.tipo === 'bateria');
        baterias.forEach(bateria => {
          const option = document.createElement('option');
          option.value = bateria.id;
          const capacidad = bateria.capacidad ? `${bateria.capacidad}kWh` : 'N/A';
          option.textContent = `${bateria.nombre} - ${bateria.marca} (${capacidad}) - $${bateria.precioUnitario.toLocaleString('es-CO')}`;
          selectorBateria.appendChild(option);
        });
      }
      
      // Poblar selector de controladores
      const selectorControlador = document.getElementById('selectorControlador');
      if (selectorControlador) {
        const controladores = equipos.filter(e => e.tipo === 'controlador');
        controladores.forEach(controlador => {
          const option = document.createElement('option');
          option.value = controlador.id;
          const corriente = controlador.corriente ? `${controlador.corriente}A` : 'N/A';
          option.textContent = `${controlador.nombre} - ${controlador.marca} (${corriente}) - $${controlador.precioUnitario.toLocaleString('es-CO')}`;
          selectorControlador.appendChild(option);
        });
      }
    }
    
    // Mostrar/ocultar selectores seg√∫n tipo de sistema
    function actualizarSelectoresPorTipo(tipoSistema) {
      const selectorInversorContainer = document.getElementById('selectorInversorContainer');
      const selectorBateriaContainer = document.getElementById('selectorBateriaContainer');
      const selectorControladorContainer = document.getElementById('selectorControladorContainer');
      
      if (tipoSistema === 'on-grid') {
        if (selectorInversorContainer) selectorInversorContainer.style.display = 'block';
        if (selectorBateriaContainer) selectorBateriaContainer.style.display = 'none';
        if (selectorControladorContainer) selectorControladorContainer.style.display = 'none';
      } else if (tipoSistema === 'off-grid') {
        if (selectorInversorContainer) selectorInversorContainer.style.display = 'none';
        if (selectorBateriaContainer) selectorBateriaContainer.style.display = 'block';
        if (selectorControladorContainer) selectorControladorContainer.style.display = 'block';
      } else if (tipoSistema === 'hibrido') {
        if (selectorInversorContainer) selectorInversorContainer.style.display = 'block';
        if (selectorBateriaContainer) selectorBateriaContainer.style.display = 'block';
        if (selectorControladorContainer) selectorControladorContainer.style.display = 'none';
      }
    }
    
    // Inicializar selectores
    poblarSelectores();
    
    // Mostrar selector de equipos cuando se seleccione un tipo de sistema
    const tipoSistemaInputs = document.querySelectorAll('input[name="tipoSistema"]');
    tipoSistemaInputs.forEach(input => {
      input.addEventListener('change', function() {
        if (selectorEquipos) {
          selectorEquipos.style.display = 'block';
        }
        actualizarSelectoresPorTipo(this.value);
        
        // Tambi√©n actualizar la visibilidad de las secciones de datos
        const datosOnGrid = document.getElementById('datosOnGrid');
        const datosOffGrid = document.getElementById('datosOffGrid');
        
        if (this.value === 'on-grid') {
          if (datosOnGrid) datosOnGrid.style.display = 'block';
          if (datosOffGrid) datosOffGrid.style.display = 'none';
        } else if (this.value === 'off-grid') {
          if (datosOnGrid) datosOnGrid.style.display = 'none';
          if (datosOffGrid) datosOffGrid.style.display = 'block';
        } else if (this.value === 'hibrido') {
          if (datosOnGrid) datosOnGrid.style.display = 'block';
          if (datosOffGrid) datosOffGrid.style.display = 'block';
        }
      });
    });
    
    // Asegurar que el bot√≥n est√© conectado
    if (!btnCalcular) {
      console.error('Error: No se encontr√≥ el bot√≥n btnCalcular');
    }
    
    btnCalcular?.addEventListener('click', async function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      console.log('Bot√≥n Calcular clickeado');
      
      // Mostrar indicador de carga
      if (resultadosContenido) {
        resultadosContenido.innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #0ea5e9;"></i><p>Calculando sistema...</p></div>';
        resultadosPanel.style.display = 'block';
        resultadosPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
      
      try {
        // ============================================
        // VALIDACI√ìN DE SEGURIDAD Y DATOS
        // ============================================
        
        // Verificar sesi√≥n activa
        const sesionToken = sessionStorage.getItem('cotizador_token');
        if (!sesionToken) {
          alert('Sesi√≥n expirada. Por favor inicie sesi√≥n nuevamente.');
          cerrarSesion();
          return;
        }
        
        // Obtener datos del formulario
        const modeloNegocio = document.querySelector('input[name="modeloNegocio"]:checked')?.value || 'epc';
        const tipoSistema = document.querySelector('input[name="tipoSistema"]:checked')?.value;
        const departamento = document.getElementById('clienteDepartamento')?.value;
        const ciudad = document.getElementById('clienteCiudad')?.value;
        
        // Validar y sanitizar inputs
        if (!tipoSistema || !['on-grid', 'off-grid', 'hibrido'].includes(tipoSistema)) {
          alert('Por favor seleccione un tipo de sistema v√°lido');
          resultadosPanel.style.display = 'none';
          return;
        }
        
        if (!departamento || !ciudad) {
          alert('Por favor seleccione el departamento y la ciudad');
          resultadosPanel.style.display = 'none';
          return;
        }
        
        // Sanitizar ciudad y departamento
        const ciudadSanitizada = sanitizeString(ciudad, 100);
        const departamentoSanitizado = sanitizeString(departamento, 100);
        
        // Validar que no contengan scripts
        if (containsScript(ciudadSanitizada) || containsScript(departamentoSanitizado)) {
          alert('Datos inv√°lidos detectados. Por favor verifique la informaci√≥n ingresada.');
          resultadosPanel.style.display = 'none';
          return;
        }
        
        console.log('Datos obtenidos:', { modeloNegocio, tipoSistema, departamento: departamentoSanitizado, ciudad: ciudadSanitizada });
        
        // Estaci√≥n Meteorol√≥gica = Ciudad seleccionada
        const estacionMeteorologica = ciudadSanitizada;
        const estacionMeteorologicaInput = document.getElementById('estacionMeteorologica');
        if (estacionMeteorologicaInput) {
          estacionMeteorologicaInput.value = ciudadSanitizada;
        }
      
      // Mostrar selector de equipos si est√° oculto
      if (selectorEquipos) {
        selectorEquipos.style.display = 'block';
      }
      
         // Declarar variables fuera del bloque if para que est√©n disponibles en el scope del try
         let potenciaInstalada, hsp, eficienciaOptimo, panel, inversor, cantidadPaneles;
         let tarifaElectrica, porcentajeAutoconsumo, consumoAnual, potenciaNecesaria;
         let generacionAnual, energiaAutoconsumo, energiaExcedente, ahorroAnual;
         let tarifaVentaExcedentes, descuento, obrasAdicionales, requiereAndamios;
         let metrajeAndamio, polizas, sst, comisionAdicionalPorcentaje;
         let porcentajeAhorro, porcentajeAhorroPorcentaje; // Para mostrar en vista t√©cnica
         let esIdaYRegreso, costoRETIE; // Para RETIE
         // Variables para Off-Grid
         let consumoDiario, eficienciaInversorOffGrid, eficienciaBateria, diasAutonomia;
         let profundidadDescarga, sdPaneles, potenciaNecesariaOffGrid, capacidadBateriaKWh;
         let voltajeSistema;
      
      if (tipoSistema === 'on-grid' || tipoSistema === 'hibrido') {
        // Obtener consumos mensuales
        const consumoPromedio = parseFloat(document.getElementById('consumoPromedio')?.value || 0);
        const consumosMensuales = Array.from(document.querySelectorAll('.consumo-mes'))
          .map(input => parseFloat(input.value) || 0)
          .filter(v => v > 0);
        
        let consumos = consumosMensuales.length > 0 
          ? consumosMensuales 
          : consumoPromedio > 0 
            ? [consumoPromedio] 
            : [];
        
        if (consumos.length === 0) {
          alert('Por favor ingrese el consumo mensual');
          return;
        }
        
        // Si solo hay un valor, generar 12 meses con variaci√≥n
        if (consumos.length === 1) {
          const promedio = consumos[0];
          consumos = [];
          for (let i = 0; i < 12; i++) {
            let variacion = 1;
            // Variaci√≥n del 2% alternando
            if (i % 2 === 0) {
              variacion = 1.02;
            } else {
              variacion = 0.98;
            }
            // Aumento del 10% en julio y diciembre
            if (i === 6 || i === 11) {
              variacion = 1.10;
            }
            consumos.push(promedio * variacion);
          }
        }
        
        // Obtener tarifa el√©ctrica
        tarifaElectrica = parseFloat(document.getElementById('tarifaElectrica')?.value || 0);
        
        // Costo base = Tarifa (sincronizar)
        const costoKwhBaseInput = document.getElementById('costoKwhBase');
        if (tarifaElectrica > 0 && costoKwhBaseInput) {
          // Si hay tarifa, actualizar costo base
          costoKwhBaseInput.value = tarifaElectrica;
        } else {
          // Si no hay tarifa, intentar desde costo base
          const costoKwhBase = parseFloat(costoKwhBaseInput?.value || 0);
          const tieneContribucion = document.getElementById('tieneContribucion')?.value === 'si';
          if (costoKwhBase > 0) {
            tarifaElectrica = costoKwhBase + (tieneContribucion ? costoKwhBase * 0.2 : 0);
            // Actualizar campo de tarifa
            const tarifaElectricaInput = document.getElementById('tarifaElectrica');
            if (tarifaElectricaInput) {
              tarifaElectricaInput.value = tarifaElectrica;
            }
          }
        }
        
        if (!tarifaElectrica || tarifaElectrica <= 0) {
          alert('Por favor ingrese la tarifa el√©ctrica o el costo kWh base');
          resultadosPanel.style.display = 'none';
          return;
        }
        
        porcentajeAutoconsumo = parseFloat(document.getElementById('porcentajeAutoconsumo')?.value || 60);
        const ventaExcedentes = document.getElementById('ventaExcedentes')?.value === 'si';
        tarifaVentaExcedentes = parseFloat(document.getElementById('tarifaVentaExcedentes')?.value || 0);
        
        // Si no hay tarifa de venta de excedentes pero se venden excedentes, usar 90% de la tarifa
        if (ventaExcedentes && !tarifaVentaExcedentes) {
          tarifaVentaExcedentes = tarifaElectrica * 0.9;
        }
        
        // Obtener otros par√°metros importantes
        const trmDolar = parseFloat(document.getElementById('trmDolar')?.value || 4000);
        descuento = parseFloat(document.getElementById('descuento')?.value || 0) / 100;
        eficienciaOptimo = parseFloat(document.getElementById('eficienciaOptimo')?.value || 0.97);
        porcentajeAhorro = parseFloat(document.getElementById('porcentajeAhorro')?.value || 100) / 100;
        porcentajeAhorroPorcentaje = parseFloat(document.getElementById('porcentajeAhorro')?.value || 100);
        const beneficiosLey1715 = document.getElementById('beneficiosLey1715')?.value === 'si';
        requiereAndamios = document.getElementById('requiereAndamios')?.value === 'si';
        metrajeAndamio = parseFloat(document.getElementById('metrajeAndamio')?.value || 0);
        const cableadoDC = parseFloat(document.getElementById('cableadoDC')?.value || 10);
        const cableadoAC = parseFloat(document.getElementById('cableadoAC')?.value || 10);
        polizas = document.getElementById('polizas')?.value === 'si';
        sst = document.getElementById('sst')?.value === 'si';
        obrasAdicionales = parseFloat(document.getElementById('obrasAdicionales')?.value || 0);
        const porcentajeAutonomia = parseFloat(document.getElementById('porcentajeAutonomia')?.value || 10) / 100;
        
        // Comisi√≥n adicional en % (se calcular√° sobre el valor del proyecto)
        comisionAdicionalPorcentaje = parseFloat(document.getElementById('comisionAdicional')?.value || 0);
        
        // Calcular para On-Grid o H√≠brido
        hsp = obtenerHSPPorCiudad(ciudad, departamento);
        consumoAnual = calcularConsumoAnual(consumos) * porcentajeAhorro; // Aplicar % de ahorro deseado
        potenciaNecesaria = calcularPotenciaNecesariaOnGrid(consumoAnual, hsp, eficienciaOptimo);
        
        // Obtener panel seleccionado (manual o autom√°tico)
        const selectorPanel = document.getElementById('selectorPanel');
        panel = null;
        
        if (selectorPanel && selectorPanel.value) {
          panel = equipos.find(e => e.id === selectorPanel.value);
        }
        
        // Si no hay panel seleccionado, seleccionar autom√°ticamente
        if (!panel) {
          const paneles = equipos.filter(e => e.tipo === 'panel');
          if (paneles.length === 0) {
            alert('Error: No hay paneles disponibles en la base de datos');
            return;
          }
          
          const potenciaNecesariaW = potenciaNecesaria * 1000;
          const panelesAdecuados = paneles.filter(p => {
            const potenciaPanel = p.potencia || 0;
            const cantidadNecesaria = Math.ceil(potenciaNecesariaW / potenciaPanel);
            return cantidadNecesaria <= 50 && cantidadNecesaria > 0;
          });
          
          if (panelesAdecuados.length > 0) {
            panelesAdecuados.sort((a, b) => {
              const potenciaA = a.potencia || 0;
              const potenciaB = b.potencia || 0;
              const precioWpA = a.precioWp || (a.precioUnitario / potenciaA);
              const precioWpB = b.precioWp || (b.precioUnitario / potenciaB);
              const scoreA = potenciaA / precioWpA;
              const scoreB = potenciaB / precioWpB;
              return scoreB - scoreA;
            });
            panel = panelesAdecuados[0];
          } else {
            panel = paneles.reduce((max, p) => 
              (p.potencia || 0) > (max.potencia || 0) ? p : max
            );
          }
          
          if (selectorPanel) {
            selectorPanel.value = panel.id;
            selectorPanel.dispatchEvent(new Event('change'));
          }
        }
        
        if (!panel) {
          alert('Error: No se encontr√≥ un panel adecuado');
          return;
        }
        
        // Calcular cantidad de paneles
        const potenciaPanel = panel.potencia / 1000; // W a kW
        cantidadPaneles = calcularCantidadPaneles(potenciaNecesaria, potenciaPanel);
        potenciaInstalada = cantidadPaneles * potenciaPanel;
        
        // Obtener inversor seleccionado (manual o autom√°tico)
        inversor = null;
        if (tipoSistema === 'on-grid' || tipoSistema === 'hibrido') {
          const selectorInversor = document.getElementById('selectorInversor');
          
          if (selectorInversor && selectorInversor.value) {
            inversor = equipos.find(e => e.id === selectorInversor.value);
          } else {
            const inversores = equipos.filter(e => e.tipo === 'inversor');
            if (inversores.length > 0) {
              // Ordenar inversores por capacidad de generaci√≥n (potencia) de menor a mayor
              inversores.sort((a, b) => {
                const potenciaA = a.potencia || 0;
                const potenciaB = b.potencia || 0;
                return potenciaA - potenciaB;
              });
              
              const potenciaMinima = potenciaInstalada;
              const potenciaMaxima = potenciaInstalada * 1.2;
              
              // Buscar inversor que pueda manejar la potencia instalada
              // Priorizar inversores en el rango ideal (potencia instalada a 1.2x)
              const inversoresAdecuados = inversores.filter(inv => {
                const potenciaInv = inv.potencia || 0;
                return potenciaInv >= potenciaMinima && potenciaInv <= potenciaMaxima;
              });
              
              if (inversoresAdecuados.length > 0) {
                // Seleccionar el m√°s cercano a la potencia necesaria
                inversoresAdecuados.sort((a, b) => {
                  const diffA = Math.abs((a.potencia || 0) - potenciaInstalada);
                  const diffB = Math.abs((b.potencia || 0) - potenciaInstalada);
                  return diffA - diffB;
                });
                inversor = inversoresAdecuados[0];
              } else {
                // Si no hay en el rango ideal, buscar el m√°s peque√±o que pueda manejar la potencia
                const inversoresMayores = inversores
                  .filter(inv => (inv.potencia || 0) >= potenciaInstalada)
                  .sort((a, b) => (a.potencia || 0) - (b.potencia || 0));
                inversor = inversoresMayores.length > 0 ? inversoresMayores[0] : null;
              }
              
              if (inversor && selectorInversor) {
                selectorInversor.value = inversor.id;
                selectorInversor.dispatchEvent(new Event('change'));
              }
            }
          }
        }
        
        generacionAnual = calcularGeneracionAnual(potenciaInstalada, hsp, eficienciaOptimo);
        const resultadoAhorro = calcularAhorroAnualOnGrid(
          generacionAnual,
          porcentajeAutoconsumo,
          tarifaElectrica,
          tarifaVentaExcedentes
        );
        energiaAutoconsumo = resultadoAhorro.energiaAutoconsumo;
        energiaExcedente = resultadoAhorro.energiaExcedente;
        ahorroAnual = resultadoAhorro.ahorroAnual;
        
        // Continuar con la generaci√≥n de cotizaci√≥n...
        // NOTA: El c√≥digo de generaci√≥n de cotizaci√≥n est√° en un bloque if separado m√°s abajo
        // porque necesita estar despu√©s del bloque else if de Off-Grid para mantener la estructura
        
      } else if (tipoSistema === 'off-grid') {
        // Sistema Off-Grid
        // Calcular consumo diario desde los equipos
        const equipos = document.querySelectorAll('.equipo-item');
        let consumoDiario = 0;
        
        equipos.forEach(equipo => {
          const index = parseInt(equipo.dataset.index);
          const potencia = parseFloat(document.getElementById(`equipoPotencia_${index}`)?.value || 0);
          const cantidad = parseFloat(document.getElementById(`equipoCantidad_${index}`)?.value || 1);
          const horasUso = parseFloat(document.getElementById(`equipoHorasUso_${index}`)?.value || 0);
          const diasSemana = parseFloat(document.getElementById(`equipoDiasSemana_${index}`)?.value || 7);
          const factorPotencia = parseFloat(document.getElementById(`equipoFactorPotencia_${index}`)?.value || 1);
          
          // Validar campos requeridos
          const nombre = document.getElementById(`equipoNombre_${index}`)?.value;
          if (!nombre || !potencia || !horasUso) {
            alert(`Por favor complete todos los campos del Equipo ${index + 1}`);
            return;
          }
          
          // Consumo diario = (Potencia * Cantidad * Horas * Factor) * (D√≠as semana / 7)
          const consumoEquipo = (potencia * cantidad * horasUso * factorPotencia / 1000) * (diasSemana / 7);
          consumoDiario += consumoEquipo;
        });
        
        if (equipos.length === 0) {
          alert('Por favor agregue al menos un equipo');
          return;
        }
        
        if (consumoDiario <= 0) {
          alert('El consumo diario calculado debe ser mayor a 0. Por favor verifique los datos de los equipos');
          return;
        }
        
        diasAutonomia = parseFloat(document.getElementById('diasAutonomia')?.value || 3);
        voltajeSistema = parseInt(document.getElementById('voltajeSistema')?.value || 48);
        const tipoConsumo = document.getElementById('tipoConsumo')?.value || '24h';
        profundidadDescarga = parseFloat(document.getElementById('profundidadDescarga')?.value || 50) / 100; // Convertir % a decimal
        eficienciaInversorOffGrid = parseFloat(document.getElementById('eficienciaInversorOffGrid')?.value || 0.93);
        eficienciaBateria = parseFloat(document.getElementById('eficienciaBateriaOffGrid')?.value || 0.95);
        sdPaneles = parseFloat(document.getElementById('sdPanelesOffGrid')?.value || 0.5);
        
        // Calcular para Off-Grid
        hsp = obtenerHSPPorCiudad(ciudad, departamento);
        
        // Obtener panel seleccionado (manual o autom√°tico)
        const selectorPanel = document.getElementById('selectorPanel');
        let panel = null;
        
        if (selectorPanel && selectorPanel.value) {
          panel = equipos.find(e => e.id === selectorPanel.value);
        }
        
        // Si no hay panel seleccionado, seleccionar autom√°ticamente
        if (!panel) {
          const paneles = equipos.filter(e => e.tipo === 'panel');
          if (paneles.length === 0) {
            alert('Error: No hay paneles disponibles en la base de datos');
            return;
          }
          
          const potenciaNecesariaW = potenciaNecesaria * 1000;
          const panelesAdecuados = paneles.filter(p => {
            const potenciaPanel = p.potencia || 0;
            const cantidadNecesaria = Math.ceil(potenciaNecesariaW / potenciaPanel);
            return cantidadNecesaria <= 50 && cantidadNecesaria > 0;
          });
          
          if (panelesAdecuados.length > 0) {
            panelesAdecuados.sort((a, b) => {
              const potenciaA = a.potencia || 0;
              const potenciaB = b.potencia || 0;
              const precioWpA = a.precioWp || (a.precioUnitario / potenciaA);
              const precioWpB = b.precioWp || (b.precioUnitario / potenciaB);
              const scoreA = potenciaA / precioWpA;
              const scoreB = potenciaB / precioWpB;
              return scoreB - scoreA;
            });
            panel = panelesAdecuados[0];
          } else {
            panel = paneles.reduce((max, p) => 
              (p.potencia || 0) > (max.potencia || 0) ? p : max
            );
          }
          
          if (selectorPanel) {
            selectorPanel.value = panel.id;
            selectorPanel.dispatchEvent(new Event('change'));
          }
        }
        
        if (!panel) {
          alert('Error: No se encontr√≥ un panel adecuado');
          return;
        }
        
        // Calcular capacidad de bater√≠a necesaria (seg√∫n Excel)
        // F√≥rmula: ((ConsumoDiario / (EficienciaInversor * EficienciaBateria)) / Voltaje) * DiasAutonomia / ProfundidadDescarga
        const consumoCorregido = consumoDiario / (eficienciaInversorOffGrid * eficienciaBateria);
        capacidadBateriaKWh = (consumoCorregido * diasAutonomia) / (profundidadDescarga);
        
        // Calcular potencia necesaria (seg√∫n Excel Off-Grid)
        // F√≥rmula: (ConsumoDiario / (EficienciaInversor * EficienciaBateria)) / (EficienciaRestoSistema * HSP) * (1 + SD)
        const consumoCorregidoPotencia = consumoDiario / (eficienciaInversorOffGrid * eficienciaBateria);
        const eficienciaRestoSistema = 0.9; // Fijo seg√∫n Excel
        potenciaNecesariaOffGrid = (consumoCorregidoPotencia / (eficienciaRestoSistema * hsp)) * (1 + sdPaneles);
        
        // Calcular cantidad de paneles con la potencia corregida
        const potenciaPanel = panel.potencia / 1000; // W a kW
        cantidadPaneles = calcularCantidadPaneles(potenciaNecesariaOffGrid, potenciaPanel);
        potenciaInstalada = cantidadPaneles * potenciaPanel;
        
        // Seleccionar bater√≠a autom√°ticamente
        const selectorBateria = document.getElementById('selectorBateria');
        let bateria = null;
        
        if (selectorBateria && selectorBateria.value) {
          bateria = equipos.find(e => e.id === selectorBateria.value);
        } else {
          const baterias = equipos.filter(e => 
            e.tipo === 'bateria' && 
            e.voltaje === voltajeSistema
          );
          
          if (baterias.length > 0) {
            // Calcular cantidad de bater√≠as necesarias para cada tipo
            const opciones = baterias.map(bat => {
              const capacidadBat = bat.capacidad || 0; // kWh
              const cantidad = Math.ceil(capacidadBateriaKWh / capacidadBat);
              const capacidadTotal = cantidad * capacidadBat;
              const costoTotal = cantidad * bat.precioUnitario;
              
              return {
                bateria: bat,
                cantidad,
                capacidadTotal,
                costoTotal,
                eficiencia: capacidadBat / bat.precioUnitario,
              };
            });
            
            opciones.sort((a, b) => {
              const scoreA = a.eficiencia / a.cantidad;
              const scoreB = b.eficiencia / b.cantidad;
              return scoreB - scoreA;
            });
            
            bateria = opciones[0]?.bateria || null;
            
            if (bateria && selectorBateria) {
              selectorBateria.value = bateria.id;
              selectorBateria.dispatchEvent(new Event('change'));
            }
          }
        }
        
        // Seleccionar controlador autom√°ticamente
        const selectorControlador = document.getElementById('selectorControlador');
        let controlador = null;
        
        if (selectorControlador && selectorControlador.value) {
          controlador = equipos.find(e => e.id === selectorControlador.value);
        } else {
          const controladores = equipos.filter(e => 
            e.tipo === 'controlador' &&
            e.voltaje === voltajeSistema
          );
          
          if (controladores.length > 0 && panel) {
            // Calcular corriente m√°xima de los paneles
            const corrienteMaximaPaneles = (panel.corriente || 0) * cantidadPaneles;
            const corrienteNecesaria = corrienteMaximaPaneles * 1.25; // 25% de margen
            
            const controladoresAdecuados = controladores.filter(ctrl => {
              const corrienteCtrl = ctrl.corriente || 0;
              return corrienteCtrl >= corrienteNecesaria;
            });
            
            if (controladoresAdecuados.length > 0) {
              controladoresAdecuados.sort((a, b) => {
                const diffA = Math.abs((a.corriente || 0) - corrienteNecesaria);
                const diffB = Math.abs((b.corriente || 0) - corrienteNecesaria);
                return diffA - diffB;
              });
              controlador = controladoresAdecuados[0];
            } else {
              controlador = controladores.reduce((max, ctrl) => 
                (ctrl.corriente || 0) > (max.corriente || 0) ? ctrl : max
              );
            }
            
            if (controlador && selectorControlador) {
              selectorControlador.value = controlador.id;
              selectorControlador.dispatchEvent(new Event('change'));
            }
          }
        }
        
        // Calcular generaci√≥n
        const generacionAnual = calcularGeneracionAnual(potenciaInstalada, hsp, eficienciaInversorOffGrid);
        const generacionDiaria = generacionAnual / 365;
        
        // Calcular cantidad de bater√≠as
        const cantidadBaterias = bateria 
          ? Math.ceil(capacidadBateriaKWh / (bateria.capacidad || 1))
          : 0;
        
        // Generar cotizaci√≥n Off-Grid
        const itemsCotizacion = [];
        
        // Panel
        const precioPanel = panel.precioUnitario;
        const subtotalPaneles = precioPanel * cantidadPaneles;
        itemsCotizacion.push({
          descripcion: `${panel.nombre} - ${panel.marca} ${panel.modelo || ''}`,
          cantidad: cantidadPaneles,
          precioUnitario: precioPanel,
          subtotal: subtotalPaneles,
        });
        
        // Controlador
        if (controlador) {
          itemsCotizacion.push({
            descripcion: `${controlador.nombre} - ${controlador.marca} ${controlador.modelo || ''}`,
            cantidad: 1,
            precioUnitario: controlador.precioUnitario,
            subtotal: controlador.precioUnitario,
          });
        }
        
        // Bater√≠a
        if (bateria) {
          itemsCotizacion.push({
            descripcion: `${bateria.nombre} - ${bateria.marca} ${bateria.modelo || ''}`,
            cantidad: cantidadBaterias,
            precioUnitario: bateria.precioUnitario,
            subtotal: bateria.precioUnitario * cantidadBaterias,
          });
        }
        
        // Items adicionales
        // Calcular precio de estructura seg√∫n tipo de cubierta
        const tipoCubierta = document.getElementById('tipoCubierta')?.value || 'teja-barro';
        // Las funciones obtenerPrecioEstructura y obtenerInfoCubierta ya est√°n definidas en el scope global
        const infoCubierta = obtenerInfoCubierta(tipoCubierta);
        const precioEstructuraTotal = obtenerPrecioEstructura(tipoCubierta, cantidadPaneles);
        const precioEstructuraPorPanel = precioEstructuraTotal / cantidadPaneles;
        
        itemsCotizacion.push({
          descripcion: infoCubierta ? `Estructura para ${infoCubierta.nombre}` : 'Estructura para paneles solares',
          cantidad: cantidadPaneles,
          precioUnitario: precioEstructuraPorPanel,
          subtotal: precioEstructuraTotal,
        });
        
        // Instalaci√≥n (10% del subtotal de equipos)
        const subtotalEquiposAntesRentabilidad = itemsCotizacion.reduce((sum, item) => sum + item.subtotal, 0);
        const precioInstalacion = Math.round(subtotalEquiposAntesRentabilidad * 0.10);
        itemsCotizacion.push({
          descripcion: 'Instalaci√≥n, transporte, supervisi√≥n y puesta en marcha',
          cantidad: 1,
          precioUnitario: precioInstalacion,
          subtotal: precioInstalacion,
        });
        
        // Obtener rentabilidad (m√≠nimo 20% + adicional)
        const rentabilidadMinima = 0.20; // 20% m√≠nimo
        const rentabilidadAdicional = parseFloat(document.getElementById('rentabilidadAdicional')?.value || 0) / 100;
        const rentabilidadTotal = rentabilidadMinima + rentabilidadAdicional;
        
        // Aplicar rentabilidad a todos los items de equipos ANTES de agregar items adicionales
        // F√≥rmula seg√∫n Excel: Precio = Costo / (1 - Rentabilidad)
        itemsCotizacion.forEach(item => {
          const costoOriginal = item.precioUnitario;
          const precioConRentabilidad = costoOriginal / (1 - rentabilidadTotal);
          item.precioUnitario = precioConRentabilidad;
          item.subtotal = precioConRentabilidad * item.cantidad;
          item.costoOriginal = costoOriginal; // Guardar costo original para referencia
          item.rentabilidadAplicada = rentabilidadTotal;
        });
        
        // Calcular subtotal de equipos con rentabilidad aplicada
        let subtotalEquipos = itemsCotizacion.reduce((sum, item) => sum + item.subtotal, 0);
        
        // Aplicar descuento si existe (sobre subtotal de equipos)
        if (descuentoOffGrid > 0) {
          subtotalEquipos = subtotalEquipos * (1 - descuentoOffGrid);
        }
        
        // Agregar obras adicionales (sin rentabilidad)
        if (obrasAdicionalesOffGrid > 0) {
          itemsCotizacion.push({
            descripcion: 'Obras adicionales',
            cantidad: 1,
            precioUnitario: obrasAdicionalesOffGrid,
            subtotal: obrasAdicionalesOffGrid,
            costoOriginal: obrasAdicionalesOffGrid,
            rentabilidadAplicada: 0, // Sin rentabilidad
          });
        }
        
        // Agregar vi√°ticos si se requieren (sin rentabilidad)
        if (viaticosOffGrid) {
          // Precio estimado de vi√°ticos (ajustar seg√∫n necesidad)
          const costoViaticos = kmsMedellinOffGrid > 0 ? kmsMedellinOffGrid * 2000 : 500000; // COP
          itemsCotizacion.push({
            descripcion: 'Vi√°ticos',
            cantidad: 1,
            precioUnitario: costoViaticos,
            subtotal: costoViaticos,
            costoOriginal: costoViaticos,
            rentabilidadAplicada: 0, // Sin rentabilidad
          });
        }
        
        // Agregar sobrecargo por lejan√≠a si aplica (sin rentabilidad)
        if (sobrecargoLejaniaOffGrid !== 'no' && kmsMedellinOffGrid > 0) {
          const costoPorKm = sobrecargoLejaniaOffGrid === 'ida-regreso' ? 5000 : 2500; // COP por km
          const costoSobrecargo = kmsMedellinOffGrid * costoPorKm;
          itemsCotizacion.push({
            descripcion: `Sobrecargo por lejan√≠a (${sobrecargoLejaniaOffGrid === 'ida-regreso' ? 'Ida y Regreso' : 'Solo Ida'})`,
            cantidad: 1,
            precioUnitario: costoSobrecargo,
            subtotal: costoSobrecargo,
            costoOriginal: costoSobrecargo,
            rentabilidadAplicada: 0, // Sin rentabilidad
          });
        }
        
        // Calcular subtotal antes de comisi√≥n adicional
        let subtotal = itemsCotizacion.reduce((sum, item) => sum + item.subtotal, 0);
        
        // Calcular comisi√≥n adicional sobre el subtotal (en %)
        const comisionAdicionalValor = comisionAdicionalPorcentaje > 0 
          ? subtotal * (comisionAdicionalPorcentaje / 100)
          : 0;
        
        // Agregar comisi√≥n adicional como item si existe
        if (comisionAdicionalValor > 0) {
          itemsCotizacion.push({
            descripcion: `Comisi√≥n Adicional (${comisionAdicionalPorcentaje}%)`,
            cantidad: 1,
            precioUnitario: comisionAdicionalValor,
            subtotal: comisionAdicionalValor,
            costoOriginal: comisionAdicionalValor,
            rentabilidadAplicada: 0, // Sin rentabilidad adicional
          });
          subtotal += comisionAdicionalValor;
        }
        
        const iva = subtotal * 0.19;
        const total = subtotal + iva;
        
        // Mostrar resultados
        resultadosContenido.innerHTML = `
          <div class="resultado-card">
            <h3>Resultados del C√°lculo - Sistema Off-Grid</h3>
            <div class="resultado-grid">
              <div class="resultado-item">
                <span class="resultado-label">Potencia Necesaria</span>
                <span class="resultado-value">${potenciaNecesaria.toFixed(2)} kWp</span>
              </div>
              <div class="resultado-item">
                <span class="resultado-label">Cantidad de Paneles</span>
                <span class="resultado-value">${cantidadPaneles} unidades</span>
              </div>
              <div class="resultado-item">
                <span class="resultado-label">Potencia Instalada</span>
                <span class="resultado-value">${potenciaInstalada.toFixed(2)} kWp</span>
              </div>
              <div class="resultado-item">
                <span class="resultado-label">Capacidad de Bater√≠a</span>
                <span class="resultado-value">${capacidadBateriaKWh.toFixed(2)} kWh</span>
              </div>
              <div class="resultado-item">
                <span class="resultado-label">Cantidad de Bater√≠as</span>
                <span class="resultado-value">${cantidadBaterias} unidades</span>
              </div>
              <div class="resultado-item">
                <span class="resultado-label">Generaci√≥n Diaria</span>
                <span class="resultado-value">${generacionDiaria.toFixed(2)} kWh/d√≠a</span>
              </div>
              <div class="resultado-item">
                <span class="resultado-label">D√≠as de Autonom√≠a</span>
                <span class="resultado-value">${diasAutonomia} d√≠as</span>
              </div>
              <div class="resultado-item">
                <span class="resultado-label">Voltaje del Sistema</span>
                <span class="resultado-value">${voltajeSistema}V</span>
              </div>
            </div>
          </div>
          
          <div class="resultado-card cotizacion-card">
            <h3><i class="fas fa-file-invoice-dollar"></i> Cotizaci√≥n Detallada</h3>
            <table class="cotizacion-table">
              <thead>
                <tr>
                  <th>Descripci√≥n</th>
                  <th>Cantidad</th>
                  <th>Precio Unitario</th>
                  <th>Subtotal</th>
                </tr>
              </thead>
              <tbody>
                ${itemsCotizacion.map(item => `
                  <tr>
                    <td>${item.descripcion}</td>
                    <td>${item.cantidad}</td>
                    <td data-costo-original="${item.costoOriginal || item.precioUnitario}">${formatCOP(item.precioUnitario)}</td>
                    <td>${formatCOP(item.subtotal)}</td>
                  </tr>
                `).join('')}
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="3"><strong>Subtotal</strong></td>
                  <td><strong>${formatCOP(subtotal)}</strong></td>
                </tr>
                <tr>
                  <td colspan="3"><strong>IVA (19%)</strong></td>
                  <td><strong>${formatCOP(iva)}</strong></td>
                </tr>
                <tr class="total-row">
                  <td colspan="3"><strong>TOTAL</strong></td>
                  <td><strong>${formatCOP(total)}</strong></td>
                </tr>
              </tfoot>
            </table>
            
            <button class="btn-whatsapp" onclick="enviarCotizacionWhatsAppOffGrid(
              ${JSON.stringify(itemsCotizacion)},
              ${subtotal},
              ${iva},
              ${total},
              {
                potenciaInstalada: ${potenciaInstalada},
                cantidadPaneles: ${cantidadPaneles},
                generacionAnual: ${generacionAnual},
                generacionDiaria: ${generacionDiaria},
                capacidadBateria: ${capacidadBateriaKWh},
                cantidadBaterias: ${cantidadBaterias},
                consumoDiario: ${consumoDiario},
                diasAutonomia: ${diasAutonomia},
                voltajeSistema: ${voltajeSistema}
              }
            )">
              <i class="fab fa-whatsapp"></i>
              Enviar Cotizaci√≥n por WhatsApp
            </button>
          </div>
        `;
        
        resultadosPanel.style.display = 'block';
        // Hacer scroll suave al panel de resultados
        setTimeout(() => {
          resultadosPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
        
        return; // Salir de la funci√≥n para Off-Grid
      }
      
      // Continuar con On-Grid/H√≠brido - Generaci√≥n de cotizaci√≥n
      // Las variables ya est√°n definidas y asignadas en el bloque if anterior
      if (tipoSistema === 'on-grid' || tipoSistema === 'hibrido') {
        // Calcular cotizaci√≥n
        const itemsCotizacion = [];
        
        // Panel seleccionado
        const precioPanel = panel.precioUnitario;
        const subtotalPaneles = precioPanel * cantidadPaneles;
        itemsCotizacion.push({
          descripcion: `${panel.nombre} - ${panel.marca} ${panel.modelo || ''}`,
          cantidad: cantidadPaneles,
          precioUnitario: precioPanel,
          subtotal: subtotalPaneles,
        });
        
        // Inversor (si aplica)
        if (inversor) {
          // Calcular cantidad de inversores necesarios
          const cantidadInversores = Math.ceil(potenciaInstalada / inversor.potencia);
          const subtotalInversores = inversor.precioUnitario * cantidadInversores;
          itemsCotizacion.push({
            descripcion: `${inversor.nombre} - ${inversor.marca} ${inversor.modelo || ''}`,
            cantidad: cantidadInversores,
            precioUnitario: inversor.precioUnitario,
            subtotal: subtotalInversores,
          });
        }
        
        // Items adicionales (estructura, instalaci√≥n, etc.)
        // Calcular precio de estructura seg√∫n tipo de cubierta
        const tipoCubierta = document.getElementById('tipoCubierta')?.value || 'teja-barro';
        const infoCubierta = obtenerInfoCubierta(tipoCubierta);
        const precioEstructuraTotal = obtenerPrecioEstructura(tipoCubierta, cantidadPaneles);
        const precioEstructuraPorPanel = precioEstructuraTotal / cantidadPaneles;
        
        itemsCotizacion.push({
          descripcion: infoCubierta ? `Estructura para ${infoCubierta.nombre}` : 'Estructura para paneles solares',
          cantidad: cantidadPaneles,
          precioUnitario: precioEstructuraPorPanel,
          subtotal: precioEstructuraTotal,
        });
        
        const tablero = equipos.find(e => e.id === 'tablero-proteccion');
        if (tablero) {
          itemsCotizacion.push({
            descripcion: tablero.nombre,
            cantidad: 1,
            precioUnitario: tablero.precioUnitario,
            subtotal: tablero.precioUnitario,
          });
        }
        
        // Instalaci√≥n (10% del subtotal de equipos)
        const subtotalEquiposAntesRentabilidad = itemsCotizacion.reduce((sum, item) => sum + item.subtotal, 0);
        const precioInstalacion = Math.round(subtotalEquiposAntesRentabilidad * 0.10);
        itemsCotizacion.push({
          descripcion: 'Instalaci√≥n, transporte, supervisi√≥n y puesta en marcha',
          cantidad: 1,
          precioUnitario: precioInstalacion,
          subtotal: precioInstalacion,
        });
        
        // Calcular RETIE seg√∫n la f√≥rmula del Excel
        // Buscar el campo de tipo de viaje (puede estar en sobrecargoLejania o tipoViaje)
        const sobrecargoLejania = document.getElementById('sobrecargoLejania')?.value || 'solo-ida';
        esIdaYRegreso = sobrecargoLejania === 'ida-regreso';
        costoRETIE = calcularRETIE(potenciaInstalada, esIdaYRegreso);
        
        itemsCotizacion.push({
          descripcion: 'Certificaci√≥n RETIE',
          cantidad: 1,
          precioUnitario: costoRETIE,
          subtotal: costoRETIE,
          costoOriginal: costoRETIE,
          rentabilidadAplicada: 0, // RETIE se calcula con rentabilidad despu√©s
        });
        
        // Obtener rentabilidad (m√≠nimo 20% + adicional)
        const rentabilidadMinima = 0.20; // 20% m√≠nimo
        const rentabilidadAdicional = parseFloat(document.getElementById('rentabilidadAdicional')?.value || 0) / 100;
        const rentabilidadTotal = rentabilidadMinima + rentabilidadAdicional;
        
        // Aplicar rentabilidad a todos los items de equipos ANTES de agregar items adicionales
        // F√≥rmula seg√∫n Excel: Precio = Costo / (1 - Rentabilidad)
        itemsCotizacion.forEach(item => {
          const costoOriginal = item.precioUnitario;
          const precioConRentabilidad = costoOriginal / (1 - rentabilidadTotal);
          item.precioUnitario = precioConRentabilidad;
          item.subtotal = precioConRentabilidad * item.cantidad;
          item.costoOriginal = costoOriginal; // Guardar costo original para referencia
          item.rentabilidadAplicada = rentabilidadTotal;
        });
        
        // Calcular subtotal de equipos con rentabilidad aplicada
        let subtotalEquipos = itemsCotizacion.reduce((sum, item) => sum + item.subtotal, 0);
        
        // Aplicar descuento si existe (sobre subtotal de equipos)
        if (descuento > 0) {
          subtotalEquipos = subtotalEquipos * (1 - descuento);
        }
        
        // Agregar obras adicionales (sin rentabilidad, se agregan al final)
        if (obrasAdicionales > 0) {
          itemsCotizacion.push({
            descripcion: 'Obras adicionales',
            cantidad: 1,
            precioUnitario: obrasAdicionales,
            subtotal: obrasAdicionales,
            costoOriginal: obrasAdicionales,
            rentabilidadAplicada: 0, // Sin rentabilidad
          });
        }
        
        // Agregar andamios si se requieren (sin rentabilidad)
        if (requiereAndamios && metrajeAndamio > 0) {
          // Precio estimado por metro de andamio (ajustar seg√∫n necesidad)
          const precioMetroAndamio = 50000; // COP por metro
          const costoAndamios = metrajeAndamio * precioMetroAndamio;
          itemsCotizacion.push({
            descripcion: `Andamios (${metrajeAndamio} m)`,
            cantidad: 1,
            precioUnitario: costoAndamios,
            subtotal: costoAndamios,
            costoOriginal: costoAndamios,
            rentabilidadAplicada: 0, // Sin rentabilidad
          });
        }
        
        // Agregar p√≥lizas si se requieren (con rentabilidad sobre el subtotal actual)
        if (polizas) {
          // Precio estimado de p√≥lizas (ajustar seg√∫n necesidad)
          const costoPolizas = subtotalEquipos * 0.02; // 2% del subtotal de equipos
          const precioPolizasConRentabilidad = costoPolizas / (1 - rentabilidadTotal);
          itemsCotizacion.push({
            descripcion: 'P√≥lizas',
            cantidad: 1,
            precioUnitario: precioPolizasConRentabilidad,
            subtotal: precioPolizasConRentabilidad,
            costoOriginal: costoPolizas,
            rentabilidadAplicada: rentabilidadTotal,
          });
        }
        
        // Agregar SST si se requiere (con rentabilidad sobre el subtotal actual)
        if (sst) {
          // Precio estimado de SST (ajustar seg√∫n necesidad)
          const costoSST = subtotalEquipos * 0.01; // 1% del subtotal de equipos
          const precioSSTConRentabilidad = costoSST / (1 - rentabilidadTotal);
          itemsCotizacion.push({
            descripcion: 'SST (Seguridad y Salud en el Trabajo)',
            cantidad: 1,
            precioUnitario: precioSSTConRentabilidad,
            subtotal: precioSSTConRentabilidad,
            costoOriginal: costoSST,
            rentabilidadAplicada: rentabilidadTotal,
          });
        }
        
        // Calcular subtotal antes de comisi√≥n adicional
        let subtotal = itemsCotizacion.reduce((sum, item) => sum + item.subtotal, 0);
        
        // Calcular comisi√≥n adicional sobre el subtotal (en %)
        const comisionAdicionalValor = comisionAdicionalPorcentaje > 0 
          ? subtotal * (comisionAdicionalPorcentaje / 100)
          : 0;
        
        // Agregar comisi√≥n adicional como item si existe
        if (comisionAdicionalValor > 0) {
          itemsCotizacion.push({
            descripcion: `Comisi√≥n Adicional (${comisionAdicionalPorcentaje}%)`,
            cantidad: 1,
            precioUnitario: comisionAdicionalValor,
            subtotal: comisionAdicionalValor,
            costoOriginal: comisionAdicionalValor,
            rentabilidadAplicada: 0, // Sin rentabilidad adicional
          });
          subtotal += comisionAdicionalValor;
        }
        
        const iva = subtotal * 0.19;
        const total = subtotal + iva;
        
        // Calcular an√°lisis seg√∫n modelo de negocio
        let analisisFinanciero = null;
        let impactoAmbiental = null;
        let resultadoPPA = null;
        
        if (tipoSistema === 'on-grid' || tipoSistema === 'hibrido') {
          if (modeloNegocio === 'ppa') {
            // Modelo PPA: Sin inversi√≥n inicial
            try {
              const duracionContrato = parseInt(document.getElementById('duracionContratoPPA')?.value || '12');
              
              resultadoPPA = calcularSistemaPPA({
                capex: total,
                generacionAnual: generacionAnual,
                tarifaElectrica: tarifaElectrica,
                porcentajeAutoconsumo: porcentajeAutoconsumo / 100,
                duracionContrato: duracionContrato,
              });
              
              // Calcular impacto ambiental
              impactoAmbiental = calcularImpactoAmbiental(generacionAnual);
            } catch (error) {
              console.error('Error al cargar c√°lculos PPA:', error);
            }
          } else {
            // Modelo EPC: Con inversi√≥n inicial
            try {
              analisisFinanciero = calcularAnalisisFinanciero(total, ahorroAnual);
              impactoAmbiental = calcularImpactoAmbiental(generacionAnual);
            } catch (error) {
              console.error('Error al cargar an√°lisis financiero:', error);
            }
          }
        }
        
        // Mostrar resultados y cotizaci√≥n
        resultadosContenido.innerHTML = `
          <div class="rentabilidad-control" style="margin-bottom: 2rem; padding: 1.5rem; background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px;">
            <h4 style="margin-top: 0; color: #1e40af;">
              <i class="fas fa-percentage"></i> Control de Rentabilidad
            </h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; align-items: end;">
              <div>
                <label for="rentabilidadAdicional" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1f2937;">
                  Rentabilidad Adicional (%)
                </label>
                <input 
                  type="number" 
                  id="rentabilidadAdicional" 
                  class="form-input" 
                  min="0" 
                  max="50" 
                  value="${(rentabilidadAdicional * 100).toFixed(2)}"
                  step="0.1"
                  style="width: 100%; padding: 0.75rem; border: 2px solid #0ea5e9; border-radius: 8px; font-size: 1.1rem;"
                >
                <small style="display: block; margin-top: 0.25rem; color: #6b7280;">
                  Rentabilidad m√≠nima: 20% (fija)
                </small>
              </div>
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1f2937;">
                  Rentabilidad Total
                </label>
                <div style="padding: 0.75rem; background: white; border: 2px solid #0ea5e9; border-radius: 8px; font-size: 1.1rem; font-weight: 700; color: #0ea5e9;">
                  ${(rentabilidadTotal * 100).toFixed(2)}%
                </div>
              </div>
              <div>
                <button 
                  id="btnRecalcularRentabilidad" 
                  class="btn-primary"
                  style="width: 100%; padding: 0.75rem; background: #0ea5e9; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;"
                >
                  <i class="fas fa-sync-alt"></i> Recalcular Precios
                </button>
              </div>
            </div>
            <div style="margin-top: 1rem; padding: 1rem; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 6px;">
              <small style="color: #92400e;">
                <i class="fas fa-info-circle"></i> 
                La rentabilidad se aplica a todos los equipos. Precio = Costo / (1 - Rentabilidad). 
                Luego se aplica IVA del 19%.
              </small>
            </div>
          </div>
          
          <div class="resultado-card">
            <h3><i class="fas fa-calculator"></i> Resultados del C√°lculo</h3>
            <div class="resultado-grid">
              <div class="resultado-item">
                <span class="resultado-label">Estaci√≥n Meteorol√≥gica</span>
                <span class="resultado-value">${estacionMeteorologica || ciudad}</span>
              </div>
              <div class="resultado-item">
                <span class="resultado-label">Potencia Necesaria</span>
                <span class="resultado-value">${potenciaNecesaria.toFixed(2)} kWp</span>
              </div>
              <div class="resultado-item">
                <span class="resultado-label">Cantidad de Paneles</span>
                <span class="resultado-value">${cantidadPaneles} unidades</span>
              </div>
              <div class="resultado-item">
                <span class="resultado-label">Potencia Instalada</span>
                <span class="resultado-value">${potenciaInstalada.toFixed(2)} kWp</span>
              </div>
              <div class="resultado-item">
                <span class="resultado-label">Generaci√≥n Anual</span>
                <span class="resultado-value">${generacionAnual.toFixed(0)} kWh/a√±o</span>
              </div>
              <div class="resultado-item">
                <span class="resultado-label">Ahorro Anual</span>
                <span class="resultado-value highlight">${formatCOP(ahorroAnual)}</span>
              </div>
              <div class="resultado-item">
                <span class="resultado-label">Energ√≠a Autoconsumo</span>
                <span class="resultado-value">${energiaAutoconsumo.toFixed(0)} kWh/a√±o</span>
              </div>
              <div class="resultado-item">
                <span class="resultado-label">Energ√≠a Excedente</span>
                <span class="resultado-value">${energiaExcedente.toFixed(0)} kWh/a√±o</span>
              </div>
            </div>
          </div>
          
          ${resultadoPPA ? `
          <div class="resultado-card ppa-resultados-card">
            <h3><i class="fas fa-handshake"></i> Resultados PPA (Power Purchase Agreement)</h3>
            <div class="ppa-info-banner">
              <i class="fas fa-info-circle"></i>
              <span>Sin inversi√≥n inicial. Compra de energ√≠a a precio fijo durante ${document.getElementById('duracionContratoPPA')?.value || '12'} a√±os.</span>
            </div>
            <div class="ppa-precios-grid">
              <div class="ppa-precio-item">
                <span class="ppa-precio-label">Precio PPA (10 a√±os)</span>
                <span class="ppa-precio-value">${formatCOP(resultadoPPA.precioPPA['10'])} /kWh</span>
              </div>
              <div class="ppa-precio-item">
                <span class="ppa-precio-label">Precio PPA (12 a√±os)</span>
                <span class="ppa-precio-value highlight">${formatCOP(resultadoPPA.precioPPA['12'])} /kWh</span>
              </div>
              <div class="ppa-precio-item">
                <span class="ppa-precio-label">Precio PPA (15 a√±os)</span>
                <span class="ppa-precio-value">${formatCOP(resultadoPPA.precioPPA['15'])} /kWh</span>
              </div>
            </div>
            <div class="ppa-ahorros-grid">
              <div class="ppa-ahorro-item">
                <span class="ppa-ahorro-label">Ahorro Anual (10 a√±os)</span>
                <span class="ppa-ahorro-value">${formatCOP(resultadoPPA.ahorroAnual['10'])}</span>
              </div>
              <div class="ppa-ahorro-item">
                <span class="ppa-ahorro-label">Ahorro Anual (12 a√±os)</span>
                <span class="ppa-ahorro-value highlight">${formatCOP(resultadoPPA.ahorroAnual['12'])}</span>
              </div>
              <div class="ppa-ahorro-item">
                <span class="ppa-ahorro-label">Ahorro Anual (15 a√±os)</span>
                <span class="ppa-ahorro-value">${formatCOP(resultadoPPA.ahorroAnual['15'])}</span>
              </div>
            </div>
            <div class="ppa-cuotas-grid">
              <div class="ppa-cuota-item">
                <span class="ppa-cuota-label">Cuota Mensual (10 a√±os)</span>
                <span class="ppa-cuota-value">${formatCOP(resultadoPPA.cuotaMensual['10'])}</span>
              </div>
              <div class="ppa-cuota-item">
                <span class="ppa-cuota-label">Cuota Mensual (12 a√±os)</span>
                <span class="ppa-cuota-value highlight">${formatCOP(resultadoPPA.cuotaMensual['12'])}</span>
              </div>
              <div class="ppa-cuota-item">
                <span class="ppa-cuota-label">Cuota Mensual (15 a√±os)</span>
                <span class="ppa-cuota-value">${formatCOP(resultadoPPA.cuotaMensual['15'])}</span>
              </div>
            </div>
            <div id="graficaFlujoCajaPPA" style="margin-top: 2rem; height: 300px;">
              <canvas id="canvasFlujoCajaPPA"></canvas>
            </div>
            ${resultadoPPA.metricasInversionista ? `
            <div class="ppa-inversionista-metricas">
              <h4>M√©tricas para Inversionistas</h4>
              <div class="ppa-metricas-grid">
                <div class="ppa-metrica-item highlight">
                  <span class="ppa-metrica-label">TIR</span>
                  <span class="ppa-metrica-value">${(resultadoPPA.metricasInversionista.tir * 100).toFixed(2)}%</span>
                </div>
                <div class="ppa-metrica-item">
                  <span class="ppa-metrica-label">VAN</span>
                  <span class="ppa-metrica-value">${formatCOP(resultadoPPA.metricasInversionista.van)}</span>
                </div>
                <div class="ppa-metrica-item">
                  <span class="ppa-metrica-label">ROI</span>
                  <span class="ppa-metrica-value">${resultadoPPA.metricasInversionista.roi.toFixed(2)}%</span>
                </div>
                <div class="ppa-metrica-item">
                  <span class="ppa-metrica-label">Payback Period</span>
                  <span class="ppa-metrica-value">${resultadoPPA.metricasInversionista.paybackPeriod.toFixed(1)} a√±os</span>
                </div>
                <div class="ppa-metrica-item">
                  <span class="ppa-metrica-label">Ingreso Total</span>
                  <span class="ppa-metrica-value">${formatCOP(resultadoPPA.metricasInversionista.ingresoTotal)}</span>
                </div>
                <div class="ppa-metrica-item">
                  <span class="ppa-metrica-label">Ingreso Promedio Anual</span>
                  <span class="ppa-metrica-value">${formatCOP(resultadoPPA.metricasInversionista.ingresoPromedioAnual)}</span>
                </div>
                <div class="ppa-metrica-item">
                  <span class="ppa-metrica-label">Margen Bruto</span>
                  <span class="ppa-metrica-value">${resultadoPPA.metricasInversionista.margenBruto.toFixed(2)}%</span>
                </div>
                <div class="ppa-metrica-item">
                  <span class="ppa-metrica-label">Margen Neto</span>
                  <span class="ppa-metrica-value">${resultadoPPA.metricasInversionista.margenNeto.toFixed(2)}%</span>
                </div>
                <div class="ppa-metrica-item">
                  <span class="ppa-metrica-label">LCOE</span>
                  <span class="ppa-metrica-value">${formatCOP(resultadoPPA.metricasInversionista.lcoe)} /kWh</span>
                </div>
              </div>
              
              <div class="ppa-comparativa-escenarios">
                <h5>Comparativa de Escenarios</h5>
                <table class="ppa-escenarios-table">
                  <thead>
                    <tr>
                      <th>Duraci√≥n</th>
                      <th>Precio PPA</th>
                      <th>TIR</th>
                      <th>VAN</th>
                      <th>Ingreso Total</th>
                      <th>Margen Bruto</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>10 a√±os</td>
                      <td>${formatCOP(resultadoPPA.metricasInversionista.comparativaEscenarios['10'].precioPPA)} /kWh</td>
                      <td>${(resultadoPPA.metricasInversionista.comparativaEscenarios['10'].tir * 100).toFixed(2)}%</td>
                      <td>${formatCOP(resultadoPPA.metricasInversionista.comparativaEscenarios['10'].van)}</td>
                      <td>${formatCOP(resultadoPPA.metricasInversionista.comparativaEscenarios['10'].ingresoTotal)}</td>
                      <td>${resultadoPPA.metricasInversionista.comparativaEscenarios['10'].margenBruto.toFixed(2)}%</td>
                    </tr>
                    <tr>
                      <td>12 a√±os</td>
                      <td>${formatCOP(resultadoPPA.metricasInversionista.comparativaEscenarios['12'].precioPPA)} /kWh</td>
                      <td>${(resultadoPPA.metricasInversionista.comparativaEscenarios['12'].tir * 100).toFixed(2)}%</td>
                      <td>${formatCOP(resultadoPPA.metricasInversionista.comparativaEscenarios['12'].van)}</td>
                      <td>${formatCOP(resultadoPPA.metricasInversionista.comparativaEscenarios['12'].ingresoTotal)}</td>
                      <td>${resultadoPPA.metricasInversionista.comparativaEscenarios['12'].margenBruto.toFixed(2)}%</td>
                    </tr>
                    <tr>
                      <td>15 a√±os</td>
                      <td>${formatCOP(resultadoPPA.metricasInversionista.comparativaEscenarios['15'].precioPPA)} /kWh</td>
                      <td>${(resultadoPPA.metricasInversionista.comparativaEscenarios['15'].tir * 100).toFixed(2)}%</td>
                      <td>${formatCOP(resultadoPPA.metricasInversionista.comparativaEscenarios['15'].van)}</td>
                      <td>${formatCOP(resultadoPPA.metricasInversionista.comparativaEscenarios['15'].ingresoTotal)}</td>
                      <td>${resultadoPPA.metricasInversionista.comparativaEscenarios['15'].margenBruto.toFixed(2)}%</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            ` : ''}
          </div>
          ` : ''}
          
          ${analisisFinanciero ? `
          <div class="resultado-card analisis-financiero-card">
            <h3><i class="fas fa-chart-line"></i> An√°lisis Financiero (EPC)</h3>
            <div class="analisis-grid">
              <div class="analisis-item">
                <span class="analisis-label">A√±os de Recuperaci√≥n</span>
                <span class="analisis-value">${analisisFinanciero.a√±osRecuperacion.toFixed(1)} a√±os</span>
              </div>
              <div class="analisis-item">
                <span class="analisis-label">TIR (Tasa Interna de Retorno)</span>
                <span class="analisis-value">${(analisisFinanciero.tir * 100).toFixed(2)}%</span>
              </div>
              <div class="analisis-item">
                <span class="analisis-label">VAN (Valor Actual Neto)</span>
                <span class="analisis-value">${formatCOP(analisisFinanciero.van)}</span>
              </div>
              <div class="analisis-item">
                <span class="analisis-label">ROI (Retorno de Inversi√≥n)</span>
                <span class="analisis-value highlight">${analisisFinanciero.roi.toFixed(1)}%</span>
              </div>
              <div class="analisis-item">
                <span class="analisis-label">Ahorro Total 25 A√±os</span>
                <span class="analisis-value highlight">${formatCOP(analisisFinanciero.ahorroTotal25Anos)}</span>
              </div>
            </div>
            <div id="graficaFlujoCaja" style="margin-top: 2rem; height: 300px;">
              <canvas id="canvasFlujoCaja"></canvas>
            </div>
          </div>
          ` : ''}
          
          ${impactoAmbiental ? `
          <div class="resultado-card impacto-ambiental-card">
            <h3><i class="fas fa-leaf"></i> Impacto Ambiental</h3>
            <div class="impacto-grid">
              <div class="impacto-item">
                <span class="impacto-label">CO‚ÇÇ Evitado (Anual)</span>
                <span class="impacto-value">${(impactoAmbiental.co2EvitadoAnual / 1000).toFixed(2)} ton CO‚ÇÇ/a√±o</span>
              </div>
              <div class="impacto-item">
                <span class="impacto-label">CO‚ÇÇ Evitado (25 a√±os)</span>
                <span class="impacto-value">${(impactoAmbiental.co2Evitado25Anos / 1000).toFixed(2)} ton CO‚ÇÇ</span>
              </div>
              <div class="impacto-item">
                <span class="impacto-label">Equivalente a √Årboles</span>
                <span class="impacto-value">${impactoAmbiental.equivalenteArboles.toFixed(0)} √°rboles</span>
              </div>
              <div class="impacto-item">
                <span class="impacto-label">Equivalente a Autos</span>
                <span class="impacto-value">${impactoAmbiental.equivalenteAutos.toFixed(1)} autos</span>
              </div>
            </div>
          </div>
          ` : ''}
          
          <!-- Selector de Vista -->
          <div class="vista-selector">
            <button id="btnVistaComercial" class="btn-vista active" data-vista="comercial">
              <i class="fas fa-file-invoice-dollar"></i> Vista Comercial
            </button>
            <button id="btnVistaTecnica" class="btn-vista" data-vista="tecnica">
              <i class="fas fa-cogs"></i> Vista T√©cnica
            </button>
          </div>
          
          <!-- Vista Comercial -->
          <div id="vistaComercial" class="vista-contenido">
            <div class="resultado-card cotizacion-card">
              <h3><i class="fas fa-file-invoice-dollar"></i> Cotizaci√≥n Comercial</h3>
              <div class="resumen-comercial">
                <div class="resumen-item">
                  <span class="resumen-label">Potencia Instalada</span>
                  <span class="resumen-value">${potenciaInstalada.toFixed(2)} kWp</span>
                </div>
                <div class="resumen-item">
                  <span class="resumen-label">Generaci√≥n Anual</span>
                  <span class="resumen-value">${generacionAnual.toFixed(0)} kWh/a√±o</span>
                </div>
                <div class="resumen-item highlight">
                  <span class="resumen-label">Ahorro Anual Estimado</span>
                  <span class="resumen-value">${formatCOP(ahorroAnual)}</span>
                </div>
                ${modeloNegocio === 'epc' && analisisFinanciero ? `
                <div class="resumen-item">
                  <span class="resumen-label">A√±os de Recuperaci√≥n</span>
                  <span class="resumen-value">${analisisFinanciero.a√±osRecuperacion.toFixed(1)} a√±os</span>
                </div>
                ` : ''}
              </div>
              
              <table class="cotizacion-table">
                <thead>
                  <tr>
                    <th>Descripci√≥n</th>
                    <th>Cant.</th>
                    <th>Precio Unit.</th>
                    <th>Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                ${itemsCotizacion.map(item => `
                  <tr>
                    <td>${item.descripcion}</td>
                    <td>${item.cantidad}</td>
                    <td data-costo-original="${item.costoOriginal || item.precioUnitario}">${formatCOP(item.precioUnitario)}</td>
                    <td>${formatCOP(item.subtotal)}</td>
                  </tr>
                `).join('')}
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="3"><strong>Subtotal</strong></td>
                    <td><strong>${formatCOP(subtotal)}</strong></td>
                  </tr>
                  <tr>
                    <td colspan="3"><strong>IVA (19%)</strong></td>
                    <td><strong>${formatCOP(iva)}</strong></td>
                  </tr>
                  <tr class="total-row">
                    <td colspan="3"><strong>TOTAL</strong></td>
                    <td><strong class="total-value">${formatCOP(total)}</strong></td>
                  </tr>
                </tfoot>
              </table>
              
              <div class="cotizacion-actions">
                <button id="btnEnviarWhatsApp" class="btn-whatsapp">
                  <i class="fab fa-whatsapp"></i>
                  Enviar por WhatsApp
                </button>
                <button id="btnGuardarCotizacion" class="btn-save">
                  <i class="fas fa-save"></i>
                  Guardar Cotizaci√≥n
                </button>
              </div>
            </div>
          </div>
          
          <!-- Vista T√©cnica -->
          <div id="vistaTecnica" class="vista-contenido" style="display: none;">
            <div class="tecnica-card">
              <h3>Vista T√©cnica Detallada</h3>
              
              <!-- Datos de Entrada -->
              <div class="tecnica-section">
                <h4><i class="fas fa-edit"></i> Datos de Entrada</h4>
                <div class="tecnica-grid">
                  <div class="tecnica-item">
                    <span class="tecnica-label">Tipo de Sistema</span>
                    <span class="tecnica-value">${tipoSistema === 'on-grid' ? 'On-Grid' : tipoSistema === 'off-grid' ? 'Off-Grid' : 'H√≠brido'}</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">Modelo de Negocio</span>
                    <span class="tecnica-value">${modeloNegocio === 'epc' ? 'EPC (Inversi√≥n Total)' : 'PPA (Sin Inversi√≥n Inicial)'}</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">Ciudad</span>
                    <span class="tecnica-value">${ciudad}, ${departamento}</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">Estaci√≥n Meteorol√≥gica</span>
                    <span class="tecnica-value">${estacionMeteorologica || ciudad}</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">HSP (Horas Sol Pico)</span>
                    <span class="tecnica-value">${hsp.toFixed(2)} kWh/m¬≤/d√≠a</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">Consumo Anual</span>
                    <span class="tecnica-value">${consumoAnual.toFixed(0)} kWh/a√±o</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">Costo kWh Base / Tarifa El√©ctrica</span>
                    <span class="tecnica-value">${formatCOP(tarifaElectrica)} /kWh</span>
                  </div>
                  ${comisionAdicionalPorcentaje > 0 ? `
                  <div class="tecnica-item">
                    <span class="tecnica-label">Comisi√≥n Adicional</span>
                    <span class="tecnica-value">${comisionAdicionalPorcentaje}% (${formatCOP(comisionAdicionalValor)})</span>
                    <small class="tecnica-formula">${comisionAdicionalPorcentaje}% sobre subtotal de equipos</small>
                  </div>
                  ` : ''}
                  ${tipoCubierta ? `
                  <div class="tecnica-item">
                    <span class="tecnica-label">Tipo de Cubierta</span>
                    <span class="tecnica-value">${infoCubierta ? infoCubierta.nombre : tipoCubierta}</span>
                  </div>
                  ` : ''}
                </div>
              </div>
              
              <!-- C√°lculos T√©cnicos -->
              <div class="tecnica-section">
                <h4><i class="fas fa-calculator"></i> C√°lculos T√©cnicos Detallados</h4>
                
                ${tipoSistema === 'on-grid' || tipoSistema === 'hibrido' ? `
                <!-- C√°lculos On-Grid -->
                <!-- Tabla de C√°lculos (Formato Excel) -->
                <div class="calculo-paso">
                  <h5><i class="fas fa-table"></i> Tabla de C√°lculos del Sistema</h5>
                  <table class="tecnica-table excel-style calculos-table">
                    <thead>
                      <tr>
                        <th>Concepto</th>
                        <th>Valor</th>
                        <th>Unidad</th>
                        <th>F√≥rmula</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td><strong>Consumo Anual</strong></td>
                        <td>${consumoAnual.toFixed(2)}</td>
                        <td>kWh/a√±o</td>
                        <td>Suma de consumos mensuales √ó 12</td>
                      </tr>
                      <tr>
                        <td><strong>Consumo Diario</strong></td>
                        <td>${(consumoAnual / 365).toFixed(3)}</td>
                        <td>kWh/d√≠a</td>
                        <td>Consumo Anual √∑ 365 d√≠as</td>
                      </tr>
                      <tr>
                        <td><strong>Porcentaje a Suplir</strong></td>
                        <td>${porcentajeAhorroPorcentaje}%</td>
                        <td>%</td>
                        <td>Porcentaje del consumo a cubrir</td>
                      </tr>
                      <tr>
                        <td><strong>Consumo a Suplir</strong></td>
                        <td>${((consumoAnual / 365) * porcentajeAhorro).toFixed(3)}</td>
                        <td>kWh/d√≠a</td>
                        <td>Consumo Diario √ó Porcentaje a Suplir</td>
                      </tr>
                      <tr>
                        <td><strong>HSP (Horas Sol Pico)</strong></td>
                        <td>${hsp.toFixed(3)}</td>
                        <td>kWh/m¬≤/d√≠a</td>
                        <td>Seg√∫n estaci√≥n meteorol√≥gica: ${estacionMeteorologica || ciudad}</td>
                      </tr>
                      <tr>
                        <td><strong>P√©rdidas Adicionales</strong></td>
                        <td>${eficienciaOptimo.toFixed(3)}</td>
                        <td>-</td>
                        <td>Eficiencia con respecto al √≥ptimo</td>
                      </tr>
                      <tr>
                        <td><strong>Factor de P√©rdidas</strong></td>
                        <td>0.820</td>
                        <td>-</td>
                        <td>Factor fijo (p√©rdidas por sombras, suciedad, etc.)</td>
                      </tr>
                      <tr>
                        <td><strong>Eficiencia Inversor</strong></td>
                        <td>0.970</td>
                        <td>-</td>
                        <td>Eficiencia del inversor (fijo)</td>
                      </tr>
                      <tr class="highlight-row">
                        <td><strong>Factor Combinado</strong></td>
                        <td>${(eficienciaOptimo * 0.82 * 0.97).toFixed(4)}</td>
                        <td>-</td>
                        <td>P√©rdidas Adicionales √ó Factor P√©rdidas √ó Eficiencia Inversor</td>
                      </tr>
                      <tr class="highlight-row">
                        <td><strong>Potencia Necesaria</strong></td>
                        <td>${potenciaNecesaria.toFixed(3)}</td>
                        <td>kWp</td>
                        <td>Consumo a Suplir √∑ (HSP √ó Factor Combinado)</td>
                      </tr>
                      <tr>
                        <td><strong>Panel Seleccionado</strong></td>
                        <td>${panel ? `${panel.marca} ${panel.modelo || ''}` : 'N/A'}</td>
                        <td>-</td>
                        <td>-</td>
                      </tr>
                      <tr>
                        <td><strong>Potencia Panel</strong></td>
                        <td>${panel ? panel.potencia : 0}</td>
                        <td>W</td>
                        <td>-</td>
                      </tr>
                      <tr>
                        <td><strong>Cantidad de Paneles</strong></td>
                        <td>${cantidadPaneles}</td>
                        <td>unidades</td>
                        <td>ROUND(Potencia Necesaria √ó 1000 √∑ Potencia Panel)</td>
                      </tr>
                      <tr class="highlight-row">
                        <td><strong>Potencia Instalada</strong></td>
                        <td>${potenciaInstalada.toFixed(3)}</td>
                        <td>kWp</td>
                        <td>Cantidad Paneles √ó Potencia Panel</td>
                      </tr>
                      ${inversor ? `
                      <tr>
                        <td><strong>Inversor Seleccionado</strong></td>
                        <td>${inversor.marca} ${inversor.modelo || ''}</td>
                        <td>-</td>
                        <td>-</td>
                      </tr>
                      <tr>
                        <td><strong>Potencia Inversor</strong></td>
                        <td>${inversor.potencia}</td>
                        <td>kW</td>
                        <td>-</td>
                      </tr>
                      <tr>
                        <td><strong>Cantidad de Inversores</strong></td>
                        <td>${Math.ceil(potenciaInstalada / inversor.potencia)}</td>
                        <td>unidades</td>
                        <td>ROUNDUP(Potencia Instalada √∑ Potencia Inversor)</td>
                      </tr>
                      ` : ''}
                      <tr class="highlight-row">
                        <td><strong>Generaci√≥n Anual</strong></td>
                        <td>${generacionAnual.toFixed(2)}</td>
                        <td>kWh/a√±o</td>
                        <td>Potencia Instalada √ó HSP √ó 365 √ó Factor Combinado</td>
                      </tr>
                      <tr>
                        <td><strong>√çndice de Producci√≥n</strong></td>
                        <td>${(generacionAnual / potenciaInstalada).toFixed(2)}</td>
                        <td>kWh/kWp</td>
                        <td>Generaci√≥n Anual √∑ Potencia Instalada</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                
                <div class="calculo-paso">
                  <h5><i class="fas fa-list-ol"></i> Paso 1: Consumo</h5>
                  <div class="tecnica-grid">
                    <div class="tecnica-item">
                      <span class="tecnica-label">Consumo Anual</span>
                      <span class="tecnica-value">${consumoAnual.toFixed(2)} kWh/a√±o</span>
                      <small class="tecnica-formula">Suma de consumos mensuales √ó 12</small>
                    </div>
                    <div class="tecnica-item">
                      <span class="tecnica-label">Consumo Diario</span>
                      <span class="tecnica-value">${(consumoAnual / 365).toFixed(3)} kWh/d√≠a</span>
                      <small class="tecnica-formula">Consumo Anual √∑ 365 d√≠as</small>
                    </div>
                    <div class="tecnica-item">
                      <span class="tecnica-label">Porcentaje a Suplir</span>
                      <span class="tecnica-value">${porcentajeAhorroPorcentaje}%</span>
                      <small class="tecnica-formula">Porcentaje del consumo a cubrir</small>
                    </div>
                    <div class="tecnica-item">
                      <span class="tecnica-label">Consumo a Suplir</span>
                      <span class="tecnica-value">${((consumoAnual / 365) * porcentajeAhorro).toFixed(3)} kWh/d√≠a</span>
                      <small class="tecnica-formula">Consumo Diario √ó Porcentaje a Suplir</small>
                    </div>
                  </div>
                </div>
                
                <div class="calculo-paso">
                  <h5><i class="fas fa-sun"></i> Paso 2: Radiaci√≥n Solar</h5>
                  <div class="tecnica-grid">
                    <div class="tecnica-item">
                      <span class="tecnica-label">HSP (Horas Sol Pico)</span>
                      <span class="tecnica-value">${hsp.toFixed(3)} kWh/m¬≤/d√≠a</span>
                      <small class="tecnica-formula">Seg√∫n estaci√≥n meteorol√≥gica: ${estacionMeteorologica || ciudad}</small>
                    </div>
                  </div>
                </div>
                
                <div class="calculo-paso">
                  <h5><i class="fas fa-cog"></i> Paso 3: Factores de Eficiencia</h5>
                  <div class="tecnica-grid">
                    <div class="tecnica-item">
                      <span class="tecnica-label">P√©rdidas Adicionales</span>
                      <span class="tecnica-value">${eficienciaOptimo.toFixed(3)}</span>
                      <small class="tecnica-formula">Eficiencia con respecto al √≥ptimo (desde entrada)</small>
                    </div>
                    <div class="tecnica-item">
                      <span class="tecnica-label">Factor de P√©rdidas</span>
                      <span class="tecnica-value">0.820</span>
                      <small class="tecnica-formula">Factor fijo (p√©rdidas por sombras, suciedad, etc.)</small>
                    </div>
                    <div class="tecnica-item">
                      <span class="tecnica-label">Eficiencia Inversor</span>
                      <span class="tecnica-value">0.970</span>
                      <small class="tecnica-formula">Eficiencia del inversor (fijo)</small>
                    </div>
                    <div class="tecnica-item highlight">
                      <span class="tecnica-label">Factor Combinado</span>
                      <span class="tecnica-value">${(eficienciaOptimo * 0.82 * 0.97).toFixed(4)}</span>
                      <small class="tecnica-formula">P√©rdidas Adicionales √ó Factor P√©rdidas √ó Eficiencia Inversor</small>
                    </div>
                  </div>
                </div>
                
                <div class="calculo-paso">
                  <h5><i class="fas fa-bolt"></i> Paso 4: Potencia Necesaria</h5>
                  <div class="tecnica-grid">
                    <div class="tecnica-item highlight">
                      <span class="tecnica-label">Potencia Necesaria</span>
                      <span class="tecnica-value">${potenciaNecesaria.toFixed(3)} kWp</span>
                      <small class="tecnica-formula">Consumo a Suplir √∑ (HSP √ó P√©rdidas Adicionales √ó Factor P√©rdidas √ó Eficiencia Inversor)</small>
                      <small class="tecnica-formula-detalle">= ${((consumoAnual / 365) * porcentajeAhorro).toFixed(3)} √∑ (${hsp.toFixed(3)} √ó ${eficienciaOptimo.toFixed(3)} √ó 0.82 √ó 0.97)</small>
                      <small class="tecnica-formula-detalle">= ${((consumoAnual / 365) * porcentajeAhorro).toFixed(3)} √∑ ${(hsp * eficienciaOptimo * 0.82 * 0.97).toFixed(4)}</small>
                    </div>
                  </div>
                </div>
                
                <div class="calculo-paso">
                  <h5><i class="fas fa-solar-panel"></i> Paso 5: Dimensionamiento de Paneles</h5>
                  <div class="tecnica-grid">
                    <div class="tecnica-item">
                      <span class="tecnica-label">Panel Seleccionado</span>
                      <span class="tecnica-value">${panel ? `${panel.marca} ${panel.modelo || ''} - ${panel.potencia}W` : 'N/A'}</span>
                    </div>
                    <div class="tecnica-item">
                      <span class="tecnica-label">Potencia Panel</span>
                      <span class="tecnica-value">${panel ? (panel.potencia / 1000).toFixed(3) : 0} kW</span>
                      <small class="tecnica-formula">${panel ? panel.potencia : 0}W √∑ 1000</small>
                    </div>
                    <div class="tecnica-item">
                      <span class="tecnica-label">Cantidad de Paneles</span>
                      <span class="tecnica-value">${cantidadPaneles} unidades</span>
                      <small class="tecnica-formula">ROUND(Potencia Necesaria √ó 1000 √∑ Potencia Panel)</small>
                      <small class="tecnica-formula-detalle">= ROUND(${potenciaNecesaria.toFixed(3)} √ó 1000 √∑ ${panel ? panel.potencia : 0})</small>
                    </div>
                    <div class="tecnica-item highlight">
                      <span class="tecnica-label">Potencia Instalada</span>
                      <span class="tecnica-value">${potenciaInstalada.toFixed(3)} kWp</span>
                      <small class="tecnica-formula">Cantidad Paneles √ó Potencia Panel</small>
                      <small class="tecnica-formula-detalle">= ${cantidadPaneles} √ó ${panel ? (panel.potencia / 1000).toFixed(3) : 0} kW</small>
                    </div>
                  </div>
                </div>
                
                ${inversor ? `
                <div class="calculo-paso">
                  <h5><i class="fas fa-plug"></i> Paso 6: Dimensionamiento de Inversor</h5>
                  <div class="tecnica-grid">
                    <div class="tecnica-item">
                      <span class="tecnica-label">Inversor Seleccionado</span>
                      <span class="tecnica-value">${inversor.marca} ${inversor.modelo || ''} - ${inversor.potencia}kW</span>
                    </div>
                    <div class="tecnica-item">
                      <span class="tecnica-label">Potencia Inversor</span>
                      <span class="tecnica-value">${inversor.potencia} kW</span>
                    </div>
                    <div class="tecnica-item">
                      <span class="tecnica-label">Cantidad de Inversores</span>
                      <span class="tecnica-value">${Math.ceil(potenciaInstalada / inversor.potencia)} unidades</span>
                      <small class="tecnica-formula">ROUNDUP(Potencia Instalada √∑ Potencia Inversor)</small>
                    </div>
                  </div>
                </div>
                ` : ''}
                
                <div class="calculo-paso">
                  <h5><i class="fas fa-chart-line"></i> Paso 7: Generaci√≥n de Energ√≠a</h5>
                  <div class="tecnica-grid">
                    <div class="tecnica-item highlight">
                      <span class="tecnica-label">Generaci√≥n Anual</span>
                      <span class="tecnica-value">${generacionAnual.toFixed(2)} kWh/a√±o</span>
                      <small class="tecnica-formula">Potencia Instalada √ó HSP √ó 365 √ó P√©rdidas Adicionales √ó Factor P√©rdidas √ó Eficiencia Inversor</small>
                      <small class="tecnica-formula-detalle">= ${potenciaInstalada.toFixed(3)} √ó ${hsp.toFixed(3)} √ó 365 √ó ${eficienciaOptimo.toFixed(3)} √ó 0.82 √ó 0.97</small>
                    </div>
                    <div class="tecnica-item">
                      <span class="tecnica-label">√çndice de Producci√≥n</span>
                      <span class="tecnica-value">${(generacionAnual / potenciaInstalada).toFixed(2)} kWh/kWp</span>
                      <small class="tecnica-formula">Generaci√≥n Anual √∑ Potencia Instalada</small>
                    </div>
                  </div>
                </div>
                ` : ''}
                
                ${tipoSistema === 'off-grid' ? `
                <!-- C√°lculos Off-Grid -->
                <div class="calculo-paso">
                  <h5><i class="fas fa-battery-full"></i> Paso 1: Capacidad de Bater√≠a</h5>
                  <div class="tecnica-grid">
                    <div class="tecnica-item">
                      <span class="tecnica-label">Consumo Diario Total</span>
                      <span class="tecnica-value">${consumoDiario.toFixed(2)} Wh/d√≠a</span>
                      <small class="tecnica-formula">Suma de consumos de todos los equipos</small>
                    </div>
                    <div class="tecnica-item">
                      <span class="tecnica-label">Eficiencia Inversor Off-Grid</span>
                      <span class="tecnica-value">${eficienciaInversorOffGrid.toFixed(3)}</span>
                      <small class="tecnica-formula">Eficiencia del inversor (desde entrada)</small>
                    </div>
                    <div class="tecnica-item">
                      <span class="tecnica-label">Eficiencia Bater√≠a</span>
                      <span class="tecnica-value">${eficienciaBateria.toFixed(3)}</span>
                      <small class="tecnica-formula">Eficiencia de la bater√≠a (desde entrada)</small>
                    </div>
                    <div class="tecnica-item">
                      <span class="tecnica-label">Consumo Corregido</span>
                      <span class="tecnica-value">${(consumoDiario / (eficienciaInversorOffGrid * eficienciaBateria)).toFixed(2)} Wh/d√≠a</span>
                      <small class="tecnica-formula">Consumo Diario √∑ (Eficiencia Inversor √ó Eficiencia Bater√≠a)</small>
                    </div>
                    <div class="tecnica-item">
                      <span class="tecnica-label">D√≠as de Autonom√≠a</span>
                      <span class="tecnica-value">${diasAutonomia} d√≠as</span>
                    </div>
                    <div class="tecnica-item">
                      <span class="tecnica-label">Profundidad de Descarga</span>
                      <span class="tecnica-value">${(profundidadDescarga * 100).toFixed(0)}%</span>
                    </div>
                    <div class="tecnica-item highlight">
                      <span class="tecnica-label">Capacidad Bater√≠a Requerida</span>
                      <span class="tecnica-value">${capacidadBateriaKWh.toFixed(2)} kWh</span>
                      <small class="tecnica-formula">(Consumo Corregido √ó D√≠as Autonom√≠a) √∑ Profundidad Descarga</small>
                      <small class="tecnica-formula-detalle">= (${(consumoDiario / (eficienciaInversorOffGrid * eficienciaBateria)).toFixed(2)} √ó ${diasAutonomia}) √∑ ${profundidadDescarga.toFixed(3)}</small>
                    </div>
                  </div>
                </div>
                
                <div class="calculo-paso">
                  <h5><i class="fas fa-sun"></i> Paso 2: Radiaci√≥n Solar</h5>
                  <div class="tecnica-grid">
                    <div class="tecnica-item">
                      <span class="tecnica-label">HSP (Horas Sol Pico)</span>
                      <span class="tecnica-value">${hsp.toFixed(3)} kWh/m¬≤/d√≠a</span>
                      <small class="tecnica-formula">Seg√∫n estaci√≥n meteorol√≥gica: ${estacionMeteorologica || ciudad}</small>
                    </div>
                  </div>
                </div>
                
                <div class="calculo-paso">
                  <h5><i class="fas fa-bolt"></i> Paso 3: Potencia del Arreglo</h5>
                  <div class="tecnica-grid">
                    <div class="tecnica-item">
                      <span class="tecnica-label">Consumo Diario en kWh</span>
                      <span class="tecnica-value">${(consumoDiario / 1000).toFixed(3)} kWh/d√≠a</span>
                      <small class="tecnica-formula">Consumo Diario (Wh) √∑ 1000</small>
                    </div>
                    <div class="tecnica-item">
                      <span class="tecnica-label">Promedio Diario Corregido</span>
                      <span class="tecnica-value">${((consumoDiario / 1000) / (eficienciaInversorOffGrid * eficienciaBateria)).toFixed(3)} kWh/d√≠a</span>
                      <small class="tecnica-formula">Consumo Diario (kWh) √∑ (Eficiencia Inversor √ó Eficiencia Bater√≠a)</small>
                    </div>
                    <div class="tecnica-item">
                      <span class="tecnica-label">Eficiencia Resto Sistema</span>
                      <span class="tecnica-value">0.900</span>
                      <small class="tecnica-formula">Factor fijo</small>
                    </div>
                    <div class="tecnica-item">
                      <span class="tecnica-label">SD en Paneles (Factor Seguridad)</span>
                      <span class="tecnica-value">${(sdPaneles * 100).toFixed(0)}%</span>
                      <small class="tecnica-formula">Factor de seguridad adicional (desde entrada)</small>
                    </div>
                    <div class="tecnica-item highlight">
                      <span class="tecnica-label">Potencia Necesaria</span>
                      <span class="tecnica-value">${potenciaNecesariaOffGrid.toFixed(3)} kWp</span>
                      <small class="tecnica-formula">(Consumo Corregido √∑ (Eficiencia Resto Sistema √ó HSP)) √ó (1 + SD)</small>
                      <small class="tecnica-formula-detalle">= (${((consumoDiario / 1000) / (eficienciaInversorOffGrid * eficienciaBateria)).toFixed(3)} √∑ (0.9 √ó ${hsp.toFixed(3)})) √ó (1 + ${sdPaneles.toFixed(2)})</small>
                    </div>
                  </div>
                </div>
                
                <div class="calculo-paso">
                  <h5><i class="fas fa-solar-panel"></i> Paso 4: Dimensionamiento de Paneles</h5>
                  <div class="tecnica-grid">
                    <div class="tecnica-item">
                      <span class="tecnica-label">Panel Seleccionado</span>
                      <span class="tecnica-value">${panel ? `${panel.marca} ${panel.modelo || ''} - ${panel.potencia}W` : 'N/A'}</span>
                    </div>
                    <div class="tecnica-item">
                      <span class="tecnica-label">Potencia Panel</span>
                      <span class="tecnica-value">${panel ? (panel.potencia / 1000).toFixed(3) : 0} kW</span>
                    </div>
                    <div class="tecnica-item">
                      <span class="tecnica-label">Cantidad de Paneles</span>
                      <span class="tecnica-value">${cantidadPaneles} unidades</span>
                      <small class="tecnica-formula">ROUNDUP(Potencia Necesaria √∑ Potencia Panel)</small>
                    </div>
                    <div class="tecnica-item highlight">
                      <span class="tecnica-label">Potencia Instalada</span>
                      <span class="tecnica-value">${potenciaInstalada.toFixed(3)} kWp</span>
                      <small class="tecnica-formula">Cantidad Paneles √ó Potencia Panel</small>
                    </div>
                  </div>
                </div>
                ` : ''}
              </div>
              
              <!-- An√°lisis Econ√≥mico -->
              <div class="tecnica-section">
                <h4><i class="fas fa-chart-line"></i> An√°lisis Econ√≥mico</h4>
                <div class="tecnica-grid">
                  <div class="tecnica-item">
                    <span class="tecnica-label">Energ√≠a Autoconsumo</span>
                    <span class="tecnica-value">${energiaAutoconsumo.toFixed(2)} kWh/a√±o</span>
                    <small class="tecnica-formula">Generaci√≥n Anual √ó ${porcentajeAutoconsumo}%</small>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">Energ√≠a Excedente</span>
                    <span class="tecnica-value">${energiaExcedente.toFixed(2)} kWh/a√±o</span>
                    <small class="tecnica-formula">Generaci√≥n Anual - Energ√≠a Autoconsumo</small>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">Ahorro por Autoconsumo</span>
                    <span class="tecnica-value">${formatCOP(energiaAutoconsumo * tarifaElectrica)}</span>
                    <small class="tecnica-formula">Energ√≠a Autoconsumo √ó Tarifa El√©ctrica</small>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">Ingreso por Excedentes</span>
                    <span class="tecnica-value">${formatCOP(energiaExcedente * (tarifaVentaExcedentes || tarifaElectrica * 0.9))}</span>
                    <small class="tecnica-formula">Energ√≠a Excedente √ó Tarifa Venta</small>
                  </div>
                  <div class="tecnica-item highlight">
                    <span class="tecnica-label">Ahorro Anual Total</span>
                    <span class="tecnica-value">${formatCOP(ahorroAnual)}</span>
                    <small class="tecnica-formula">Ahorro Autoconsumo + Ingreso Excedentes</small>
                  </div>
                </div>
              </div>
              
              <!-- Tabla de Precios con Rentabilidad (Formato Excel B75:F93) -->
              <div class="tecnica-section">
                <h4><i class="fas fa-dollar-sign"></i> Tabla de Precios con Rentabilidad e IVA</h4>
                <table class="tecnica-table excel-style">
                  <thead>
                    <tr>
                      <th>Item</th>
                      <th>Costo</th>
                      <th>IVA</th>
                      <th>PRECIO</th>
                      <th>IVA</th>
                      <th>TOTAL</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${itemsCotizacion.map((item, idx) => {
                      const costoUnitario = item.costoOriginal || item.precioUnitario;
                      const precioUnitario = item.precioUnitario;
                      const ivaCosto = (item.costoOriginal && item.rentabilidadAplicada === 0) ? costoUnitario * 0.19 : 0;
                      const ivaPrecio = precioUnitario * 0.19;
                      const costoTotal = costoUnitario * item.cantidad;
                      const precioTotal = precioUnitario * item.cantidad;
                      const ivaCostoTotal = ivaCosto * item.cantidad;
                      const ivaPrecioTotal = ivaPrecio * item.cantidad;
                      const totalItem = (precioUnitario + ivaPrecio) * item.cantidad;
                      
                      return `
                        <tr>
                          <td><strong>${item.descripcion}</strong></td>
                          <td>${formatCOP(costoTotal)}</td>
                          <td>${ivaCostoTotal > 0 ? formatCOP(ivaCostoTotal) : '-'}</td>
                          <td>${formatCOP(precioTotal)}</td>
                          <td>${formatCOP(ivaPrecioTotal)}</td>
                          <td>${formatCOP(totalItem)}</td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                  <tfoot>
                    <tr>
                      <td><strong>SUBTOTAL</strong></td>
                      <td><strong>${formatCOP(itemsCotizacion.reduce((sum, item) => sum + ((item.costoOriginal || item.precioUnitario) * item.cantidad), 0))}</strong></td>
                      <td><strong>-</strong></td>
                      <td><strong>${formatCOP(subtotal)}</strong></td>
                      <td><strong>${formatCOP(iva)}</strong></td>
                      <td><strong>${formatCOP(total)}</strong></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
              
              <!-- Tabla de Referencia RETIE (A103:E118) -->
              <div class="tecnica-section">
                <h4><i class="fas fa-table"></i> Tabla de Referencia RETIE</h4>
                <p class="tecnica-info" style="margin-bottom: 1rem; color: #6b7280; font-size: 0.9rem;">Esta tabla se utiliza para calcular el costo de la certificaci√≥n RETIE seg√∫n la potencia instalada del sistema.</p>
                <table class="tecnica-table excel-style">
                  <thead>
                    <tr>
                      <th>Potencia M√≠nima</th>
                      <th>Unidad</th>
                      <th>Potencia M√°xima</th>
                      <th>Unidad</th>
                      <th>Valor RETIE</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${TABLA_RETIE.map((row, idx) => `
                      <tr ${potenciaInstalada >= row.min && potenciaInstalada < row.max ? 'class="highlight-row"' : ''}>
                        <td>${row.min === 0 ? '0' : row.min.toFixed(1)}</td>
                        <td>kWp</td>
                        <td>${row.max === Infinity ? '‚àû' : row.max.toFixed(1)}</td>
                        <td>kWp</td>
                        <td>${formatCOP(row.valor)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
                <div class="tecnica-info" style="margin-top: 1rem; padding: 1rem; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #0ea5e9;">
                  <strong>F√≥rmula RETIE:</strong> VLOOKUP(Potencia Instalada, Tabla RETIE, 5, TRUE) √ó Factor<br>
                  <strong>Factor:</strong> ${esIdaYRegreso ? '1.0 (Ida y Regreso)' : '1.15 (Solo Ida)'}<br>
                  <strong>Potencia Instalada:</strong> ${potenciaInstalada.toFixed(2)} kWp<br>
                  <strong>Valor RETIE Calculado:</strong> ${formatCOP(costoRETIE)}
                </div>
              </div>
              
              <!-- Tabla de C√°lculos de Cableado y Accesorios (I38:I41) -->
              <div class="tecnica-section">
                <h4><i class="fas fa-plug"></i> C√°lculos de Cableado y Accesorios</h4>
                <table class="tecnica-table excel-style calculos-table">
                  <thead>
                    <tr>
                      <th>Concepto</th>
                      <th>Valor</th>
                      <th>F√≥rmula</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><strong>Cableado DC</strong></td>
                      <td>${formatCOP(0)}</td>
                      <td>Precio por metro √ó 4 √ó Metraje √ó Factor inversor</td>
                    </tr>
                    <tr>
                      <td><strong>Cableado AC</strong></td>
                      <td>${formatCOP(0)}</td>
                      <td>IF(Potencia>20kW, (130000√óLN(Potencia/1000)-373064), 35000) √ó Metraje</td>
                    </tr>
                    <tr>
                      <td><strong>Accesorios Varios</strong></td>
                      <td>${formatCOP(0)}</td>
                      <td>IF(Potencia>10kW, IF(Potencia>60kW, 67000, 30000), 15000) √ó Metraje √ó 1.2</td>
                    </tr>
                    <tr>
                      <td><strong>Conducci√≥n AC</strong></td>
                      <td>${formatCOP(0)}</td>
                      <td>VLOOKUP(Tipo IMC) √ó Metraje</td>
                    </tr>
                  </tbody>
                </table>
                <p class="tecnica-info" style="margin-top: 0.5rem; font-size: 0.85rem; color: #6b7280; font-style: italic;">
                  Nota: Los valores de cableado y accesorios se calculan seg√∫n las f√≥rmulas del Excel y se incluyen en el √≠tem "Accesorios" de la cotizaci√≥n.
                </p>
              </div>
              
              <!-- Tabla de C√°lculos de Mano de Obra (F51:F58) -->
              <div class="tecnica-section">
                <h4><i class="fas fa-users"></i> C√°lculos de Mano de Obra e Ingenier√≠a</h4>
                <table class="tecnica-table excel-style calculos-table">
                  <thead>
                    <tr>
                      <th>Concepto</th>
                      <th>Valor</th>
                      <th>F√≥rmula</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><strong>Mano de Obra T√©cnicos</strong></td>
                      <td>${formatCOP(0)}</td>
                      <td>Precio ing/kWp √ó T√©cnicos √ó D√≠as</td>
                    </tr>
                    <tr>
                      <td><strong>Salario Ingenieros</strong></td>
                      <td>${formatCOP(0)}</td>
                      <td>Precio ing/kWp √ó Potencia (kW) √ó Ingenieros</td>
                    </tr>
                    <tr>
                      <td><strong>Vi√°ticos</strong></td>
                      <td>${formatCOP(0)}</td>
                      <td>IF(Ida y regreso, Precio vi√°tico √ó D√≠as √ó Personal, Suma vi√°ticos √ó D√≠as √ó Personal)</td>
                    </tr>
                    <tr>
                      <td><strong>Total Mano de Obra</strong></td>
                      <td>${formatCOP(0)}</td>
                      <td>Vi√°ticos + Salario Ing + Mano Obra</td>
                    </tr>
                  </tbody>
                </table>
                <p class="tecnica-info" style="margin-top: 0.5rem; font-size: 0.85rem; color: #6b7280; font-style: italic;">
                  Nota: Los valores de mano de obra se calculan seg√∫n las f√≥rmulas del Excel y se incluyen en el √≠tem "Mano de obra y vi√°ticos" de la cotizaci√≥n.
                </p>
              </div>
              
              <!-- Tabla de C√°lculos de Vi√°ticos y Transporte (F63:F68) -->
              <div class="tecnica-section">
                <h4><i class="fas fa-car"></i> C√°lculos de Vi√°ticos y Transporte</h4>
                <table class="tecnica-table excel-style calculos-table">
                  <thead>
                    <tr>
                      <th>Concepto</th>
                      <th>Valor</th>
                      <th>F√≥rmula</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><strong>Costo Peajes</strong></td>
                      <td>${formatCOP(0)}</td>
                      <td>Kms √∑ 50 √ó Precio peaje</td>
                    </tr>
                    <tr>
                      <td><strong>Costo Gasolina</strong></td>
                      <td>${formatCOP(0)}</td>
                      <td>Kms √ó Precio/km</td>
                    </tr>
                    <tr>
                      <td><strong>Total Viaje</strong></td>
                      <td>${formatCOP(0)}</td>
                      <td>IF(Ida y regreso, Costo √ó (D√≠as+4) √ó 2, Costo √ó 2 + Otros)</td>
                    </tr>
                    <tr>
                      <td><strong>Andamios</strong></td>
                      <td>${formatCOP(0)}</td>
                      <td>IF(D√≠as<=5, 5, D√≠as) √ó Costo/d√≠a/metro √ó Metraje</td>
                    </tr>
                  </tbody>
                </table>
                <p class="tecnica-info" style="margin-top: 0.5rem; font-size: 0.85rem; color: #6b7280; font-style: italic;">
                  Nota: Los valores de vi√°ticos y transporte se calculan seg√∫n las f√≥rmulas del Excel y se incluyen en los √≠tems correspondientes de la cotizaci√≥n.
                </p>
              </div>
              
              <!-- Detalle de Equipos (Tabla Expandida) -->
              <div class="tecnica-section">
                <h4><i class="fas fa-list"></i> Detalle de Items</h4>
                <table class="tecnica-table">
                  <thead>
                    <tr>
                      <th>Item</th>
                      <th>Descripci√≥n</th>
                      <th>Cantidad</th>
                      <th>Costo Unit.</th>
                      <th>Precio Unit.</th>
                      <th>IVA Unit.</th>
                      <th>Total Unit.</th>
                      <th>Subtotal</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${itemsCotizacion.map((item, idx) => {
                      const costoUnitario = item.costoOriginal || item.precioUnitario;
                      const precioUnitario = item.precioUnitario;
                      const ivaUnitario = precioUnitario * 0.19;
                      const totalUnitario = precioUnitario + ivaUnitario;
                      
                      return `
                        <tr>
                          <td>${idx + 1}</td>
                          <td>${item.descripcion}</td>
                          <td>${item.cantidad}</td>
                          <td>${formatCOP(costoUnitario)}</td>
                          <td data-costo-original="${costoUnitario}" data-rentabilidad="${item.rentabilidadAplicada || 0}">${formatCOP(precioUnitario)}</td>
                          <td>${formatCOP(ivaUnitario)}</td>
                          <td>${formatCOP(totalUnitario)}</td>
                          <td>${formatCOP(item.subtotal + (ivaUnitario * item.cantidad))}</td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                  <tfoot>
                    <tr>
                      <td colspan="7"><strong>Subtotal</strong></td>
                      <td><strong>${formatCOP(subtotal)}</strong></td>
                    </tr>
                    <tr>
                      <td colspan="7"><strong>IVA (19%)</strong></td>
                      <td><strong>${formatCOP(iva)}</strong></td>
                    </tr>
                    <tr class="total-row">
                      <td colspan="7"><strong>TOTAL</strong></td>
                      <td><strong class="total-value">${formatCOP(total)}</strong></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
              
              ${analisisFinanciero ? `
              <!-- An√°lisis Financiero Detallado -->
              <div class="tecnica-section">
                <h4><i class="fas fa-chart-pie"></i> An√°lisis Financiero Detallado (EPC)</h4>
                <div class="tecnica-grid">
                  <div class="tecnica-item">
                    <span class="tecnica-label">Inversi√≥n Inicial</span>
                    <span class="tecnica-value">${formatCOP(total)}</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">Ahorro Anual</span>
                    <span class="tecnica-value">${formatCOP(ahorroAnual)}</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">TIR (Tasa Interna de Retorno)</span>
                    <span class="tecnica-value">${(analisisFinanciero.tir * 100).toFixed(2)}%</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">VAN (Valor Actual Neto)</span>
                    <span class="tecnica-value">${formatCOP(analisisFinanciero.van)}</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">ROI (Retorno de Inversi√≥n)</span>
                    <span class="tecnica-value">${analisisFinanciero.roi.toFixed(2)}%</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">A√±os de Recuperaci√≥n</span>
                    <span class="tecnica-value">${analisisFinanciero.a√±osRecuperacion.toFixed(2)} a√±os</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">Ahorro Total 25 A√±os</span>
                    <span class="tecnica-value">${formatCOP(analisisFinanciero.ahorroTotal25Anos)}</span>
                  </div>
                </div>
              </div>
              ` : ''}
              
              ${resultadoPPA ? `
              <!-- An√°lisis PPA Detallado -->
              <div class="tecnica-section">
                <h4><i class="fas fa-handshake"></i> An√°lisis PPA Detallado</h4>
                <div class="tecnica-grid">
                  <div class="tecnica-item">
                    <span class="tecnica-label">CAPEX</span>
                    <span class="tecnica-value">${formatCOP(resultadoPPA.capex)}</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">OPEX Anual</span>
                    <span class="tecnica-value">${formatCOP(resultadoPPA.opexAnual)}</span>
                    <small class="tecnica-formula">1.5% del CAPEX anual</small>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">Precio PPA (10 a√±os)</span>
                    <span class="tecnica-value">${formatCOP(resultadoPPA.precioPPA['10'])} /kWh</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">Precio PPA (12 a√±os)</span>
                    <span class="tecnica-value">${formatCOP(resultadoPPA.precioPPA['12'])} /kWh</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">Precio PPA (15 a√±os)</span>
                    <span class="tecnica-value">${formatCOP(resultadoPPA.precioPPA['15'])} /kWh</span>
                  </div>
                  ${resultadoPPA.metricasInversionista ? `
                  <div class="tecnica-item highlight">
                    <span class="tecnica-label">TIR Inversionista</span>
                    <span class="tecnica-value">${(resultadoPPA.metricasInversionista.tir * 100).toFixed(2)}%</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">VAN Inversionista</span>
                    <span class="tecnica-value">${formatCOP(resultadoPPA.metricasInversionista.van)}</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">ROI Inversionista</span>
                    <span class="tecnica-value">${resultadoPPA.metricasInversionista.roi.toFixed(2)}%</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">Payback Period</span>
                    <span class="tecnica-value">${resultadoPPA.metricasInversionista.paybackPeriod.toFixed(1)} a√±os</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">Ingreso Total</span>
                    <span class="tecnica-value">${formatCOP(resultadoPPA.metricasInversionista.ingresoTotal)}</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">Margen Bruto</span>
                    <span class="tecnica-value">${resultadoPPA.metricasInversionista.margenBruto.toFixed(2)}%</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">Margen Neto</span>
                    <span class="tecnica-value">${resultadoPPA.metricasInversionista.margenNeto.toFixed(2)}%</span>
                  </div>
                  <div class="tecnica-item">
                    <span class="tecnica-label">LCOE</span>
                    <span class="tecnica-value">${formatCOP(resultadoPPA.metricasInversionista.lcoe)} /kWh</span>
                    <small class="tecnica-formula">Levelized Cost of Energy</small>
                  </div>
                  ` : ''}
                </div>
              </div>
              ` : ''}
            </div>
          </div>
        `;
        
        // Agregar event listeners para cambio de vista
        setTimeout(() => {
          const btnVistaComercial = document.getElementById('btnVistaComercial');
          const btnVistaTecnica = document.getElementById('btnVistaTecnica');
          const vistaComercial = document.getElementById('vistaComercial');
          const vistaTecnica = document.getElementById('vistaTecnica');
          
          btnVistaComercial?.addEventListener('click', function() {
            btnVistaComercial.classList.add('active');
            btnVistaTecnica?.classList.remove('active');
            if (vistaComercial) vistaComercial.style.display = 'block';
            if (vistaTecnica) vistaTecnica.style.display = 'none';
          });
          
          btnVistaTecnica?.addEventListener('click', function() {
            btnVistaTecnica.classList.add('active');
            btnVistaComercial?.classList.remove('active');
            if (vistaComercial) vistaComercial.style.display = 'none';
            if (vistaTecnica) vistaTecnica.style.display = 'block';
          });
          
          // Agregar event listener para WhatsApp
          const btnWhatsApp = document.getElementById('btnEnviarWhatsApp');
          btnWhatsApp?.addEventListener('click', function() {
            enviarCotizacionWhatsApp(itemsCotizacion, subtotal, iva, total, {
              potenciaInstalada,
              cantidadPaneles,
              generacionAnual,
              ahorroAnual,
            });
          });
          
          // Generar gr√°fica de flujo de caja seg√∫n modelo
          if (resultadoPPA && typeof Chart !== 'undefined') {
            generarGraficaFlujoCajaPPA(resultadoPPA.flujoCajaCliente);
          } else if (analisisFinanciero && typeof Chart !== 'undefined') {
            generarGraficaFlujoCaja(analisisFinanciero.flujoCaja);
          }
          
          // Agregar event listener para guardar cotizaci√≥n
          const btnGuardar = document.getElementById('btnGuardarCotizacion');
          btnGuardar?.addEventListener('click', function() {
            guardarCotizacion({
              tipoSistema,
              cliente: {
                nombre: document.getElementById('clienteNombre')?.value || '',
                telefono: document.getElementById('clienteTelefono')?.value || '',
                email: document.getElementById('clienteEmail')?.value || '',
                ciudad: document.getElementById('clienteCiudad')?.value || '',
                departamento: document.getElementById('clienteDepartamento')?.value || '',
              },
              calculos: {
                potenciaInstalada,
                cantidadPaneles,
                generacionAnual,
                ahorroAnual,
                energiaAutoconsumo,
                energiaExcedente,
              },
              cotizacion: {
                items: itemsCotizacion,
                subtotal,
                iva,
                total,
              },
              analisisFinanciero,
              impactoAmbiental,
              fecha: new Date().toISOString(),
            });
          });
        }, 100);
        
        resultadosPanel.style.display = 'block';
        resultadosPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } else if (tipoSistema === 'off-grid') {
        // El c√°lculo Off-Grid ya est√° implementado arriba, no deber√≠a llegar aqu√≠
        alert('Error: No se pudo calcular el sistema Off-Grid. Por favor verifique los datos ingresados.');
        resultadosPanel.style.display = 'none';
      } else {
        alert('Error: Tipo de sistema no reconocido. Por favor seleccione On-Grid, Off-Grid o H√≠brido.');
        resultadosPanel.style.display = 'none';
      }
      } catch (error) {
        console.error('Error al calcular el sistema:', error);
        alert('Error al calcular el sistema: ' + error.message);
        if (resultadosContenido) {
          resultadosContenido.innerHTML = `
            <div style="padding: 2rem; background: #fee2e2; border: 2px solid #ef4444; border-radius: 8px; color: #991b1b;">
              <h3 style="margin-top: 0; color: #991b1b;">
                <i class="fas fa-exclamation-triangle"></i> Error al calcular
              </h3>
              <p>${error.message}</p>
              <p style="font-size: 0.9rem; margin-top: 1rem;">Por favor verifique los datos ingresados e intente nuevamente.</p>
            </div>
          `;
        }
        resultadosPanel.style.display = 'block';
      }
    });
  }
  
  // Inicializar cuando el DOM est√© listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', inicializarCotizador);
  } else {
    // DOM ya est√° listo
    inicializarCotizador();
  }
  
  // Tambi√©n intentar inicializar despu√©s de un peque√±o delay por si acaso
  setTimeout(inicializarCotizador, 500);
  
  // Event listener para recalcular con nueva rentabilidad
  document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(e) {
      if (e.target && e.target.id === 'btnRecalcularRentabilidad') {
        // Obtener nueva rentabilidad adicional
        const rentabilidadAdicionalInput = document.getElementById('rentabilidadAdicional');
        const nuevaRentabilidadAdicional = parseFloat(rentabilidadAdicionalInput?.value || 0) / 100;
        const rentabilidadMinima = 0.20;
        const nuevaRentabilidadTotal = rentabilidadMinima + nuevaRentabilidadAdicional;
        
        // Recalcular precios de todos los items en la tabla de cotizaci√≥n
        // Buscar tabla en vista comercial o t√©cnica
        const tablaCotizacion = document.querySelector('.cotizacion-table tbody') || document.querySelector('.tecnica-table tbody');
        if (tablaCotizacion) {
          const filas = tablaCotizacion.querySelectorAll('tr');
          let nuevoSubtotal = 0;
          
          filas.forEach(fila => {
            const cantidadCell = fila.querySelector('td:nth-child(2)');
            const precioCell = fila.querySelector('td:nth-child(3)');
            const subtotalCell = fila.querySelector('td:nth-child(4)');
            
            if (cantidadCell && precioCell && subtotalCell) {
              const cantidad = parseFloat(cantidadCell.textContent.replace(/[^\d.]/g, '')) || 1;
              const costoOriginal = parseFloat(precioCell.getAttribute('data-costo-original') || precioCell.textContent.replace(/[^\d.]/g, ''));
              
              if (costoOriginal > 0) {
                // Solo aplicar rentabilidad si el item tiene rentabilidad aplicada (no a obras adicionales, vi√°ticos, etc.)
                const tieneRentabilidad = precioCell.getAttribute('data-rentabilidad') !== '0';
                const nuevoPrecio = tieneRentabilidad 
                  ? costoOriginal / (1 - nuevaRentabilidadTotal)
                  : costoOriginal; // Items sin rentabilidad se mantienen igual
                const nuevoSubtotalItem = nuevoPrecio * cantidad;
                
                precioCell.textContent = formatCOP(nuevoPrecio);
                precioCell.setAttribute('data-costo-original', costoOriginal);
                precioCell.setAttribute('data-rentabilidad', tieneRentabilidad ? nuevaRentabilidadTotal.toString() : '0');
                subtotalCell.textContent = formatCOP(nuevoSubtotalItem);
                
                nuevoSubtotal += nuevoSubtotalItem;
              }
            }
          });
          
          // Actualizar totales (buscar en ambas vistas)
          const subtotalRow = document.querySelector('.cotizacion-table tfoot tr:first-child td:last-child') || 
                             document.querySelector('.tecnica-table tfoot tr:first-child td:last-child');
          const ivaRow = document.querySelector('.cotizacion-table tfoot tr:nth-child(2) td:last-child') ||
                        document.querySelector('.tecnica-table tfoot tr:nth-child(2) td:last-child');
          const totalRow = document.querySelector('.cotizacion-table tfoot tr.total-row td:last-child') ||
                          document.querySelector('.tecnica-table tfoot tr.total-row td:last-child');
          
          if (subtotalRow && ivaRow && totalRow) {
            const nuevoIva = nuevoSubtotal * 0.19;
            const nuevoTotal = nuevoSubtotal + nuevoIva;
            
            subtotalRow.textContent = formatCOP(nuevoSubtotal);
            ivaRow.textContent = formatCOP(nuevoIva);
            totalRow.textContent = formatCOP(nuevoTotal);
          }
          
          // Actualizar rentabilidad total mostrada
          const rentabilidadTotalDiv = document.querySelector('.rentabilidad-control div:nth-child(2) div');
          if (rentabilidadTotalDiv) {
            rentabilidadTotalDiv.textContent = `${(nuevaRentabilidadTotal * 100).toFixed(2)}%`;
          }
          
          // Mostrar mensaje de √©xito
          const mensaje = document.createElement('div');
          mensaje.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; background: #10b981; color: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10000;';
          mensaje.innerHTML = '<i class="fas fa-check-circle"></i> Precios recalculados con rentabilidad del ' + (nuevaRentabilidadTotal * 100).toFixed(2) + '%';
          document.body.appendChild(mensaje);
          
          setTimeout(() => {
            mensaje.remove();
          }, 3000);
        }
      }
    });
    
    // Event listener para toggle hist√≥rico
    const btnToggleHistorico = document.getElementById('btnToggleHistorico');
    const historicoContenido = document.getElementById('historicoContenido');
    
    btnToggleHistorico?.addEventListener('click', function() {
      if (historicoContenido) {
        const isVisible = historicoContenido.style.display !== 'none';
        historicoContenido.style.display = isVisible ? 'none' : 'block';
        this.innerHTML = isVisible 
          ? '<i class="fas fa-history"></i> Ver Hist√≥rico'
          : '<i class="fas fa-times"></i> Ocultar Hist√≥rico';
        
        if (!isVisible) {
          actualizarListaHistorico();
        }
      }
    });
    
    // Cargar hist√≥rico al inicio
    actualizarListaHistorico();
  });
</script>

<style>
  .cotizador-hero {
    padding: 6rem 2rem 3rem;
    background: linear-gradient(135deg, #6b2181 0%, #8b2a9b 100%);
    color: white;
    text-align: center;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
  }

  .container-full {
    max-width: 100%;
    margin: 0 auto;
    padding: 0 2rem;
  }

  .hero-title {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 1rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .hero-subtitle {
    font-size: 1.3rem;
    color: rgba(255, 255, 255, 0.9);
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  /* Estilos de Login */
  .login-section {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #6b2181 0%, #8b2a9b 100%);
    padding: 2rem;
  }

  .login-container {
    width: 100%;
    max-width: 450px;
  }

  .login-card {
    background: white;
    border-radius: 20px;
    padding: 3rem;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideIn 0.5s ease-out;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
  }

  .login-header {
    text-align: center;
    margin-bottom: 2.5rem;
  }

  .login-header i {
    font-size: 3rem;
    color: #6b2181;
    margin-bottom: 1rem;
  }

  .login-header h2 {
    font-size: 1.8rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.5rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .login-header p {
    color: #6b7280;
    font-size: 0.95rem;
  }

  .login-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .login-form .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .login-form label {
    font-weight: 600;
    color: #1f2937;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .login-form label i {
    color: #6b2181;
    font-size: 0.9rem;
  }

  .login-form .form-input {
    padding: 0.875rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.3s;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .login-form .form-input:focus {
    outline: none;
    border-color: #6b2181;
    box-shadow: 0 0 0 3px rgba(107, 33, 129, 0.1);
  }

  .login-error {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    background: #fee2e2;
    border: 2px solid #ef4444;
    border-radius: 10px;
    color: #991b1b;
    font-size: 0.9rem;
    animation: shake 0.5s;
  }

  .login-error i {
    font-size: 1.2rem;
  }

  .btn-login {
    padding: 1rem 2rem;
    background: linear-gradient(135deg, #6b2181 0%, #8b2a9b 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .btn-login:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(107, 33, 129, 0.3);
  }

  .btn-login:active {
    transform: translateY(0);
  }

  .btn-login i {
    font-size: 1rem;
  }

  /* Barra de informaci√≥n del usuario */
  .user-info-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 1rem 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: #1f2937;
    font-weight: 600;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .user-info i {
    font-size: 1.5rem;
    color: #6b2181;
  }

  .btn-cerrar-sesion {
    padding: 0.5rem 1.5rem;
    background: #fee2e2;
    color: #991b1b;
    border: 2px solid #ef4444;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .btn-cerrar-sesion:hover {
    background: #ef4444;
    color: white;
  }

  .btn-cerrar-sesion i {
    font-size: 0.9rem;
  }

  .cotizador-section {
    padding: 3rem 0;
    background: #f9fafb;
    min-height: 80vh;
  }

  .formulario-panel {
    background: white;
    border-radius: 20px;
    padding: 3rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    margin-bottom: 3rem;
    max-width: 100%;
  }

  .resultados-container {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    max-width: 100%;
  }

  .panel-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .panel-title i {
    color: #6b2181;
  }

  .resultado-card {
    background: white;
    border-radius: 16px;
    padding: 2.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid #e5e7eb;
    margin-bottom: 2rem;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .resultado-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
  }

  .resultado-card h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 2rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding-bottom: 1rem;
    border-bottom: 3px solid #6b2181;
  }

  .resultado-card h3 i {
    color: #6b2181;
    font-size: 1.3rem;
  }

  .resultado-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
  }

  .resultado-item {
    display: flex;
    flex-direction: column;
    padding: 1.5rem;
    background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
    border-radius: 12px;
    border: 2px solid #e5e7eb;
    transition: all 0.2s;
  }

  .resultado-item:hover {
    border-color: #6b2181;
    background: linear-gradient(135deg, #f3f4f6 0%, #ffffff 100%);
  }

  .resultado-label {
    font-size: 0.9rem;
    color: #6b7280;
    margin-bottom: 0.75rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .resultado-value {
    font-size: 1.4rem;
    font-weight: 700;
    color: #1f2937;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .resultado-value.highlight {
    color: #6b2181;
    font-size: 1.8rem;
  }

  .cotizacion-card {
    background: white;
    border-radius: 16px;
    padding: 2.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid #e5e7eb;
    margin-bottom: 2rem;
  }

  .cotizacion-card h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 2rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding-bottom: 1rem;
    border-bottom: 3px solid #6b2181;
  }

  .cotizacion-card h3 i {
    color: #6b2181;
    font-size: 1.3rem;
  }

  .cotizacion-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 1.5rem;
  }

  .cotizacion-table thead {
    background: #6b2181;
    color: white;
  }

  .cotizacion-table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.9rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .cotizacion-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e5e7eb;
    font-size: 0.9rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .cotizacion-table tbody tr:hover {
    background: #f9fafb;
  }

  .cotizacion-table tfoot {
    background: #f9fafb;
  }

  .cotizacion-table tfoot td {
    font-weight: 600;
    border-bottom: none;
  }

  .cotizacion-table .total-row {
    background: #6b2181;
    color: white;
  }

  .cotizacion-table .total-row td {
    border-bottom: none;
    padding: 1rem;
    font-size: 1.1rem;
  }

  .total-value {
    font-size: 1.3rem !important;
  }
  
  .analisis-financiero-card {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 2px solid #0ea5e9;
  }
  
  .analisis-financiero-card h3 {
    border-bottom-color: #0ea5e9;
  }
  
  .analisis-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
  }
  
  .analisis-item {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .analisis-label {
    font-size: 0.9rem;
    color: #6b7280;
    font-weight: 500;
  }
  
  .analisis-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
  }
  
  .analisis-value.highlight {
    color: #0ea5e9;
  }
  
  .impacto-ambiental-card {
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    border: 2px solid #10b981;
  }
  
  .impacto-ambiental-card h3 {
    border-bottom-color: #10b981;
  }
  
  .impacto-ambiental-card h3 i {
    color: #10b981;
  }
  
  .impacto-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
  }
  
  .impacto-item {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .impacto-label {
    font-size: 0.9rem;
    color: #6b7280;
    font-weight: 500;
  }
  
  .impacto-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #16a34a;
  }

  .cotizacion-actions {
    display: flex;
    justify-content: center;
    margin-top: 1.5rem;
  }

  .btn-whatsapp {
    background: linear-gradient(135deg, #25D366, #128C7E);
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .btn-whatsapp:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 211, 102, 0.4);
  }
  
  .btn-save {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  .btn-save:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
  }
  
  .cotizacion-actions {
    display: flex;
    justify-content: center;
    gap: 1rem;
    flex-wrap: wrap;
  }
  
  .historico-panel {
    margin-top: 3rem;
    padding: 2rem;
    background: #f9fafb;
    border-radius: 12px;
  }
  
  .historico-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }
  
  .historico-header h2 {
    font-size: 1.5rem;
    color: #1f2937;
    margin: 0;
  }
  
  .btn-toggle-historico {
    background: #6b2181;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: background 0.3s;
  }
  
  .btn-toggle-historico:hover {
    background: #5a1a6f;
  }
  
  .historico-contenido {
    margin-top: 1.5rem;
  }
  
  .sin-cotizaciones {
    text-align: center;
    color: #6b7280;
    padding: 2rem;
  }
  
  .cotizacion-historico-item {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: box-shadow 0.3s;
  }
  
  .cotizacion-historico-item:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
  
  .cotizacion-historico-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
  }
  
  .cotizacion-historico-header h4 {
    font-size: 1.1rem;
    color: #1f2937;
    margin: 0 0 0.25rem 0;
  }
  
  .cotizacion-fecha {
    font-size: 0.85rem;
    color: #6b7280;
    margin: 0;
  }
  
  .cotizacion-historico-actions {
    display: flex;
    gap: 0.5rem;
  }
  
  .btn-ver-cotizacion,
  .btn-eliminar-cotizacion {
    background: transparent;
    border: 1px solid #e5e7eb;
    padding: 0.5rem;
    border-radius: 6px;
    cursor: pointer;
    color: #6b7280;
    transition: all 0.2s;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .btn-ver-cotizacion:hover {
    background: #3b82f6;
    border-color: #3b82f6;
    color: white;
  }
  
  .btn-eliminar-cotizacion:hover {
    background: #ef4444;
    border-color: #ef4444;
    color: white;
  }
  
  .cotizacion-historico-info {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    align-items: center;
  }
  
  .badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .badge-on-grid {
    background: #dbeafe;
    color: #1e40af;
  }
  
  .badge-off-grid {
    background: #fef3c7;
    color: #92400e;
  }
  
  .badge-hibrido {
    background: #e9d5ff;
    color: #6b21a8;
  }
  
  .cotizacion-total,
  .cotizacion-ahorro {
    font-size: 0.9rem;
    color: #1f2937;
    font-weight: 600;
  }
  
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }
  
  .ppa-resultados-card {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 2px solid #f59e0b;
  }
  
  .ppa-resultados-card h3 {
    border-bottom-color: #f59e0b;
  }
  
  .ppa-resultados-card h3 i {
    color: #f59e0b;
  }
  
  .ppa-info-banner {
    background: #f59e0b;
    color: white;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  .ppa-info-banner i {
    font-size: 1.2rem;
  }
  
  .ppa-precios-grid,
  .ppa-ahorros-grid,
  .ppa-cuotas-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .ppa-precio-item,
  .ppa-ahorro-item,
  .ppa-cuota-item {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .ppa-precio-label,
  .ppa-ahorro-label,
  .ppa-cuota-label {
    font-size: 0.9rem;
    color: #6b7280;
    font-weight: 500;
  }
  
  .ppa-precio-value,
  .ppa-ahorro-value,
  .ppa-cuota-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #92400e;
  }
  
  .ppa-precio-value.highlight,
  .ppa-ahorro-value.highlight,
  .ppa-cuota-value.highlight {
    color: #f59e0b;
    font-size: 1.8rem;
  }
  
  .ppa-inversionista-info {
    margin-top: 1.5rem;
    padding: 1.5rem;
    background: white;
    border-radius: 8px;
    text-align: center;
  }
  
  .ppa-inversionista-info h4 {
    font-size: 1rem;
    color: #6b7280;
    margin-bottom: 0.5rem;
  }
  
  .ppa-tir-value {
    font-size: 2rem;
    font-weight: 700;
    color: #10b981;
    margin: 0;
  }
  
  .ppa-inversionista-metricas {
    margin-top: 2rem;
    padding: 2rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  .ppa-inversionista-metricas h4 {
    color: #1f2937;
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
    border-bottom: 2px solid #6b2181;
    padding-bottom: 0.5rem;
  }
  
  .ppa-metricas-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }
  
  .ppa-metrica-item {
    background: #f9fafb;
    padding: 1.5rem;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    border-left: 4px solid #6b2181;
  }
  
  .ppa-metrica-item.highlight {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    border-left-color: #3b82f6;
  }
  
  .ppa-metrica-label {
    font-size: 0.9rem;
    color: #6b7280;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .ppa-metrica-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
  }
  
  .ppa-metrica-item.highlight .ppa-metrica-value {
    color: #1e40af;
    font-size: 1.8rem;
  }
  
  .ppa-comparativa-escenarios {
    margin-top: 2rem;
  }
  
  .ppa-comparativa-escenarios h5 {
    color: #1f2937;
    margin-bottom: 1rem;
    font-size: 1.2rem;
  }
  
  .ppa-escenarios-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .ppa-escenarios-table th {
    background: #6b2181;
    color: white;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
  }
  
  .ppa-escenarios-table td {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
  }
  
  .ppa-escenarios-table tbody tr:hover {
    background: #f9fafb;
  }

  @media (max-width: 1024px) {
    .container-full {
      padding: 0 1rem;
    }
    
    .formulario-panel {
      padding: 2rem 1.5rem;
    }
    
    .resultado-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .hero-title {
      font-size: 2rem;
    }

    .resultado-grid {
      grid-template-columns: 1fr;
    }
    
    .tecnica-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Estilos para Vista T√©cnica */
  .tecnica-card {
    background: white;
    border-radius: 16px;
    padding: 2.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid #e5e7eb;
  }

  .tecnica-card h3 {
    font-size: 1.8rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 2rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding-bottom: 1rem;
    border-bottom: 3px solid #6b2181;
  }

  .tecnica-card h3 i {
    color: #6b2181;
    font-size: 1.5rem;
  }

  .tecnica-section {
    margin-bottom: 3rem;
    padding-bottom: 2rem;
    border-bottom: 2px solid #e5e7eb;
  }

  .tecnica-section:last-child {
    border-bottom: none;
  }

  .tecnica-section h4 {
    font-size: 1.3rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 1.5rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .tecnica-section h4 i {
    color: #6b2181;
    font-size: 1.2rem;
  }

  .calculo-paso {
    margin-bottom: 2.5rem;
    padding: 1.5rem;
    background: #f9fafb;
    border-radius: 12px;
    border-left: 4px solid #6b2181;
  }

  .calculo-paso h5 {
    font-size: 1.1rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 1rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .calculo-paso h5 i {
    color: #6b2181;
    font-size: 1rem;
  }

  .tecnica-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
  }

  .tecnica-item {
    display: flex;
    flex-direction: column;
    padding: 1.5rem;
    background: white;
    border-radius: 10px;
    border: 2px solid #e5e7eb;
    transition: all 0.2s;
  }

  .tecnica-item:hover {
    border-color: #6b2181;
    box-shadow: 0 4px 12px rgba(107, 33, 129, 0.1);
  }

  .tecnica-item.highlight {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border-color: #0ea5e9;
    border-width: 3px;
  }

  .tecnica-label {
    font-size: 0.85rem;
    color: #6b7280;
    margin-bottom: 0.5rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .tecnica-value {
    font-size: 1.3rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.5rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .tecnica-item.highlight .tecnica-value {
    color: #0ea5e9;
    font-size: 1.6rem;
  }

  .tecnica-formula {
    display: block;
    font-size: 0.8rem;
    color: #6b7280;
    font-style: italic;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid #e5e7eb;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .tecnica-formula-detalle {
    display: block;
    font-size: 0.75rem;
    color: #9ca3af;
    font-style: italic;
    margin-top: 0.25rem;
    padding-left: 1rem;
    font-family: 'Courier New', monospace;
  }

  .tecnica-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    margin-top: 1rem;
  }

  .tecnica-table thead {
    background: #6b2181;
    color: white;
  }

  .tecnica-table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.9rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .tecnica-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e5e7eb;
    font-size: 0.9rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .tecnica-table tbody tr:hover {
    background: #f9fafb;
  }

  .tecnica-table tfoot {
    background: #f9fafb;
  }

  .tecnica-table tfoot td {
    font-weight: 600;
    border-bottom: none;
  }

  .tecnica-table .total-row {
    background: #6b2181;
    color: white;
  }

  .tecnica-table .total-row td {
    border-bottom: none;
    padding: 1rem;
    font-size: 1.1rem;
  }

  /* Estilos para tablas estilo Excel */
  .tecnica-table.excel-style {
    border: 2px solid #1f2937;
    font-size: 0.9rem;
  }

  .tecnica-table.excel-style thead {
    background: #1f2937;
    color: white;
  }

  .tecnica-table.excel-style thead th {
    border: 1px solid #374151;
    padding: 0.75rem;
    font-weight: 700;
    text-align: center;
    font-size: 0.85rem;
  }

  .tecnica-table.excel-style tbody td {
    border: 1px solid #d1d5db;
    padding: 0.75rem;
    text-align: right;
  }

  .tecnica-table.excel-style tbody td:first-child {
    text-align: left;
    font-weight: 600;
  }

  .tecnica-table.excel-style tbody tr:nth-child(even) {
    background: #f9fafb;
  }

  .tecnica-table.excel-style tbody tr:hover {
    background: #f3f4f6;
  }

  .tecnica-table.excel-style tbody tr.highlight-row {
    background: #dbeafe;
    font-weight: 600;
  }

  .tecnica-table.excel-style tbody tr.highlight-row td {
    border-color: #3b82f6;
  }

  .tecnica-table.excel-style tfoot {
    background: #1f2937;
    color: white;
  }

  .tecnica-table.excel-style tfoot td {
    border: 1px solid #374151;
    padding: 0.75rem;
    font-weight: 700;
    text-align: right;
  }

  .tecnica-table.excel-style tfoot td:first-child {
    text-align: left;
  }

  .tecnica-table.calculos-table tbody td:nth-child(2) {
    font-weight: 600;
    color: #1f2937;
  }

  .tecnica-table.calculos-table tbody td:nth-child(4) {
    font-style: italic;
    color: #6b7280;
    font-size: 0.85rem;
  }
</style>

