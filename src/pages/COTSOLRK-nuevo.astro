---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import WhatsAppFloat from '../components/WhatsAppFloat.astro';
import SEO from '../components/SEO.astro';
import FontAwesome from '../components/FontAwesome.astro';
import FormularioEntrada from '../components/Cotizador/FormularioEntrada.astro';
import { EQUIPOS } from '../lib/cotizador/equipos';

// Convertir equipos a JSON para el cliente
const equiposJSON = JSON.stringify(EQUIPOS);
---

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    <title>Cotizador Solar Profesional | Reiki Energía Solar</title>
    <FontAwesome />
    <SEO 
      title="Cotizador Solar Profesional | Sistema de Cotización Online"
      description="Cotizador profesional para sistemas solares. Genera cotizaciones detalladas con precios, descuentos e IVA. On-Grid y Off-Grid."
      canonical="/COTSOLRK"
      keywords="cotizador solar, cotización energía solar, cotizador paneles solares, sistema cotización solar"
    />
  </head>
  <body>
    <Header />
    
    <main>
      <section class="cotizador-hero">
        <div class="container">
          <h1 class="hero-title">Cotizador Solar Profesional</h1>
          <p class="hero-subtitle">Genera cotizaciones detalladas para sistemas solares On-Grid y Off-Grid</p>
        </div>
      </section>

      <section class="cotizador-section">
        <div class="container">
          <div class="cotizador-layout">
            <!-- Formulario de Entrada -->
            <div class="formulario-panel">
              <FormularioEntrada />
            </div>

            <!-- Panel de Resultados -->
            <div class="resultados-panel" id="resultadosPanel" style="display: none;">
              <h2 class="panel-title">
                <i class="fas fa-chart-line"></i>
                Resultados del Cálculo
              </h2>

              <div id="resultadosContenido">
                <!-- Los resultados se mostrarán aquí -->
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
    
    <Footer />
    <WhatsAppFloat />
  </body>
</html>

<script define:vars={{ equiposJSON }}>
  // Importar funciones de cálculo (simuladas en el cliente)
  // En producción, estas deberían venir de un módulo compilado
  
  const equipos = JSON.parse(equiposJSON);
  
  // Función para obtener HSP por ciudad
  const HSP_POR_CIUDAD = {
    'Medellín': 4.5,
    'Bogotá': 4.2,
    'Cali': 4.8,
    'Barranquilla': 5.2,
    'Cartagena': 5.0,
    'Bucaramanga': 4.6,
    'Pereira': 4.4,
    'Manizales': 4.3,
    'La Ceja': 4.5,
    'Envigado': 4.5,
    'Bello': 4.5,
  };
  
  const FACTOR_EFICIENCIA = 0.8;
  
  function obtenerHSPPorCiudad(ciudad) {
    return HSP_POR_CIUDAD[ciudad] || 4.5;
  }
  
  function calcularConsumoAnual(consumosMensuales) {
    if (consumosMensuales.length === 12) {
      return consumosMensuales.reduce((sum, consumo) => sum + consumo, 0);
    } else if (consumosMensuales.length === 1) {
      return consumosMensuales[0] * 12;
    }
    const promedio = consumosMensuales.reduce((sum, c) => sum + c, 0) / consumosMensuales.length;
    return promedio * 12;
  }
  
  function calcularPotenciaNecesariaOnGrid(consumoAnual, hsp) {
    return consumoAnual / (hsp * 365 * FACTOR_EFICIENCIA);
  }
  
  function calcularCantidadPaneles(potenciaNecesaria, potenciaPanel) {
    return Math.ceil(potenciaNecesaria / potenciaPanel);
  }
  
  function calcularGeneracionAnual(potenciaInstalada, hsp) {
    return potenciaInstalada * hsp * 365 * FACTOR_EFICIENCIA;
  }
  
  function calcularAhorroAnualOnGrid(generacionAnual, porcentajeAutoconsumo, tarifaElectrica, tarifaVentaExcedentes) {
    const energiaAutoconsumo = generacionAnual * (porcentajeAutoconsumo / 100);
    const energiaExcedente = generacionAnual - energiaAutoconsumo;
    const tarifaVenta = tarifaVentaExcedentes || tarifaElectrica * 0.9;
    const ahorroAnual = (energiaAutoconsumo * tarifaElectrica) + (energiaExcedente * tarifaVenta);
    return { energiaAutoconsumo, energiaExcedente, ahorroAnual };
  }
  
  function formatCOP(num) {
    return new Intl.NumberFormat('es-CO', {
      style: 'currency',
      currency: 'COP',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(num);
  }
  
  // Event listener para el botón calcular
  document.addEventListener('DOMContentLoaded', function() {
    const btnCalcular = document.getElementById('btnCalcular');
    const resultadosPanel = document.getElementById('resultadosPanel');
    const resultadosContenido = document.getElementById('resultadosContenido');
    
    btnCalcular?.addEventListener('click', function() {
      // Obtener datos del formulario
      const tipoSistema = document.querySelector('input[name="tipoSistema"]:checked')?.value;
      const ciudad = document.getElementById('clienteCiudad')?.value;
      
      if (!ciudad) {
        alert('Por favor ingrese la ciudad');
        return;
      }
      
      if (tipoSistema === 'on-grid' || tipoSistema === 'hibrido') {
        // Obtener consumos mensuales
        const consumoPromedio = parseFloat(document.getElementById('consumoPromedio')?.value || 0);
        const consumosMensuales = Array.from(document.querySelectorAll('.consumo-mes'))
          .map(input => parseFloat(input.value) || 0)
          .filter(v => v > 0);
        
        const consumos = consumosMensuales.length > 0 
          ? consumosMensuales 
          : consumoPromedio > 0 
            ? [consumoPromedio] 
            : [];
        
        if (consumos.length === 0) {
          alert('Por favor ingrese el consumo mensual');
          return;
        }
        
        const tarifaElectrica = parseFloat(document.getElementById('tarifaElectrica')?.value || 0);
        const porcentajeAutoconsumo = parseFloat(document.getElementById('porcentajeAutoconsumo')?.value || 60);
        const tarifaVentaExcedentes = parseFloat(document.getElementById('tarifaVentaExcedentes')?.value || 0) || undefined;
        
        if (!tarifaElectrica) {
          alert('Por favor ingrese la tarifa eléctrica');
          return;
        }
        
        // Seleccionar panel (por defecto el 585W)
        const panel = equipos.find(e => e.id === 'panel-585w');
        if (!panel) {
          alert('Error: No se encontró el panel seleccionado');
          return;
        }
        
        // Calcular
        const hsp = obtenerHSPPorCiudad(ciudad);
        const consumoAnual = calcularConsumoAnual(consumos);
        const potenciaNecesaria = calcularPotenciaNecesariaOnGrid(consumoAnual, hsp);
        const potenciaPanel = panel.potencia / 1000; // W a kW
        const cantidadPaneles = calcularCantidadPaneles(potenciaNecesaria, potenciaPanel);
        const potenciaInstalada = cantidadPaneles * potenciaPanel;
        const generacionAnual = calcularGeneracionAnual(potenciaInstalada, hsp);
        const { energiaAutoconsumo, energiaExcedente, ahorroAnual } = calcularAhorroAnualOnGrid(
          generacionAnual,
          porcentajeAutoconsumo,
          tarifaElectrica,
          tarifaVentaExcedentes
        );
        
        // Mostrar resultados
        resultadosContenido.innerHTML = `
          <div class="resultado-card">
            <h3>Resultados del Cálculo</h3>
            <div class="resultado-grid">
              <div class="resultado-item">
                <span class="resultado-label">Potencia Necesaria</span>
                <span class="resultado-value">${potenciaNecesaria.toFixed(2)} kWp</span>
              </div>
              <div class="resultado-item">
                <span class="resultado-label">Cantidad de Paneles</span>
                <span class="resultado-value">${cantidadPaneles} unidades</span>
              </div>
              <div class="resultado-item">
                <span class="resultado-label">Potencia Instalada</span>
                <span class="resultado-value">${potenciaInstalada.toFixed(2)} kWp</span>
              </div>
              <div class="resultado-item">
                <span class="resultado-label">Generación Anual</span>
                <span class="resultado-value">${generacionAnual.toFixed(0)} kWh/año</span>
              </div>
              <div class="resultado-item">
                <span class="resultado-label">Ahorro Anual</span>
                <span class="resultado-value highlight">${formatCOP(ahorroAnual)}</span>
              </div>
              <div class="resultado-item">
                <span class="resultado-label">Energía Autoconsumo</span>
                <span class="resultado-value">${energiaAutoconsumo.toFixed(0)} kWh/año</span>
              </div>
              <div class="resultado-item">
                <span class="resultado-label">Energía Excedente</span>
                <span class="resultado-value">${energiaExcedente.toFixed(0)} kWh/año</span>
              </div>
            </div>
          </div>
        `;
        
        resultadosPanel.style.display = 'block';
        resultadosPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } else if (tipoSistema === 'off-grid') {
        alert('Cálculo Off-Grid próximamente');
      }
    });
  });
</script>

<style>
  .cotizador-hero {
    padding: 6rem 2rem 3rem;
    background: linear-gradient(135deg, #6b2181 0%, #8b2a9b 100%);
    color: white;
    text-align: center;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
  }

  .hero-title {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 1rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .hero-subtitle {
    font-size: 1.3rem;
    color: rgba(255, 255, 255, 0.9);
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .cotizador-section {
    padding: 3rem 2rem;
    background: #f9fafb;
    min-height: 80vh;
  }

  .cotizador-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    align-items: start;
  }

  .formulario-panel,
  .resultados-panel {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }

  .panel-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .panel-title i {
    color: #6b2181;
  }

  .resultado-card {
    background: #f9fafb;
    border-radius: 12px;
    padding: 1.5rem;
  }

  .resultado-card h3 {
    font-size: 1.3rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 1.5rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .resultado-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  .resultado-item {
    display: flex;
    flex-direction: column;
    padding: 1rem;
    background: white;
    border-radius: 8px;
    border: 2px solid #e5e7eb;
  }

  .resultado-label {
    font-size: 0.85rem;
    color: #6b7280;
    margin-bottom: 0.5rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .resultado-value {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1f2937;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .resultado-value.highlight {
    color: #6b2181;
    font-size: 1.3rem;
  }

  @media (max-width: 1024px) {
    .cotizador-layout {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .hero-title {
      font-size: 2rem;
    }

    .resultado-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

