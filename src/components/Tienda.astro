---
import { getCollection, type CollectionEntry } from 'astro:content';
import ProductCard from './ProductCard.astro';

type ProductoEntry = CollectionEntry<'productos'>;

// Obtener todos los productos ordenados
const productos = await getCollection('productos');
const productosOrdenados = (productos as ProductoEntry[]).sort(
  (a: ProductoEntry, b: ProductoEntry) => (a.data.order || 0) - (b.data.order || 0)
);

// Filtrar por categor√≠a
const paneles = productosOrdenados.filter((p: ProductoEntry) => p.data.category === 'paneles');
const inversores = productosOrdenados.filter((p: ProductoEntry) => p.data.category === 'inversores');
const baterias = productosOrdenados.filter((p: ProductoEntry) => p.data.category === 'baterias');
const reflectores = productosOrdenados.filter((p: ProductoEntry) => p.data.category === 'reflectores');
const controladores = productosOrdenados.filter((p: ProductoEntry) => p.data.category === 'controladores');
const protecciones = productosOrdenados.filter((p: ProductoEntry) => p.data.category === 'protecciones');
const cargadores = productosOrdenados.filter((p: ProductoEntry) => p.data.category === 'cargadores');

const totalProductos = productosOrdenados.length;
const productosDisponibles = productosOrdenados.filter((p: ProductoEntry) => p.data.stock !== 'agotado').length;
const totalMarcas = new Set(productosOrdenados.map((p: ProductoEntry) => p.data.brand).filter(Boolean)).size;

const categoryConfig = [
  { id: 'paneles', icon: 'fas fa-solar-panel', title: 'Paneles Solares', productos: paneles },
  { id: 'inversores', icon: 'fas fa-bolt', title: 'Inversores', productos: inversores },
  { id: 'baterias', icon: 'fas fa-battery-full', title: 'Bater√≠as de Litio', productos: baterias },
  { id: 'reflectores', icon: 'fas fa-lightbulb', title: 'Reflectores Solares', productos: reflectores },
  { id: 'controladores', icon: 'fas fa-microchip', title: 'Controladores de Carga', productos: controladores },
  { id: 'protecciones', icon: 'fas fa-shield-alt', title: 'Protecciones El√©ctricas', productos: protecciones },
  { id: 'cargadores', icon: 'fas fa-car-battery', title: 'Cargadores para Carro', productos: cargadores }
];

// Convertir productos a JSON para JavaScript
const productosJSON = JSON.stringify(productosOrdenados.map((p: ProductoEntry) => {
  const rawPrice = parseInt(p.data.price.replace(/[^0-9]/g, '')) || 0;
  const discountedPrice = rawPrice * 0.85; // 15% discount
  const formattedPrice = new Intl.NumberFormat('es-CO', {
    style: 'currency',
    currency: 'COP',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(discountedPrice);

  return {
    id: p.slug,
    title: p.data.title,
    description: p.data.description,
    price: formattedPrice,
    image: p.data.image,
    brand: p.data.brand || '',
    model: p.data.model || '',
    stock: p.data.stock || 'disponible'
  };
}));
---

<section id="tienda" class="tienda-section">
  <div class="container">
    <div class="tienda-header">
      <h1 class="tienda-title">Tienda de Equipos Solares</h1>
      <p class="tienda-subtitle">Encuentra los mejores equipos solares para tu proyecto</p>
    </div>
  </div>

  <div class="container hero-container">
    <div class="tienda-hero-grid">
      <div class="hero-card hero-highlight">
        <p class="hero-eyebrow">Experiencia intuitiva para tus equipos solares</p>
        <h2 class="hero-title">Todo tu sistema solar en un solo lugar</h2>
        <p class="hero-text">
          Recorre categor√≠as sin perder de vista el carrito, filtra por marca o modelo y arma tu pedido en minutos.
        </p>
        <div class="hero-stats">
          <div class="hero-stat">
            <span class="hero-stat-number">{totalProductos}</span>
            <span class="hero-stat-label">Productos activos</span>
          </div>
          <div class="hero-stat">
            <span class="hero-stat-number">{productosDisponibles}</span>
            <span class="hero-stat-label">En stock inmediato</span>
          </div>
          <div class="hero-stat">
            <span class="hero-stat-number">{totalMarcas}</span>
            <span class="hero-stat-label">Marcas aliadas</span>
          </div>
        </div>
        <div class="hero-cta-group">
          <button class="hero-cta primary" type="button" data-scroll-target="paneles">
            <i class="fas fa-solar-panel"></i>
            Paneles en tendencia
          </button>
          <button class="hero-cta ghost" type="button" data-scroll-target="inversores">
            <i class="fas fa-bolt"></i>
            Ver inversores h√≠bridos
          </button>
        </div>
      </div>

      <div class="hero-card hero-search-card">
        <div class="hero-search-header">
          <p class="hero-eyebrow small">B√∫squeda inteligente</p>
          <h3>Filtra por marca, categor√≠a o estado</h3>
        </div>
        <label for="product-search" class="search-label">¬øQu√© necesitas hoy?</label>
        <div class="hero-search-input">
          <i class="fas fa-search"></i>
          <input
            type="search"
            id="product-search"
            placeholder="Ej: Growatt 5kW, bater√≠a 10kWh, controlador 60A"
            autocomplete="off"
          >
          <button type="button" id="product-search-clear" class="clear-search" aria-label="Limpiar b√∫squeda">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <p class="search-feedback" id="search-feedback">Mostrando {totalProductos} productos</p>
        <div class="hero-filters">
          <button class="hero-filter-btn active" type="button" data-filter-type="all">
            Todo
          </button>
          <button class="hero-filter-btn" type="button" data-filter-type="stock" data-filter-value="disponible">
            Disponibles
          </button>
          <button class="hero-filter-btn" type="button" data-filter-type="category" data-filter-value="inversores">
            Solo inversores
          </button>
          <button class="hero-filter-btn" type="button" data-filter-type="category" data-filter-value="baterias">
            Bater√≠as
          </button>
          <button class="hero-filter-btn" type="button" data-filter-type="new" data-filter-value="true">
            Novedades
          </button>
        </div>
        <div class="hero-quick-links">
          {categoryConfig.map((cat) => (
            <button class="hero-chip" type="button" data-scroll-target={cat.id}>
              <i class={cat.icon}></i>
              {cat.title}
            </button>
          ))}
        </div>
        <div class="hero-tip">
          <i class="fas fa-magic"></i>
          <p>El resultado se actualiza al instante sin salir de la vista actual.</p>
        </div>
      </div>
    </div>
  </div>
  
  <div class="container">
    <div class="tienda-layout">
      <!-- Men√∫ lateral de categor√≠as -->
      <aside class="categories-sidebar">
        <div class="sidebar-content">
          <h3 class="sidebar-title">
            <i class="fas fa-list"></i>
            Categor√≠as
          </h3>
          <nav class="categories-menu">
            {categoryConfig.map((cat) => (
              <a href={`#${cat.id}`} class="category-link" data-category={cat.id}>
                <i class={cat.icon}></i>
                <span>{cat.title}</span>
                <span class="category-count">({cat.productos.length})</span>
              </a>
            ))}
          </nav>
        </div>
      </aside>

      <!-- Contenido principal -->
      <div class="tienda-content">
            {categoryConfig.map((categoria) => (
          <div id={categoria.id} class="categoria-section">
            <div class="categoria-header">
              <h2 class="categoria-title">
                <i class={categoria.icon}></i>
                {categoria.title}
              </h2>
              <div class="carousel-controls">
                <button class="carousel-btn prev-btn" data-category={categoria.id} aria-label="Anterior">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <button class="carousel-btn next-btn" data-category={categoria.id} aria-label="Siguiente">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
            </div>

            {categoria.productos.length > 0 ? (
              <div class="categoria-products">
                <div class="productos-carousel-wrapper">
                  <div class="productos-carousel" data-category={categoria.id}>
                    <div class="productos-track" data-category={categoria.id}>
                {categoria.productos.map((producto: ProductoEntry) => (
                        <ProductCard producto={producto} />
                      ))}
                    </div>
                  </div>
                </div>
                <div class="categoria-empty" aria-live="polite">
                  <i class="fas fa-search"></i>
                  <p>No hay productos que coincidan con tu b√∫squeda en esta categor√≠a.</p>
                </div>
              </div>
            ) : (
              <div class="categoria-empty visible categoria-empty-static">
                <i class="fas fa-box-open"></i>
                <p>Muy pronto tendremos {categoria.title} disponibles.</p>
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  </div>

  <!-- CTA Section -->
  <div class="cta-section">
    <div class="container">
      <div class="cta-content">
        <p class="cta-description">Cont√°ctanos y recibe asesor√≠a personalizada para tu instalaci√≥n de energ√≠a solar</p>
        <div class="cta-buttons">
          <a href="/contacto" class="cta-btn-primary">
            <i class="fas fa-envelope"></i>
            Cont√°ctanos
          </a>
          <a href="https://wa.me/573022357757" target="_blank" class="cta-btn-secondary">
            <i class="fab fa-whatsapp"></i>
            WhatsApp
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Carrito de Compras Sidebar -->
  <div id="cart-sidebar" class="cart-sidebar">
    <div class="cart-header">
      <h2 class="cart-title">
        <i class="fas fa-shopping-basket"></i>
        Tu Canasta
      </h2>
      <button class="cart-close" id="cart-close">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="cart-content">
      <!-- Lista de productos -->
      <div id="cart-items" class="cart-items-list">
        <div class="cart-empty">
          <i class="fas fa-shopping-basket"></i>
          <p>Tu canasta est√° vac√≠a</p>
          <button class="btn-start-shopping" onclick="closeCartSidebar()">Empezar a comprar</button>
        </div>
      </div>

      <!-- Resumen del Pedido -->
      <div class="order-summary" id="order-summary" style="display: none;">
        <div class="summary-row">
          <span>Subtotal</span>
          <span id="cart-subtotal-gravado">$0</span>
        </div>
        <div class="summary-row total-row">
          <span>Total</span>
          <span id="cart-total" class="cart-total">$0</span>
        </div>
      </div>
      
      <!-- Forma de Pago -->
      <div class="payment-section" id="payment-section" style="display: none;">
        <h3 class="section-title">M√©todo de pago</h3>
        <div class="payment-options">
          <label class="payment-option">
            <input type="radio" name="payment" value="transferencia" checked>
            <span>Transferencia / Nequi / Daviplata</span>
          </label>
          <label class="payment-option">
            <input type="radio" name="payment" value="tarjeta">
            <span>Tarjeta de cr√©dito</span>
          </label>
          <label class="payment-option">
            <input type="radio" name="payment" value="efectivo">
            <span>Efectivo</span>
          </label>
        </div>
      </div>
    </div>

    <div class="cart-footer">
      <div class="cart-trust-badges">
        <div class="trust-badge">
          <i class="fas fa-shield-alt"></i>
          <span>Compra Segura</span>
        </div>
        <div class="trust-badge">
          <i class="fas fa-check-circle"></i>
          <span>Garant√≠a Oficial</span>
        </div>
      </div>
      <button class="cart-checkout-btn" id="checkout-btn" disabled>
        <span>Ir a pagar</span>
        <span id="checkout-total-btn">$0</span>
      </button>
    </div>
  </div>

  <div id="cart-overlay" class="cart-overlay"></div>

  <!-- Barra inferior flotante estilo Rappi -->
  <div class="mini-cart-dock" id="mini-cart-dock">
    <div class="dock-content">
      <div class="dock-info">
        <div class="dock-count-badge" id="dock-count">0</div>
        <div class="dock-total">
          <span class="dock-label">Total</span>
          <strong id="dock-total-price">$0</strong>
        </div>
      </div>
      <button class="dock-view-btn" id="dock-view-btn">
        Ver Canasta
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>

</section>

<style>
  .tienda-section {
    padding: 4rem 0;
    background: linear-gradient(135deg, #6b2181 0%, #8b2a9b 50%, #6b2181 100%);
    min-height: 100vh;
    background-attachment: fixed;
  }

  .container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  /* Layout con sidebar */
  .tienda-layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 3rem;
    align-items: start;
  }

  /* Sidebar de categor√≠as */
  .categories-sidebar {
    position: sticky;
    top: 2rem;
    height: fit-content;
  }

  .sidebar-content {
    background: rgba(255, 255, 255, 0.6);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(10px);
  }

  .sidebar-title {
    font-size: 1.3rem;
    font-weight: 700;
    color: #6b2181;
    margin: 0 0 1.5rem 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e5e7eb;
  }

  .sidebar-title i {
    font-size: 1.2rem;
  }

  .categories-menu {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .category-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    border-radius: 10px;
    text-decoration: none;
    color: #4b5563;
    font-weight: 500;
    transition: all 0.2s ease;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    border: 2px solid transparent;
  }

  .category-link:hover {
    background: #f9fafb;
    color: #6b2181;
    border-color: #e5e7eb;
  }

  .category-link.active {
    background: linear-gradient(135deg, #6b2181, #8b2a9b);
    color: white;
    border-color: #6b2181;
    box-shadow: 0 4px 12px rgba(107, 33, 129, 0.3);
  }

  .category-link.category-link-muted {
    opacity: 0.5;
  }

  .category-link i {
    font-size: 1.1rem;
    width: 20px;
    text-align: center;
  }

  .category-link span:first-of-type {
    flex: 1;
  }

  .category-count {
    font-size: 0.85rem;
    opacity: 0.8;
    font-weight: 600;
  }

  .category-link.active .category-count {
    opacity: 1;
  }

  /* Contenido principal */
  .tienda-content {
    min-width: 0;
  }

  .tienda-header {
    text-align: center;
    margin-bottom: 3rem;
    width: 100%;
  }

  .tienda-title {
    font-size: 3rem;
    font-weight: 700;
    color: white;
    margin-bottom: 1rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    text-align: center;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
  }

  .tienda-subtitle {
    font-size: 1.3rem;
    color: rgba(255, 255, 255, 0.9);
    text-align: center;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    text-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
  }

  .hero-container {
    margin-bottom: 2rem;
  }

  .tienda-hero-grid {
    display: grid;
    grid-template-columns: 1.1fr 0.9fr;
    gap: 2rem;
    align-items: stretch;
  }

  .hero-card {
    background: rgba(255, 255, 255, 0.85);
    border-radius: 24px;
    padding: 2.5rem;
    box-shadow: 0 15px 45px rgba(107, 33, 129, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(16px);
  }

  .hero-card.hero-highlight {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.75));
  }

  .hero-eyebrow {
    text-transform: uppercase;
    font-size: 0.85rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    color: #8b2a9b;
    margin-bottom: 0.75rem;
  }

  .hero-eyebrow.small {
    font-size: 0.75rem;
    color: #6b2181;
  }

  .hero-title {
    font-size: 2.5rem;
    margin: 0 0 1rem 0;
    color: #1f2937;
    line-height: 1.2;
  }

  .hero-text {
    color: #4b5563;
    font-size: 1rem;
    margin-bottom: 1.5rem;
    line-height: 1.6;
  }

  .hero-stats {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .hero-stat {
    background: rgba(107, 33, 129, 0.08);
    border-radius: 16px;
    padding: 1rem 1.25rem;
    min-width: 140px;
  }

  .hero-stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: #6b2181;
    display: block;
    line-height: 1.1;
  }

  .hero-stat-label {
    font-size: 0.9rem;
    color: #4b5563;
  }

  .hero-cta-group {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .hero-cta {
    border: none;
    border-radius: 50px;
    padding: 0.9rem 1.6rem;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    transition: all 0.3s ease;
  }

  .hero-cta.primary {
    background: linear-gradient(135deg, #6b2181, #8b2a9b);
    color: white;
    box-shadow: 0 10px 25px rgba(107, 33, 129, 0.3);
  }

  .hero-cta.ghost {
    background: rgba(107, 33, 129, 0.08);
    color: #6b2181;
  }

  .hero-cta:hover {
    transform: translateY(-2px);
  }

  .hero-search-card h3 {
    margin: 0 0 1rem 0;
    font-size: 1.5rem;
    color: #1f2937;
  }

  .hero-search-input {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 50px;
    padding: 0.5rem 1.25rem;
    margin-bottom: 0.75rem;
  }

  .hero-search-input i {
    color: #6b7280;
  }

  .hero-search-input input {
    border: none;
    flex: 1;
    font-size: 1rem;
    background: transparent;
    outline: none;
  }

  .clear-search {
    border: none;
    background: rgba(107, 33, 129, 0.1);
    color: #6b2181;
    border-radius: 999px;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  .hero-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .hero-filter-btn {
    padding: 0.5rem 1.25rem;
    border-radius: 999px;
    border: 1px solid #e5e7eb;
    background: white;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    color: #4b5563;
    transition: all 0.2s ease;
  }

  .hero-filter-btn.active {
    background: linear-gradient(135deg, #6b2181, #8b2a9b);
    color: white;
    border-color: transparent;
    box-shadow: 0 10px 25px rgba(107, 33, 129, 0.2);
  }

  .hero-quick-links {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .hero-chip {
    border: 1px solid rgba(107, 33, 129, 0.2);
    background: rgba(107, 33, 129, 0.05);
    color: #6b2181;
    border-radius: 999px;
    padding: 0.4rem 1rem;
    font-size: 0.85rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .hero-chip:hover {
    background: rgba(107, 33, 129, 0.12);
  }

  .hero-tip {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.85rem 1rem;
    border-radius: 16px;
    background: rgba(16, 185, 129, 0.12);
    color: #047857;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .search-feedback {
    font-size: 0.9rem;
    color: #6b7280;
    margin-bottom: 1rem;
  }

  .categoria-section {
    margin-bottom: 5rem;
    background: rgba(255, 255, 255, 0.6);
    border-radius: 24px;
    padding: 2.5rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
  }

  .categoria-empty {
    margin-top: 1.5rem;
    padding: 1.5rem;
    border-radius: 16px;
    border: 2px dashed rgba(107, 33, 129, 0.25);
    display: none;
    align-items: center;
    gap: 0.75rem;
    color: #6b7280;
    background: rgba(255, 255, 255, 0.6);
  }

  .categoria-empty.visible {
    display: flex;
  }

  .categoria-empty i {
    font-size: 1.5rem;
    color: #6b2181;
  }

  .categoria-empty.categoria-empty-static {
    justify-content: center;
    flex-direction: column;
    text-align: center;
  }

  .categoria-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    gap: 2rem;
  }

  .categoria-title {
    font-size: 2.2rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 1rem;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .carousel-controls {
    display: flex;
    gap: 0.5rem;
  }

  .carousel-btn {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    border: 2px solid #e5e7eb;
    background: white;
    color: #6b2181;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    transition: all 0.3s ease;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .carousel-btn:hover {
    background: #6b2181;
    color: white;
    border-color: #6b2181;
    transform: scale(1.1);
  }

  .carousel-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    transform: none;
  }

  .categoria-title i {
    color: #6b2181;
    font-size: 2rem;
  }

  /* Carrusel de productos */
  .productos-carousel-wrapper {
    position: relative;
    overflow: hidden;
    margin: 0 -1rem;
    padding: 0 1rem;
    /* Ancho para mostrar 7 tarjetas: 240px * 7 + 2rem * 6 = ~1800px */
    max-width: 1800px;
    margin-left: auto;
    margin-right: auto;
  }

  .productos-carousel {
    position: relative;
    overflow: hidden;
    padding-bottom: 1rem;
    width: 100%;
    cursor: grab;
  }

  .productos-carousel::-webkit-scrollbar {
    display: none; /* Chrome/Safari */
  }

  .productos-track {
    display: flex;
    gap: 2rem;
    padding: 0.5rem 0;
    width: max-content;
    animation: carousel-auto-scroll 40s linear infinite;
  }

  .productos-carousel.paused .productos-track {
    animation-play-state: paused;
  }

  @keyframes carousel-auto-scroll {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-50%);
    }
  }

  /* CTA Section */
  .cta-section {
    padding: 3rem 0;
    background: linear-gradient(135deg, rgba(107, 33, 129, 0.9), rgba(139, 42, 155, 0.9));
    margin-top: 5rem;
    position: relative;
    overflow: hidden;
  }

  .cta-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>');
    opacity: 0.3;
  }

  .cta-content {
    text-align: center;
    position: relative;
    z-index: 1;
  }

  .cta-description {
    font-size: 1.2rem;
    color: rgba(255, 255, 255, 0.95);
    margin-bottom: 2rem;
    max-width: 700px;
    margin-left: auto;
    margin-right: auto;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    line-height: 1.6;
  }

  .cta-buttons {
    display: flex;
    gap: 1.5rem;
    justify-content: center;
    flex-wrap: wrap;
  }

  .cta-btn-primary,
  .cta-btn-secondary {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1.25rem 2.5rem;
    border-radius: 50px;
    font-size: 1.2rem;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .cta-btn-primary {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #1f2937;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
  }

  .cta-btn-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s ease;
  }

  .cta-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6);
    background: linear-gradient(135deg, #FFA500, #FFD700);
  }

  .cta-btn-primary:hover::before {
    left: 100%;
  }

  .cta-btn-secondary {
    background: linear-gradient(135deg, #25D366, #128C7E);
    color: white;
    border: 2px solid transparent;
  }

  .cta-btn-secondary:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 30px rgba(37, 211, 102, 0.4);
    background: linear-gradient(135deg, #128C7E, #25D366);
  }

  .cta-btn-primary i,
  .cta-btn-secondary i {
    font-size: 1.3rem;
  }

  /* Cart Sidebar Redesign */
  .cart-sidebar {
    position: fixed;
    top: 0;
    right: -100%;
    width: 400px;
    height: 100vh;
    background: #f3f4f6;
    box-shadow: -5px 0 30px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .cart-sidebar.open {
    right: 0;
  }

  .cart-header {
    background: white;
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e5e7eb;
  }

  .cart-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .cart-title i {
    color: #6b2181;
  }

  .cart-close {
    background: none;
    border: none;
    color: #9ca3af;
    cursor: pointer;
    font-size: 1.25rem;
    padding: 0.5rem;
    transition: color 0.2s;
  }

  .cart-close:hover {
    color: #1f2937;
  }

  .cart-content {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  /* Global overrides for dynamic cart items to ensure image sizing */
  :global(.cart-item-image) {
    width: 100% !important;
    height: 100% !important;
    object-fit: contain;
    transition: transform 0.5s ease;
  }

  /* Cart Item List Style - REPLICATING PRODUCT CARD STYLE */
  .cart-item-card {
    background: white;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    border: 2px solid transparent;
    margin-bottom: 1.25rem;
    width: 100%;
    max-width: 260px;
    align-self: center;
  }

  .cart-item-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(107, 33, 129, 0.4), 0 0 0 1px rgba(107, 33, 129, 0.1);
    border-color: transparent;
  }

  .cart-image-container {
    position: relative;
    width: 250px;
    height: 250px;
    max-width: 250px;
    max-height: 250px;
    padding: 0.75rem;
    background: #f8fafc;
    border-bottom: 1px solid #eef2ff;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    border-radius: 0 0 16px 16px;
  }

  .cart-item-content {
    padding: 1.05rem;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .cart-item-header {
    display: flex;
    flex-direction: column; /* Vertical layout inside header */
    gap: 0.25rem;
    margin-bottom: 0.5rem;
    padding: 0;
    background: transparent;
    border: none;
    align-items: flex-start;
  }

  .cart-item-brand {
    font-size: 0.75rem;
    text-transform: uppercase;
    color: #6b7280;
    font-weight: 700;
    letter-spacing: 0.05em;
  }

  .cart-item-title {
    font-size: 1.05rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    line-height: 1.3;
  }

  .cart-item-footer {
    display: flex;
    flex-direction: column;
    gap: 0.55rem;
    margin-top: auto;
    padding-top: 0.55rem;
    border-top: 1px solid #e5e7eb;
  }

  .cart-price-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
  }

  .cart-item-price {
    font-size: 1.2rem;
    font-weight: 700;
    color: #6b2181;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  }

  .cart-item-controls {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    padding: 0;
    background: transparent;
    justify-content: space-between; /* Spread controls */
  }

  .cart-qty-group {
    display: flex;
    align-items: center;
    border: 2px solid #e5e7eb;
    border-radius: 50px;
    overflow: hidden;
    padding: 0;
    background: transparent;
  }

  .cart-qty-btn {
    background: #f3f4f6;
    border: none;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 1.1rem;
    color: #6b2181;
    transition: all 0.2s ease;
    box-shadow: none;
    border-radius: 0;
  }

  .cart-qty-btn:hover {
    background: #6b2181;
    color: white;
  }

  .cart-qty-display {
    width: 40px;
    height: 32px;
    border: none;
    text-align: center;
    font-size: 0.9rem;
    font-weight: 600;
    color: #1f2937;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .cart-remove-btn {
    color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
    border: none;
    font-size: 0.85rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-weight: 600;
    padding: 0.5rem 1rem;
    border-radius: 50px;
    transition: all 0.2s;
  }

  .cart-remove-btn:hover {
    background: #ef4444;
    color: white;
  }

  .cart-item-details {
    flex: 1;
    min-width: 0;
  }

  .cart-item-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .cart-item-price {
    font-size: 0.9rem;
    color: #6b2181;
    font-weight: 700;
  }

  .cart-item-controls {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.5rem;
  }

  .cart-qty-group {
    display: flex;
    align-items: center;
    background: #f3f4f6;
    border-radius: 8px;
    padding: 2px;
  }

  .cart-qty-btn {
    width: 24px;
    height: 24px;
    border: none;
    background: white;
    border-radius: 6px;
    color: #6b2181;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }

  .cart-qty-display {
    width: 24px;
    text-align: center;
    font-size: 0.9rem;
    font-weight: 600;
    color: #1f2937;
  }

  .cart-remove-btn {
    color: #ef4444;
    background: none;
    border: none;
    font-size: 0.85rem;
    cursor: pointer;
    text-decoration: underline;
    opacity: 0.7;
  }

  .cart-remove-btn:hover {
    opacity: 1;
  }

  .cart-empty {
    text-align: center;
    padding: 4rem 1rem;
    color: #9ca3af;
  }

  .cart-empty i {
    font-size: 4rem;
    margin-bottom: 1rem;
    color: #e5e7eb;
  }

  .btn-start-shopping {
    margin-top: 1rem;
    background: #6b2181;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 50px;
    font-weight: 600;
    cursor: pointer;
  }

  .payment-section {
    background: white;
    padding: 1rem;
    border-radius: 12px;
  }

  .section-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: #374151;
  }

  .payment-options {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .payment-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    cursor: pointer;
  }

  .payment-option:has(input:checked) {
    border-color: #6b2181;
    background: #fdf4ff;
  }

  .cart-footer {
    background: white;
    padding: 1.5rem;
    border-top: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .cart-trust-badges {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .trust-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #059669;
    font-size: 0.85rem;
    font-weight: 600;
  }

  .trust-badge i {
    font-size: 1rem;
  }

  .cart-checkout-btn {
    width: 100%;
    background: #10b981;
    color: white;
    border: none;
    padding: 1rem;
    border-radius: 16px;
    font-size: 1.1rem;
    font-weight: 700;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: transform 0.2s;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }

  .cart-checkout-btn:hover {
    transform: translateY(-2px);
    background: #059669;
  }

  .cart-checkout-btn:disabled {
    background: #d1d5db;
    transform: none;
    box-shadow: none;
    cursor: not-allowed;
  }

  /* Overlay */
  .cart-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 999;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    backdrop-filter: blur(2px);
  }

  .cart-overlay.visible {
    opacity: 1;
    pointer-events: auto;
  }

  /* Mini Cart Dock (Rappi Style) */
  .mini-cart-dock {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    width: 90%;
    max-width: 500px;
    background: #10b981;
    border-radius: 16px;
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    box-shadow: 0 8px 30px rgba(16, 185, 129, 0.4);
    z-index: 990;
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    cursor: pointer;
  }

  .mini-cart-dock.active {
    transform: translateX(-50%) translateY(0);
  }

  .dock-content {
    display: flex;
    justify-content: space-between;
    width: 100%;
    align-items: center;
    color: white;
  }

  .dock-info {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .dock-count-badge {
    background: white;
    color: #10b981;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 0.9rem;
  }

  .dock-total {
    display: flex;
    flex-direction: column;
    line-height: 1.1;
  }

  .dock-label {
    font-size: 0.75rem;
    opacity: 0.9;
  }

  .dock-total strong {
    font-size: 1.1rem;
  }

  .dock-view-btn {
    background: none;
    border: none;
    color: white;
    font-weight: 700;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
  }

  body.cart-locked {
    overflow: hidden;
  }

  @media (max-width: 768px) {
    .cart-sidebar {
      width: 100%;
    }
    
    .mini-cart-dock {
      bottom: 1rem;
      width: 95%;
    }
  }
</style>

<script define:vars={{ productosJSON }}>
  const WHATSAPP_NUMBER = '573022357757';
  let cart = [];
  const productos = JSON.parse(productosJSON);
  const CART_STORAGE_KEY = 'reiki_cart';
  const totalProducts = productos.length;

  // Elementos DOM
  let searchInputEl, searchFeedbackEl;
  let heroFilterState = { type: 'all', value: null };
  let cartSidebarEl, cartOverlayEl;
  let miniCartDock;

  function loadCartFromStorage() {
    const savedCart = localStorage.getItem(CART_STORAGE_KEY);
    if (savedCart) {
      try {
        cart = JSON.parse(savedCart);
      } catch (e) {
        cart = [];
      }
    }
  }

  function saveCartToStorage() {
    localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
    window.dispatchEvent(new CustomEvent('cartUpdated', { detail: { totalItems: getCartTotalItems() } }));
  }

  function getCartTotalItems() {
    return cart.reduce((sum, item) => sum + (item.quantity || 0), 0);
  }

  function extractPrice(priceString) {
    const cleaned = priceString.replace(/[^0-9]/g, '');
    return parseInt(cleaned) || 0;
  }

  function formatPrice(price) {
    return new Intl.NumberFormat('es-CO', {
      style: 'currency',
      currency: 'COP',
      minimumFractionDigits: 0
    }).format(price);
  }

  // Actualizar UI del Dock
  function updateMiniCartDock() {
    if (!miniCartDock) return;
    
    const totalItems = getCartTotalItems();
    const total = cart.reduce((sum, item) => sum + (extractPrice(item.price) * item.quantity), 0);

    if (totalItems > 0) {
      miniCartDock.classList.add('active');
      document.getElementById('dock-count').textContent = totalItems;
      document.getElementById('dock-total-price').textContent = formatPrice(total);
    } else {
      miniCartDock.classList.remove('active');
    }
  }

  // Actualizar contenido del Sidebar
  function updateCartSidebar() {
    const cartItemsList = document.getElementById('cart-items');
    const orderSummary = document.getElementById('order-summary');
    const paymentSection = document.getElementById('payment-section');
    const checkoutBtn = document.getElementById('checkout-btn');
    const totalBtn = document.getElementById('checkout-total-btn');

    if (cart.length === 0) {
      cartItemsList.innerHTML = `
        <div class="cart-empty">
          <i class="fas fa-shopping-basket"></i>
          <p>Tu canasta est√° vac√≠a</p>
          <button class="btn-start-shopping" onclick="closeCartSidebar()">Empezar a comprar</button>
        </div>
      `;
      orderSummary.style.display = 'none';
      paymentSection.style.display = 'none';
      checkoutBtn.disabled = true;
      totalBtn.textContent = '$0';
      return;
    }

    orderSummary.style.display = 'block';
    paymentSection.style.display = 'block';
    checkoutBtn.disabled = false;

    cartItemsList.innerHTML = cart.map((item, index) => {
      const itemTotal = extractPrice(item.price) * item.quantity;
      return `
        <div class="cart-item-card">
          <div class="cart-image-container">
            <img src="${item.image}" alt="${item.title}" class="cart-item-image">
          </div>
          <div class="cart-item-content">
            <div class="cart-item-header">
              ${item.brand ? `<div class="cart-item-brand">${item.brand}</div>` : ''}
              <h3 class="cart-item-title">${item.title}</h3>
            </div>
            <div class="cart-item-footer">
              <div class="cart-price-row">
                <div class="cart-item-price">${formatPrice(itemTotal)}</div>
              </div>
              <div class="cart-item-controls">
                <div class="cart-qty-group">
                  <button class="cart-qty-btn" onclick="updateCartQuantity(${index}, -1)">-</button>
                  <div class="cart-qty-display">${item.quantity}</div>
                  <button class="cart-qty-btn" onclick="updateCartQuantity(${index}, 1)">+</button>
                </div>
                <button class="cart-remove-btn" onclick="removeFromCart(${index})">
                  <i class="fas fa-trash-alt"></i> Eliminar
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');

    const total = cart.reduce((sum, item) => sum + (extractPrice(item.price) * item.quantity), 0);
    const subtotalGravado = total / 1.19; 
    
    document.getElementById('cart-subtotal-gravado').textContent = formatPrice(total);
    document.getElementById('cart-total').textContent = formatPrice(total);
    totalBtn.textContent = formatPrice(total);
  }

  // Funciones globales para botones onclick
  window.updateCartQuantity = function(index, change) {
    cart[index].quantity += change;
    if (cart[index].quantity <= 0) {
      cart.splice(index, 1);
    }
    saveCartToStorage();
    updateCartSidebar();
    updateMiniCartDock();
    updateCardButtons();
  };

  window.removeFromCart = function(index) {
    cart.splice(index, 1);
    saveCartToStorage();
    updateCartSidebar();
    updateMiniCartDock();
    updateCardButtons();
  };

  window.closeCartSidebar = function() {
    cartSidebarEl?.classList.remove('open');
    cartOverlayEl?.classList.remove('visible');
    document.body.classList.remove('cart-locked');
  };

  function openCartSidebar() {
    cartSidebarEl?.classList.add('open');
    cartOverlayEl?.classList.add('visible');
    document.body.classList.add('cart-locked');
    updateCartSidebar(); // Refrescar al abrir
  }

  // --- Experiencia de b√∫squeda y filtros ---
  let searchDebounce;

  function getProductCards() {
    return Array.from(document.querySelectorAll('.producto-card'));
  }

  function updateSearchFeedback(visibleCount, searchTerm) {
    if (!searchFeedbackEl) return;

    if (!visibleCount) {
      searchFeedbackEl.textContent = searchTerm
        ? `Sin resultados para "${searchTerm}"`
        : 'Sin productos que cumplan los filtros';
      return;
    }

    if (searchTerm) {
      searchFeedbackEl.textContent = `Encontramos ${visibleCount} resultado${visibleCount === 1 ? '' : 's'} para "${searchTerm}"`;
    } else if (heroFilterState.type !== 'all') {
      searchFeedbackEl.textContent = `${visibleCount} producto${visibleCount === 1 ? '' : 's'} seg√∫n los filtros`;
    } else {
      searchFeedbackEl.textContent = `Mostrando ${visibleCount} de ${totalProducts} productos`;
    }
  }

  function updateCategoryEmptyStates() {
    document.querySelectorAll('.categoria-section').forEach((section) => {
      const cards = section.querySelectorAll('.producto-card');
      const hasVisible = Array.from(cards).some(card => !card.classList.contains('hidden'));
      const emptyState = section.querySelector('.categoria-empty');
      if (emptyState) {
        emptyState.classList.toggle('visible', !hasVisible);
      }
      section.classList.toggle('categoria-section-empty', !hasVisible);
    });
  }

  function updateCategoryCounts() {
    document.querySelectorAll('.category-link').forEach((link) => {
      const categoryId = link.dataset.category;
      const section = document.getElementById(categoryId);
      if (!section) return;

      const total = section.querySelectorAll('.producto-card').length;
      const visible = section.querySelectorAll('.producto-card:not(.hidden)').length;
      const countEl = link.querySelector('.category-count');
      if (countEl) {
        countEl.textContent = visible === total ? `(${total})` : `(${visible}/${total})`;
      }
      link.classList.toggle('category-link-muted', visible === 0);
    });
  }

  function normalizeText(value = '') {
    return value
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .toLowerCase();
  }

  function applyProductFilters() {
    const cards = getProductCards();
    const searchTerm = normalizeText((searchInputEl?.value || '').trim());

    let visibleCount = 0;
    cards.forEach((card) => {
      const searchText = card.dataset.search || '';
      const matchesSearch = !searchTerm || searchText.includes(searchTerm);

      let matchesFilter = true;
      switch (heroFilterState.type) {
        case 'stock':
          matchesFilter = normalizeText(card.dataset.stock || '') === (heroFilterState.value || '');
          break;
        case 'category':
          matchesFilter = normalizeText(card.dataset.category || '') === (heroFilterState.value || '');
          break;
        case 'brand':
          matchesFilter = normalizeText(card.dataset.brand || '') === (heroFilterState.value || '');
          break;
        case 'model':
          matchesFilter = normalizeText(card.dataset.model || '').includes(heroFilterState.value || '');
          break;
        case 'new':
          matchesFilter = card.dataset.new === 'true';
          break;
        default:
          matchesFilter = true;
      }

      const isVisible = matchesSearch && matchesFilter;
      card.classList.toggle('hidden', !isVisible);
      if (isVisible) visibleCount++;
    });

    updateCategoryEmptyStates();
    updateCategoryCounts();
    updateSearchFeedback(visibleCount, searchTerm);
  }

  function setupSearchAndFilters() {
    searchInputEl = document.getElementById('product-search');
    searchFeedbackEl = document.getElementById('search-feedback');
    const clearBtn = document.getElementById('product-search-clear');
    const filterButtons = document.querySelectorAll('.hero-filter-btn');

    if (searchInputEl) {
      searchInputEl.addEventListener('input', () => {
        clearTimeout(searchDebounce);
        searchDebounce = setTimeout(applyProductFilters, 150);
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        if (!searchInputEl) return;
        searchInputEl.value = '';
        applyProductFilters();
        searchInputEl.focus();
      });
    }

    filterButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        filterButtons.forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');

        heroFilterState = {
          type: btn.dataset.filterType || 'all',
          value: btn.dataset.filterValue ? normalizeText(btn.dataset.filterValue) : null
        };
        applyProductFilters();
      });
    });

    document.querySelectorAll('.hero-chip').forEach((chip) => {
      chip.addEventListener('click', () => {
        const targetId = chip.dataset.scrollTarget;
        const target = document.getElementById(targetId);
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    });

    applyProductFilters();
  }

  function initCarousels() {
    document.querySelectorAll('.productos-carousel').forEach((carousel) => {
      const track = carousel.querySelector('.productos-track');
      const category = carousel.dataset.category;
      const prevBtn = document.querySelector(`.carousel-btn.prev-btn[data-category="${category}"]`);
      const nextBtn = document.querySelector(`.carousel-btn.next-btn[data-category="${category}"]`);

      if (!track || !category) return;

      let animationFrameId = 0;
      let isHovering = false;

      const getStep = () => {
        const card = track.querySelector('.producto-card:not(.hidden)');
        if (!(card instanceof HTMLElement)) return carousel.clientWidth || 300;
        const gap = parseFloat(getComputedStyle(track).gap || '0');
        return card.offsetWidth + gap;
      };

      const updateButtonState = () => {
        const maxScroll = track.scrollWidth - carousel.clientWidth;
        if (prevBtn) prevBtn.disabled = track.scrollLeft <= 0;
        if (nextBtn) nextBtn.disabled = track.scrollLeft >= maxScroll - 1;
      };

      const scrollByStep = (direction) => {
        const step = getStep();
        track.scrollBy({ left: direction === 'left' ? -step : step, behavior: 'smooth' });
      };

      const autoScroll = () => {
        if (!isHovering) {
          track.scrollLeft += 0.5;
          const maxScroll = track.scrollWidth - carousel.clientWidth;
          if (track.scrollLeft >= maxScroll) {
            track.scrollLeft = 0;
          }
        }
        animationFrame = requestAnimationFrame(autoScroll);
      };

      carousel.addEventListener('mouseenter', () => {
        isHovering = true;
        carousel.classList.add('paused');
      });

      carousel.addEventListener('mouseleave', () => {
        isHovering = false;
        carousel.classList.remove('paused');
      });

      prevBtn?.addEventListener('click', () => scrollByStep('left'));
      nextBtn?.addEventListener('click', () => scrollByStep('right'));

      track.addEventListener('scroll', updateButtonState, { passive: true });
      updateButtonState();

      if (animationFrameId) cancelAnimationFrame(animationFrameId);
      animationFrameId = requestAnimationFrame(autoScroll);
    });
  }

  // Actualizar botones de tarjetas
  function updateCardButtons() {
    // Restaurar todos los botones primero
    document.querySelectorAll('.producto-actions').forEach(container => {
      // Por defecto mostrar: qty controls + agregar
      // Pero para "Rappi Style" necesitamos transformar el bot√≥n
      // Para esta iteraci√≥n, mantendremos la l√≥gica visual simple
      // y si el producto est√° en el carrito, actualizamos el input de cantidad
    });
  }

  function addToCart(productId, quantity = 1) {
    const producto = productos.find(p => p.id === productId);
    if (!producto) return;

    const existingItem = cart.find(item => item.id === productId);
    if (existingItem) {
      existingItem.quantity += quantity;
    } else {
      cart.push({
        id: producto.id,
        title: producto.title,
        price: producto.price,
        image: producto.image,
        brand: producto.brand,
        quantity: quantity
      });
    }
    saveCartToStorage();
    updateMiniCartDock();
    // Opcional: Feedback visual en el bot√≥n
  }

  function handleCheckout() {
    if (!cart.length) return;
    const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value || 'transferencia';
    
    let message = 'üõí *PEDIDO DE PRODUCTOS SOLARES*\n\n';
    message += '*Productos:*\n';
    
    cart.forEach((item) => {
      const itemTotal = extractPrice(item.price) * item.quantity;
      message += `‚ñ™ ${item.quantity} x ${item.title} (${formatPrice(itemTotal)})`;
      if (item.brand) message += ` - Marca: ${item.brand}`;
      message += `\n`;
    });

    const total = cart.reduce((sum, item) => sum + (extractPrice(item.price) * item.quantity), 0);
    message += `\n*Total a pagar: ${formatPrice(total)}*\n`;
    message += `*M√©todo de pago:* ${paymentMethod}\n`;
    
    const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
  }

  // Inicializaci√≥n
  document.addEventListener('DOMContentLoaded', () => {
    cartSidebarEl = document.getElementById('cart-sidebar');
    cartOverlayEl = document.getElementById('cart-overlay');
    miniCartDock = document.getElementById('mini-cart-dock');
    searchInputEl = document.getElementById('product-search');
    
    // Cargar datos
    loadCartFromStorage();
    updateMiniCartDock();

    // Event Listeners
    document.getElementById('cart-close')?.addEventListener('click', closeCartSidebar);
    cartOverlayEl?.addEventListener('click', closeCartSidebar);
    miniCartDock?.addEventListener('click', openCartSidebar);
    document.getElementById('checkout-btn')?.addEventListener('click', handleCheckout);

    setupSearchAndFilters();
    initCarousels();

    // Botones de agregar en tarjetas
    document.querySelectorAll('.add-to-cart').forEach(btn => {
      btn.addEventListener('click', function() {
        const productId = this.dataset.productId;
        const container = this.closest('.producto-actions');
        const qtyInput = container.querySelector('.qty-input');
        const quantity = parseInt(qtyInput.value) || 1;
        addToCart(productId, quantity);
        qtyInput.value = 1; // Reset visual
      });
    });

    // Controladores de cantidad en tarjetas (local)
    document.querySelectorAll('.qty-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const input = this.parentElement.querySelector('.qty-input');
        const isPlus = this.classList.contains('plus');
        let val = parseInt(input.value) || 1;
        val = isPlus ? val + 1 : Math.max(1, val - 1);
        input.value = val;
      });
    });

    // Filtros y B√∫squeda (simplificado del c√≥digo anterior)
    // ... Mantener l√≥gica de filtros existente ...
  });
</script>
