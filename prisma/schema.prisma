// Prisma Schema para Plataforma OKR/CRM
// Base de datos: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTH & USER MANAGEMENT
// ============================================
// Nota: SQLite no soporta enums, se usan Strings

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String // Hasheado con bcrypt
  name          String
  avatar        String?
  isActive      Boolean  @default(true)
  emailVerified Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relaciones
  roles             UserRole[]
  okrs              OKR[]         @relation("OKROwner")
  okrUpdates        OKRUpdate[]
  opportunities     Opportunity[] @relation("OpportunityOwner")
  activities        Activity[]
  quotes            Quote[]
  contracts         Contract[]    @relation("ContractCreator")
  adminTasks        AdminTask[]   @relation("AdminTaskAssignee")
  campaigns         Campaign[]    @relation("CampaignOwner")
  noteEntries       Note[]
  reminders         Reminder[]
  auditLogs         AuditLog[]
  feedbacksCreated  Feedback[]    @relation("FeedbackCreator")
  feedbacksReceived Feedback[]    @relation("FeedbackRecipient")

  @@index([email])
  @@map("users")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique // UserRoleEnum como String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users UserRole[]

  @@map("roles")
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

// ============================================
// OKR MODULE
// ============================================
// Nota: SQLite no soporta enums, se usan Strings

model OKR {
  id          String   @id @default(cuid())
  title       String // Objetivo
  description String?
  area        String // AreaEnum como String
  period      String // OKRPeriod como String
  startDate   DateTime
  endDate     DateTime
  ownerId     String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  owner      User        @relation("OKROwner", fields: [ownerId], references: [id])
  keyResults KeyResult[]
  updates    OKRUpdate[]

  @@index([ownerId])
  @@index([area])
  @@index([period])
  @@map("okrs")
}

model KeyResult {
  id           String   @id @default(cuid())
  okrId        String
  title        String
  description  String?
  type         String // KRType como String
  targetValue  Float? // Meta numérica o porcentaje
  currentValue Float?   @default(0)
  unit         String? // Unidad de medida (ej: "clientes", "%", "USD")
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  okr   OKR      @relation(fields: [okrId], references: [id], onDelete: Cascade)
  tasks KRTask[]

  @@index([okrId])
  @@map("key_results")
}

model KRTask {
  id          String    @id @default(cuid())
  krId        String
  title       String // Nombre del documento/tarea
  description String? // Descripción adicional
  status      String    @default("PENDIENTE") // TaskStatus como String: PENDIENTE, EN_PROGRESO, COMPLETADO, BLOQUEADO
  weight      Float     @default(1.0) // Peso para calcular porcentaje (ej: 10% si hay 10 tareas)
  order       Int       @default(0) // Orden de visualización
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  keyResult KeyResult @relation(fields: [krId], references: [id], onDelete: Cascade)

  @@index([krId])
  @@index([status])
  @@map("kr_tasks")
}

model OKRUpdate {
  id           String   @id @default(cuid())
  okrId        String
  krId         String? // Opcional: si es actualización de un KR específico
  userId       String
  currentValue Float?
  notes        String?
  createdAt    DateTime @default(now())

  okr  OKR  @relation(fields: [okrId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@index([okrId])
  @@index([userId])
  @@map("okr_updates")
}

// ============================================
// CRM MODULE
// ============================================
// Nota: SQLite no soporta enums, se usan Strings

model Company {
  id        String   @id @default(cuid())
  name      String
  nit       String?  @unique
  sector    String?
  industry  String?
  address   String?
  city      String?
  country   String?  @default("Colombia")
  phone     String?
  email     String?
  website   String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  contacts      Contact[]
  opportunities Opportunity[]
  activities    Activity[]
  noteEntries   Note[]
  reminders     Reminder[]
  tags          CompanyTag[]

  @@index([name])
  @@index([nit])
  @@map("companies")
}

model Contact {
  id        String   @id @default(cuid())
  companyId String
  firstName String
  lastName  String
  position  String?
  email     String?
  phone     String?
  mobile    String?
  isPrimary Boolean  @default(false)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company       Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  activities    Activity[]
  opportunities Opportunity[] @relation("OpportunityContact")
  noteEntries   Note[]
  reminders     Reminder[]
  tags          ContactTag[]

  @@index([companyId])
  @@index([email])
  @@map("contacts")
}

model Opportunity {
  id                String    @id @default(cuid())
  companyId         String
  contactId         String?
  name              String
  description       String?
  estimatedValue    Float
  probability       Int       @default(0) // 0-100
  stage             String    @default("LEAD") // OpportunityStage como String
  source            String? // LeadSource como String
  campaignId        String? // Relación con campaña de marketing
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?
  ownerId           String
  notes             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relaciones
  company     Company          @relation(fields: [companyId], references: [id])
  contact     Contact?         @relation("OpportunityContact", fields: [contactId], references: [id])
  owner       User             @relation("OpportunityOwner", fields: [ownerId], references: [id])
  campaign    Campaign?        @relation(fields: [campaignId], references: [id])
  activities  Activity[]
  quotes      Quote[]
  contract    Contract?
  noteEntries Note[]
  reminders   Reminder[]
  tags        OpportunityTag[]

  @@index([companyId])
  @@index([ownerId])
  @@index([stage])
  @@index([campaignId])
  @@map("opportunities")
}

model Activity {
  id            String    @id @default(cuid())
  opportunityId String?
  companyId     String?
  contactId     String?
  type          String // ActivityType como String
  title         String
  description   String?
  scheduledDate DateTime?
  completedDate DateTime?
  result        String?
  userId        String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relaciones
  opportunity Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: SetNull)
  company     Company?     @relation(fields: [companyId], references: [id], onDelete: SetNull)
  contact     Contact?     @relation(fields: [contactId], references: [id], onDelete: SetNull)
  user        User         @relation(fields: [userId], references: [id])

  @@index([opportunityId])
  @@index([userId])
  @@index([scheduledDate])
  @@map("activities")
}

// Notas y Comentarios
model Note {
  id            String   @id @default(cuid())
  opportunityId String?
  companyId     String?
  contactId     String?
  userId        String
  content       String
  isPrivate     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  opportunity Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  company     Company?     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contact     Contact?     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id])

  @@index([opportunityId])
  @@index([companyId])
  @@index([userId])
  @@map("notes")
}

// Recordatorios y Tareas
model Reminder {
  id            String    @id @default(cuid())
  opportunityId String?
  companyId     String?
  contactId     String?
  userId        String
  title         String
  description   String?
  dueDate       DateTime
  isCompleted   Boolean   @default(false)
  completedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  opportunity Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  company     Company?     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contact     Contact?     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([dueDate])
  @@index([isCompleted])
  @@map("reminders")
}

// Historial de Cambios (AuditLog)
model AuditLog {
  id         String   @id @default(cuid())
  entityType String // "OPPORTUNITY", "COMPANY", "CONTACT", etc.
  entityId   String
  action     String // "CREATE", "UPDATE", "DELETE", "STAGE_CHANGE"
  fieldName  String?
  oldValue   String?
  newValue   String?
  userId     String
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

// Etiquetas/Tags
model Tag {
  id        String   @id @default(cuid())
  name      String   @unique
  color     String? // Color hexadecimal
  createdAt DateTime @default(now())

  opportunities OpportunityTag[]
  companies     CompanyTag[]
  contacts      ContactTag[]

  @@map("tags")
}

model OpportunityTag {
  id            String @id @default(cuid())
  opportunityId String
  tagId         String

  opportunity Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  tag         Tag         @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([opportunityId, tagId])
  @@map("opportunity_tags")
}

model CompanyTag {
  id        String @id @default(cuid())
  companyId String
  tagId     String

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([companyId, tagId])
  @@map("company_tags")
}

model ContactTag {
  id        String @id @default(cuid())
  contactId String
  tagId     String

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([contactId, tagId])
  @@map("contact_tags")
}

// ============================================
// QUOTE MODULE
// ============================================
// Nota: SQLite no soporta enums, se usan Strings

model Quote {
  id            String    @id @default(cuid())
  opportunityId String
  quoteNumber   String    @unique
  status        String    @default("BORRADOR") // QuoteStatus como String
  validUntil    DateTime?
  subtotal      Float
  tax           Float     @default(0)
  discount      Float     @default(0)
  total         Float
  notes         String?
  publicToken   String    @unique // Token para acceso público
  sentAt        DateTime?
  viewedAt      DateTime?
  acceptedAt    DateTime?
  createdById   String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relaciones
  opportunity Opportunity    @relation(fields: [opportunityId], references: [id])
  creator     User           @relation(fields: [createdById], references: [id])
  items       QuoteItem[]
  viewLogs    QuoteViewLog[]

  @@index([opportunityId])
  @@index([quoteNumber])
  @@index([publicToken])
  @@index([status])
  @@map("quotes")
}

model QuoteItem {
  id          String   @id @default(cuid())
  quoteId     String
  description String
  quantity    Float
  unitPrice   Float
  subtotal    Float
  order       Int      @default(0)
  createdAt   DateTime @default(now())

  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@map("quote_items")
}

model QuoteViewLog {
  id        String   @id @default(cuid())
  quoteId   String
  ipAddress String?
  userAgent String?
  viewedAt  DateTime @default(now())

  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
  @@index([viewedAt])
  @@map("quote_view_logs")
}

// ============================================
// CONTRACT MODULE
// ============================================
// Nota: SQLite no soporta enums, se usan Strings

model Contract {
  id             String    @id @default(cuid())
  opportunityId  String    @unique // Una oportunidad genera un contrato
  contractNumber String    @unique
  status         String    @default("BORRADOR") // ContractStatus como String
  finalValue     Float
  paymentMethod  String?
  paymentTerms   String?
  scope          String? // Alcance resumido
  signedDate     DateTime?
  startDate      DateTime?
  endDate        DateTime?
  invoiceNumber  String?
  invoiceDate    DateTime?
  paymentStatus  String    @default("PENDIENTE") // PaymentStatus como String
  notes          String?
  createdById    String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relaciones
  opportunity Opportunity @relation(fields: [opportunityId], references: [id])
  creator     User        @relation("ContractCreator", fields: [createdById], references: [id])
  adminTasks  AdminTask[]

  @@index([opportunityId])
  @@index([contractNumber])
  @@index([status])
  @@map("contracts")
}

model AdminTask {
  id            String    @id @default(cuid())
  contractId    String
  title         String
  description   String?
  dueDate       DateTime?
  completedDate DateTime?
  isCompleted   Boolean   @default(false)
  assignedToId  String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relaciones
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  assignee User     @relation("AdminTaskAssignee", fields: [assignedToId], references: [id])

  @@index([contractId])
  @@index([assignedToId])
  @@index([isCompleted])
  @@map("admin_tasks")
}

// ============================================
// MARKETING MODULE
// ============================================
// Nota: SQLite no soporta enums, se usan Strings

model Campaign {
  id        String    @id @default(cuid())
  name      String
  channel   String // CampaignChannel como String
  startDate DateTime
  endDate   DateTime?
  objective String?
  budget    Float?
  ownerId   String
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relaciones
  owner         User              @relation("CampaignOwner", fields: [ownerId], references: [id])
  opportunities Opportunity[]
  metrics       CampaignMetrics[]

  @@index([ownerId])
  @@index([channel])
  @@index([startDate])
  @@map("campaigns")
}

model CampaignMetrics {
  id                     String   @id @default(cuid())
  campaignId             String
  leadsGenerated         Int      @default(0)
  opportunitiesGenerated Int      @default(0)
  opportunitiesWon       Int      @default(0)
  totalValueWon          Float    @default(0)
  recordedAt             DateTime @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([recordedAt])
  @@map("campaign_metrics")
}

// ============================================
// GOOGLE DRIVE INTEGRATION
// ============================================
// Nota: SQLite no soporta enums, se usan Strings

model GoogleDriveFile {
  id             String   @id @default(cuid())
  fileId         String   @unique // Google Drive File ID
  fileName       String
  fileType       String // FileType como String
  mimeType       String
  fileSize       Int? // En bytes
  webViewLink    String // URL pública de visualización
  webContentLink String? // URL de descarga
  folderPath     String? // Ruta en Drive
  entityType     String // EntityType como String
  entityId       String // ID de la entidad relacionada (Quote, Contract, etc.)
  uploadedAt     DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relaciones opcionales (según entityType)
  // Nota: Las relaciones con quote y contract se manejan por entityId manualmente
  // ya que Prisma no permite relaciones condicionales basadas en entityType

  @@index([fileId])
  @@index([entityType, entityId])
  @@map("google_drive_files")
}

// ============================================
// FEEDBACK MODULE
// ============================================

model Feedback {
  id          String    @id @default(cuid())
  process     String // FeedbackProcess como String (OKR, CRM, COTIZACIONES, etc.)
  area        String? // AreaEnum como String (COMERCIAL, MARKETING, etc.)
  title       String
  content     String
  status      String    @default("PENDIENTE") // FeedbackStatus como String
  createdById String // Usuario que crea el feedback
  recipientId String // Usuario destinatario del feedback
  response    String? // Respuesta del destinatario
  respondedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relaciones
  creator   User @relation("FeedbackCreator", fields: [createdById], references: [id])
  recipient User @relation("FeedbackRecipient", fields: [recipientId], references: [id])

  @@index([createdById])
  @@index([recipientId])
  @@index([status])
  @@index([process])
  @@index([area])
  @@map("feedbacks")
}
